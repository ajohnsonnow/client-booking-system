<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin Dashboard | Ravi Sacred Healing</title>
  <style>
    :root {
      --burgundy: #722F37;
      --burgundy-light: #8B3A44;
      --burgundy-dark: #5C252C;
      --cream: #FDF8F3;
      --warm-white: #FEFCFA;
      --gold: #D4AF37;
      --gold-light: #F0E6C8;
      --charcoal: #3D3630;
      --soft-gray: #9E9890;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #f44336;
      --info: #2196F3;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--cream);
      color: var(--charcoal);
      line-height: 1.6;
    }

    /* ============ LOGIN ============ */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-dark) 100%);
    }

    .login-card {
      background: var(--warm-white);
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-card h1 {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 28px;
      color: var(--burgundy);
      text-align: center;
      margin-bottom: 30px;
    }

    .login-card input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
      transition: border-color 0.3s;
    }

    .login-card input:focus {
      outline: none;
      border-color: var(--burgundy);
    }

    .login-card button {
      width: 100%;
      padding: 14px;
      background: var(--burgundy);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .login-card button:hover {
      background: var(--burgundy-dark);
      transform: translateY(-2px);
    }

    .login-error {
      color: var(--danger);
      text-align: center;
      margin-top: 16px;
      display: none;
    }

    /* ============ DASHBOARD LAYOUT ============ */
    .dashboard { display: none; }
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: linear-gradient(180deg, var(--burgundy) 0%, var(--burgundy-dark) 100%);
      color: white;
      padding: 20px 0;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .sidebar-header h2 {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 24px;
      margin-bottom: 4px;
    }

    .sidebar-header small {
      opacity: 0.7;
      font-size: 12px;
    }

    .nav-menu { list-style: none; }

    .nav-item {
      padding: 14px 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255,255,255,0.1);
      border-left-color: var(--gold);
    }

    .nav-item.active {
      background: rgba(255,255,255,0.15);
    }

    .nav-icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
      pointer-events: none;
    }
    
    .nav-item .badge {
      pointer-events: none;
    }

    .nav-divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 16px 0;
    }

    .main-content {
      margin-left: 260px;
      padding: 24px;
      min-height: 100vh;
    }

    /* ============ PAGES ============ */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ============ HEADER ============ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 32px;
      color: var(--burgundy);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* ============ STATS CARDS ============ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border-left: 4px solid var(--burgundy);
    }

    .stat-card.success { border-left-color: var(--success); }
    .stat-card.warning { border-left-color: var(--warning); }
    .stat-card.info { border-left-color: var(--info); }
    .stat-card.gold { border-left-color: var(--gold); }

    .stat-label {
      font-size: 13px;
      color: var(--soft-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 600;
      color: var(--charcoal);
    }

    .stat-change {
      font-size: 13px;
      margin-top: 8px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    /* ============ BUTTONS ============ */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--burgundy);
      color: white;
    }

    .btn-primary:hover {
      background: var(--burgundy-dark);
    }

    .btn-secondary {
      background: var(--gold-light);
      color: var(--charcoal);
    }

    .btn-secondary:hover {
      background: var(--gold);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--burgundy);
      color: var(--burgundy);
    }

    .btn-outline:hover {
      background: var(--burgundy);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-icon {
      padding: 8px;
      min-width: auto;
    }

    /* ============ CARDS & PANELS ============ */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 24px;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 20px;
      color: var(--burgundy);
    }

    .card-body {
      padding: 24px;
    }

    /* ============ TABLES ============ */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: var(--cream);
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--soft-gray);
    }

    tr:hover {
      background: #faf8f5;
    }

    /* ============ STATUS BADGES ============ */
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-confirmed { background: #d4edda; color: #155724; }
    .badge-completed { background: #cce5ff; color: #004085; }
    .badge-cancelled { background: #f8d7da; color: #721c24; }

    /* ============ FORMS ============ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--charcoal);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--burgundy);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    /* ============ TABS ============ */
    .tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      font-weight: 500;
      color: var(--soft-gray);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--burgundy);
    }

    .tab.active {
      color: var(--burgundy);
      border-bottom-color: var(--burgundy);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ============ MODAL ============ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 24px;
      color: var(--burgundy);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--soft-gray);
      line-height: 1;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* ============ SEARCH ============ */
    .search-box {
      position: relative;
    }

    .search-input {
      padding: 10px 16px 10px 40px;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      font-size: 14px;
      width: 250px;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--burgundy);
      width: 300px;
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--soft-gray);
    }

    /* ============ CALENDAR ============ */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
    }

    .calendar-day-header {
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      color: var(--soft-gray);
      text-transform: uppercase;
    }

    .calendar-day {
      aspect-ratio: 1;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      min-height: 80px;
    }

    .calendar-day:hover {
      border-color: var(--burgundy);
      background: #faf8f5;
    }

    .calendar-day.other-month {
      color: #ccc;
      background: #f9f9f9;
    }

    .calendar-day.today {
      border-color: var(--gold);
      border-width: 2px;
    }

    .calendar-day.blocked {
      background: #f8d7da;
    }

    .calendar-day.has-event {
      background: #d4edda;
    }

    .calendar-event {
      font-size: 10px;
      padding: 2px 4px;
      background: var(--burgundy);
      color: white;
      border-radius: 4px;
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .calendar-event.pending {
      background: #ffc107;
      color: #333;
      border: 1px dashed #ff9800;
    }
    
    .calendar-event.confirmed {
      background: var(--burgundy);
      color: white;
    }

    /* ============ CLIENT LIST ============ */
    .client-card {
      display: flex;
      align-items: center;
      padding: 16px;
      border: 1px solid #eee;
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .client-card:hover {
      border-color: var(--burgundy);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .client-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--burgundy);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      margin-right: 16px;
    }

    .client-info h4 {
      font-size: 16px;
      margin-bottom: 4px;
    }

    .client-info p {
      font-size: 13px;
      color: var(--soft-gray);
    }

    .client-stats {
      margin-left: auto;
      text-align: right;
    }

    .client-stats .sessions {
      font-size: 14px;
      font-weight: 600;
    }

    .client-stats .spent {
      font-size: 12px;
      color: var(--success);
    }

    /* ============ TOAST NOTIFICATIONS ============ */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      padding: 16px 24px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--info); }

    /* ============ LOADING ============ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 400;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--burgundy);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ============ EMPTY STATE ============ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--soft-gray);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--charcoal);
    }

    /* ============ DETAIL VIEW ============ */
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }

    .detail-item {
      margin-bottom: 20px;
    }

    .detail-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--soft-gray);
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 16px;
      color: var(--charcoal);
    }

    /* ============ MOBILE RESPONSIVE ============ */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--burgundy);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      z-index: 150;
      box-shadow: 0 4px 20px rgba(114, 47, 55, 0.4);
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .search-input {
        width: 100%;
      }

      .search-input:focus {
        width: 100%;
      }

      .modal {
        max-height: 100vh;
        border-radius: 0;
      }

      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }
    }

    /* ============ CALENDLY-STYLE AVAILABILITY ============ */
    .weekly-availability-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    .availability-day-card {
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
    }

    .availability-day-card.disabled {
      background: #f5f5f5;
      opacity: 0.6;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0d6cc;
    }

    .day-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--charcoal);
    }

    .day-toggle {
      position: relative;
      width: 52px;
      height: 28px;
    }

    .day-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .day-toggle input:checked + .toggle-slider {
      background-color: var(--burgundy);
    }

    .day-toggle input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .time-slots-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }

    .time-slot-btn {
      padding: 10px 12px;
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: var(--charcoal);
      text-align: center;
      transition: all 0.2s;
      font-weight: 500;
    }

    .time-slot-btn:hover:not(.selected) {
      border-color: var(--burgundy);
      background: var(--gold-light);
    }

    .time-slot-btn.selected {
      background: var(--burgundy);
      color: white;
      border-color: var(--burgundy);
    }

    .time-slot-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .slot-duration-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--gold-light);
      border-radius: 8px;
    }

    .slot-duration-selector label {
      font-size: 14px;
      font-weight: 600;
      color: var(--charcoal);
      margin-right: 8px;
    }

    .slot-duration-selector input[type="radio"] {
      margin-right: 6px;
    }

    .availability-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 2px solid #e0d6cc;
    }

    .availability-summary {
      background: var(--gold-light);
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      color: var(--charcoal);
    }

    .availability-summary strong {
      color: var(--burgundy);
    }

    /* ============ MARKETING COMPONENTS ============ */
    .template-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .template-card {
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }

    .template-card:hover {
      border-color: var(--burgundy);
      box-shadow: 0 8px 24px rgba(114, 47, 55, 0.15);
      transform: translateY(-4px);
    }

    .template-preview {
      height: 200px;
      background: linear-gradient(135deg, var(--gold-light) 0%, var(--cream) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      border-bottom: 1px solid #e0d6cc;
    }

    .template-info {
      padding: 16px;
    }

    .template-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--charcoal);
      margin-bottom: 6px;
    }

    .template-description {
      font-size: 13px;
      color: var(--soft-gray);
      line-height: 1.5;
    }

    .campaign-item, .segment-item, .workflow-item {
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .campaign-item:hover, .segment-item:hover, .workflow-item:hover {
      border-color: var(--burgundy);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .campaign-header, .segment-header, .workflow-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .campaign-title, .segment-title, .workflow-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--burgundy);
      margin-bottom: 6px;
    }

    .campaign-meta, .segment-meta, .workflow-meta {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      font-size: 14px;
      color: var(--soft-gray);
    }

    .campaign-meta span, .segment-meta span, .workflow-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .campaign-actions, .segment-actions, .workflow-actions {
      display: flex;
      gap: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.draft {
      background: var(--soft-gray);
      color: white;
    }

    .status-badge.scheduled {
      background: var(--info);
      color: white;
    }

    .status-badge.sent {
      background: var(--success);
      color: white;
    }

    .status-badge.active {
      background: var(--burgundy);
      color: white;
    }

    .status-badge.paused {
      background: var(--warning);
      color: white;
    }

    .analytics-chart {
      background: white;
      border: 1px solid #e0d6cc;
      border-radius: 8px;
      padding: 20px;
      min-height: 200px;
    }

    .lifecycle-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--gold-light);
      border-radius: 8px;
    }

    .lifecycle-label {
      min-width: 120px;
      font-weight: 600;
      color: var(--charcoal);
    }

    .lifecycle-progress {
      flex: 1;
      height: 24px;
      background: #e0d6cc;
      border-radius: 12px;
      overflow: hidden;
    }

    .lifecycle-progress-fill {
      height: 100%;
      background: var(--burgundy);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    .lifecycle-count {
      min-width: 60px;
      text-align: right;
      font-weight: 600;
      color: var(--burgundy);
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--warm-white);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 2px solid #e0d6cc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 24px;
      color: var(--burgundy);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--soft-gray);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--burgundy);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 2px solid #e0d6cc;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .segment-filter {
      background: var(--gold-light);
      border: 1px solid #e0d6cc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .segment-filter-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .segment-filter-row select, .segment-filter-row input {
      flex: 1;
      min-width: 150px;
    }

    .workflow-step {
      background: white;
      border: 2px solid var(--burgundy);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }

    .workflow-step::after {
      content: '‚Üì';
      display: block;
      text-align: center;
      font-size: 24px;
      color: var(--burgundy);
      margin: 8px 0 -8px 0;
    }

    .workflow-step:last-child::after {
      display: none;
    }

    .workflow-step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .workflow-step-title {
      font-weight: 600;
      color: var(--burgundy);
    }

    .email-preview {
      background: white;
      border: 1px solid #e0d6cc;
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .email-preview-subject {
      font-size: 18px;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e0d6cc;
    }

    .email-preview-body {
      line-height: 1.7;
      color: var(--charcoal);
    }

    /* ============ PRINT STYLES ============ */
    @media print {
      .sidebar, .mobile-menu-btn, .btn, .toast-container, .page-header, .card-header {
        display: none !important;
      }

      .main-content {
        margin-left: 0;
      }

      .card {
        box-shadow: none;
        border: none;
      }
      
      .business-card {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* Remove screen-only elements from print */
      body * {
        visibility: hidden;
      }
      
      #printableCards, #printableCards * {
        visibility: visible;
      }
      
      #printableCards {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
    
    /* Business Card Styles */
    .business-card {
      width: 3.5in;
      height: 2in;
      border: 2px solid #D4AF37;
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      display: inline-block;
      background: linear-gradient(135deg, #ffffff 0%, #fdfaf5 50%, #fff8f0 100%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      page-break-inside: avoid;
      position: relative;
      overflow: hidden;
    }
    
    .business-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
      pointer-events: none;
    }
    
    @media print {
      .business-card {
        margin: 0.25in;
        box-shadow: none;
      }
    }

    /* ============ QUICK ACTIONS ============ */
    .quick-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      background: #f0f0f0;
      color: var(--charcoal);
    }

    .action-btn:hover {
      background: var(--burgundy);
      color: white;
    }

    /* ============ CONTENT EDITOR ============ */
    .content-item {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
    }

    .content-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .content-item-actions {
      display: flex;
      gap: 8px;
    }

    .content-item h4 {
      font-size: 16px;
      color: var(--burgundy);
      margin-bottom: 8px;
    }

    .content-item p {
      font-size: 14px;
      color: var(--charcoal);
      white-space: pre-wrap;
    }

    .content-item.inactive {
      opacity: 0.5;
      border-style: dashed;
    }

    .drag-handle {
      cursor: grab;
      color: var(--soft-gray);
      margin-right: 8px;
    }

    /* ============ REVENUE CHART ============ */
    .revenue-chart {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 20px 0;
    }

    .revenue-bar {
      flex: 1;
      background: linear-gradient(to top, var(--burgundy), var(--burgundy-light));
      border-radius: 4px 4px 0 0;
      position: relative;
      min-height: 20px;
    }

    .revenue-bar:hover {
      background: linear-gradient(to top, var(--burgundy-dark), var(--burgundy));
    }

    .revenue-bar span {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--soft-gray);
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div class="login-container" id="loginScreen">
    <div class="login-card">
      <h1>ü™∑ Admin Dashboard</h1>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" required autocomplete="username">
        <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
        <button type="submit">Sign In</button>
        <p class="login-error" id="loginError">Invalid credentials</p>
      </form>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard" id="dashboard">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>ü™∑ Ravi</h2>
        <small>Admin Dashboard</small>
      </div>
      <ul class="nav-menu">
        <li class="nav-item active" data-page="overview">
          <span class="nav-icon">üìä</span> Overview
        </li>
        <li class="nav-item" data-page="bookings">
          <span class="nav-icon">üìã</span> Bookings
        </li>
        <li class="nav-item" data-page="calendar">
          <span class="nav-icon">üìÖ</span> Calendar
        </li>
        <li class="nav-item" data-page="clients">
          <span class="nav-icon">üë•</span> Clients
        </li>
        <li class="nav-item" data-page="invitations">
          <span class="nav-icon">üéüÔ∏è</span> Invitation Codes
        </li>
        <li class="nav-item" data-page="inquiries">
          <span class="nav-icon">üì¨</span> Inquiries <span id="inquiriesBadge" class="badge gold-badge display-none">0</span>
        </li>
        <li class="nav-divider" aria-hidden="true"></li>
        <li class="nav-item" data-page="marketing">
          <span class="nav-icon">üìß</span> Marketing <span class="badge" style="background: var(--gold);">NEW</span>
        </li>
        <li class="nav-item" data-page="content">
          <span class="nav-icon">‚úèÔ∏è</span> Content
        </li>
        <li class="nav-item" data-page="settings">
          <span class="nav-icon">‚öôÔ∏è</span> Settings
        </li>
        <li class="nav-divider" aria-hidden="true"></li>
        <li class="nav-item" data-page="export">
          <span class="nav-icon">üì§</span> Export & Backup
        </li>
        <li class="nav-item" data-page="help">
          <span class="nav-icon">üìö</span> User Guide
        </li>
        <li class="nav-item" id="logoutBtn">
          <span class="nav-icon">üö™</span> Logout
        </li>
      </ul>
    </aside>

    <!-- MOBILE MENU BUTTON -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">‚ò∞</button>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- OVERVIEW PAGE -->
      <section class="page active" id="page-overview">
        <div class="page-header">
          <h1 class="page-title">Dashboard Overview</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshDashboard()">üîÑ Refresh</button>
          </div>
        </div>

        <div class="stats-grid" id="statsGrid">
          <!-- Stats populated by JS -->
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Booking Requests</h3>
            <a href="#" onclick="showPage('bookings')" class="btn btn-sm btn-outline">View All</a>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="recentBookingsTable">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Revenue Overview</h3>
          </div>
          <div class="card-body">
            <div class="revenue-chart" id="revenueChart">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- BOOKINGS PAGE -->
      <section class="page" id="page-bookings">
        <div class="page-header">
          <h1 class="page-title">Bookings</h1>
          <div class="header-actions">
            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text" class="search-input" id="bookingSearch" placeholder="Search bookings...">
            </div>
            <select class="form-select form-select-auto" id="statusFilter">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Service</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Scheduled</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bookingsTable">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- CALENDAR PAGE -->
      <section class="page" id="page-calendar">
        <div class="page-header">
          <h1 class="page-title">Calendar</h1>
          <div style="display: flex; gap: 16px; font-size: 12px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 16px; height: 16px; background: var(--burgundy); border-radius: 3px;"></div>
              <span>Confirmed</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 16px; height: 16px; background: #ffc107; border: 1px dashed #ff9800; border-radius: 3px;"></div>
              <span>Pending</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="calendar-header">
              <h3 id="calendarTitle">December 2024</h3>
              <div class="calendar-nav">
                <button class="btn btn-sm btn-outline" id="prevMonth">‚Üê Prev</button>
                <button class="btn btn-sm btn-outline" id="todayBtn">Today</button>
                <button class="btn btn-sm btn-outline" id="nextMonth">Next ‚Üí</button>
              </div>
            </div>
            <div class="calendar" id="calendarGrid">
              <!-- Calendar populated by JS -->
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Upcoming Sessions</h3>
          </div>
          <div class="card-body" id="upcomingList">
            <!-- Populated by JS -->
          </div>
        </div>
      </section>

      <!-- CLIENTS PAGE -->
      <section class="page" id="page-clients">
        <div class="page-header">
          <h1 class="page-title">Client Directory</h1>
          <div class="header-actions">
            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text" class="search-input" id="clientSearch" placeholder="Search clients...">
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Clients</div>
            <div class="stat-value" id="totalClientsCount">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Repeat Clients</div>
            <div class="stat-value" id="repeatClientsCount">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-body" id="clientsList">
            <!-- Populated by JS -->
          </div>
        </div>
      </section>

      <!-- INVITATION CODES PAGE -->
      <section class="page" id="page-invitations">
        <div class="page-header">
          <h1 class="page-title">üéüÔ∏è Invitation Codes</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="printCodes()">üñ®Ô∏è Print Cards</button>
            <button class="btn btn-primary" onclick="openGenerateCodesModal()">+ Generate Codes</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Codes</div>
            <div class="stat-value" id="totalCodesCount">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Available</div>
            <div class="stat-value" id="availableCodesCount">0</div>
          </div>
          <div class="stat-card primary">
            <div class="stat-label">Used</div>
            <div class="stat-value" id="usedCodesCount">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Invitation Codes</h3>
            <p class="form-description">Create unique codes to give to potential clients</p>
          </div>
          <div class="card-body">
            <div class="tabs tabs-container">
              <div class="tab active" onclick="filterCodes('all')">All</div>
              <div class="tab" onclick="filterCodes('available')">Available</div>
              <div class="tab" onclick="filterCodes('used')">Used</div>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Label</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Used By</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="invitationCodesTable">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Print Preview -->
        <div id="printPreview" class="print-preview">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üñ®Ô∏è Print Preview - Business Card Codes</h3>
            </div>
            <div class="card-body printable-cards" id="printableCards">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- INQUIRIES PAGE -->
      <section class="page" id="page-inquiries">
        <div class="page-header">
          <h1 class="page-title">üì¨ Visitor Inquiries</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadInquiries()">üîÑ Refresh</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card stat-card-gold">
            <div class="stat-label">New Inquiries</div>
            <div class="stat-value" id="newInquiriesCount">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Invited</div>
            <div class="stat-value" id="invitedInquiriesCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total</div>
            <div class="stat-value" id="totalInquiriesCount">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">People Who Want to Connect</h3>
            <p class="form-description">Review inquiries and send invitation codes to approved visitors</p>
          </div>
          <div class="card-body" id="inquiriesList">
            <p class="no-items-message">No inquiries yet</p>
          </div>
        </div>
      </section>

      <!-- MARKETING PAGE -->
      <section class="page" id="page-marketing">
        <div class="page-header">
          <h1 class="page-title">Marketing Automation</h1>
          <p style="color: var(--soft-gray); margin-top: 8px;">Mailchimp & HubSpot-style campaigns, segmentation & automation</p>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="campaigns">üìß Campaigns</div>
          <div class="tab" data-tab="segments">üéØ Segments</div>
          <div class="tab" data-tab="automation">‚ö° Automation</div>
          <div class="tab" data-tab="templates">üìÑ Templates</div>
          <div class="tab" data-tab="analytics">üìä Analytics</div>
        </div>

        <!-- Campaigns Tab -->
        <div class="tab-content active" data-content="campaigns">
          <div class="card">
            <div class="card-header">
              <h3>Email Campaigns</h3>
              <button class="btn btn-primary" onclick="showCampaignBuilder()">
                <span>üìß</span> Create Campaign
              </button>
            </div>
            <div class="card-body">
              <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                  <div class="stat-label">Total Campaigns</div>
                  <div class="stat-value" id="totalCampaigns">0</div>
                </div>
                <div class="stat-card success">
                  <div class="stat-label">Sent</div>
                  <div class="stat-value" id="sentCampaigns">0</div>
                </div>
                <div class="stat-card info">
                  <div class="stat-label">Avg Open Rate</div>
                  <div class="stat-value" id="avgOpenRate">0%</div>
                </div>
                <div class="stat-card gold">
                  <div class="stat-label">Avg Click Rate</div>
                  <div class="stat-value" id="avgClickRate">0%</div>
                </div>
              </div>
              <div id="campaignsList">
                <p class="no-items-message">No campaigns yet. Create your first email campaign!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Segments Tab -->
        <div class="tab-content" data-content="segments">
          <div class="card">
            <div class="card-header">
              <h3>Client Segments</h3>
              <button class="btn btn-primary" onclick="showSegmentBuilder()">
                <span>üéØ</span> Create Segment
              </button>
            </div>
            <div class="card-body">
              <p style="color: var(--soft-gray); margin-bottom: 20px;">
                Group clients by behavior, booking history, service preferences, or engagement level for targeted campaigns.
              </p>
              <div id="segmentsList">
                <p class="no-items-message">No segments yet. Create your first audience segment!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Automation Tab -->
        <div class="tab-content" data-content="automation">
          <div class="card">
            <div class="card-header">
              <h3>Automated Workflows</h3>
              <button class="btn btn-primary" onclick="showWorkflowBuilder()">
                <span>‚ö°</span> Create Workflow
              </button>
            </div>
            <div class="card-body">
              <p style="color: var(--soft-gray); margin-bottom: 20px;">
                Set up automated email sequences triggered by client actions: new bookings, follow-ups, re-engagement, birthdays.
              </p>
              <div id="workflowsList">
                <p class="no-items-message">No workflows yet. Automate your client communications!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Templates Tab -->
        <div class="tab-content" data-content="templates">
          <div class="card">
            <div class="card-header">
              <h3>Email Templates</h3>
              <button class="btn btn-primary" onclick="showTemplateEditor()">
                <span>üìÑ</span> Create Template
              </button>
            </div>
            <div class="card-body">
              <div class="template-gallery" id="templateGallery">
                <!-- Pre-built templates will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" data-content="analytics">
          <div class="card">
            <div class="card-header">
              <h3>Marketing Analytics</h3>
              <div class="header-actions">
                <select id="analyticsDateRange" class="form-control" style="width: auto;" onchange="loadMarketingAnalytics()">
                  <option value="7">Last 7 Days</option>
                  <option value="30" selected>Last 30 Days</option>
                  <option value="90">Last 90 Days</option>
                  <option value="365">Last Year</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-label">Total Subscribers</div>
                  <div class="stat-value" id="totalSubscribers">0</div>
                </div>
                <div class="stat-card success">
                  <div class="stat-label">Emails Sent</div>
                  <div class="stat-value" id="totalEmailsSent">0</div>
                </div>
                <div class="stat-card info">
                  <div class="stat-label">Total Opens</div>
                  <div class="stat-value" id="totalOpens">0</div>
                </div>
                <div class="stat-card gold">
                  <div class="stat-label">Total Clicks</div>
                  <div class="stat-value" id="totalClicks">0</div>
                </div>
              </div>

              <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 16px;">Client Lifecycle Distribution</h4>
                <div id="lifecycleChart" class="analytics-chart"></div>
              </div>

              <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 16px;">Campaign Performance</h4>
                <div id="campaignPerformanceList"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CONTENT PAGE -->
      <section class="page" id="page-content">
        <div class="page-header">
          <h1 class="page-title">Content Management</h1>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="testimonials">Testimonials</div>
          <div class="tab" data-tab="pending-testimonials">Pending <span id="pendingBadge" class="badge display-none">0</span></div>
          <div class="tab" data-tab="faqs">FAQs</div>
          <div class="tab" data-tab="site-settings">Site Settings</div>
        </div>

        <!-- Testimonials Tab -->
        <div class="tab-content active" id="tab-testimonials">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Testimonials</h3>
              <button class="btn btn-primary" onclick="openTestimonialModal()">+ Add Testimonial</button>
            </div>
            <div class="card-body" id="testimonialsList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Pending Testimonials Tab -->
        <div class="tab-content" id="tab-pending-testimonials">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Pending Testimonials</h3>
              <p class="form-description">Client-submitted testimonials awaiting your approval</p>
            </div>
            <div class="card-body" id="pendingTestimonialsList">
              <p class="no-items-message">No pending testimonials</p>
            </div>
          </div>
        </div>

        <!-- FAQs Tab -->
        <div class="tab-content" id="tab-faqs">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Frequently Asked Questions</h3>
              <button class="btn btn-primary" onclick="openFaqModal()">+ Add FAQ</button>
            </div>
            <div class="card-body" id="faqsList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Site Settings Tab -->
        <div class="tab-content" id="tab-site-settings">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Site Settings</h3>
            </div>
            <div class="card-body">
              <form id="siteSettingsForm">
                <div class="form-group">
                  <label class="form-label">Site Name</label>
                  <input type="text" class="form-input" id="siteName">
                </div>
                <div class="form-group">
                  <label class="form-label">Tagline</label>
                  <input type="text" class="form-input" id="siteTagline">
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-input" id="siteEmail">
                </div>
                <div class="form-group">
                  <label class="form-label">Location</label>
                  <input type="text" class="form-input" id="siteLocation">
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="maintenanceMode"> Maintenance Mode (hide site from public)
                  </label>
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
              </form>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS PAGE -->
      <section class="page" id="page-settings">
        <div class="page-header">
          <h1 class="page-title">Settings</h1>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="services">Services</div>
          <div class="tab" data-tab="availability">Availability</div>
          <div class="tab" data-tab="email">Email Settings</div>
          <div class="tab" data-tab="security">Security</div>
        </div>

        <!-- Services Tab -->
        <div class="tab-content active" id="tab-services">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Services & Pricing</h3>
            </div>
            <div class="card-body" id="servicesList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Availability Tab -->
        <div class="tab-content" id="tab-availability">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Weekly Availability</h3>
              <p style="color: var(--soft-gray); font-size: 14px; margin-top: 8px;">Set your recurring weekly schedule</p>
            </div>
            <div class="card-body">
              <div id="weeklyAvailability">
                <!-- Populated by JS with day-by-day time slot picker -->
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Blocked Dates</h3>
              <button class="btn btn-secondary" onclick="openBlockDateModal()">+ Block Date</button>
            </div>
            <div class="card-body" id="blockedDatesList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Email Tab -->
        <div class="tab-content" id="tab-email">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Email Notification Settings</h3>
            </div>
            <div class="card-body">
              <form id="emailSettingsForm">
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="emailNotifications" checked> Email notifications for new bookings
                  </label>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="autoConfirmationEmail" checked> Auto-send confirmation to clients
                  </label>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="reminderEmails" checked> Send reminder emails
                  </label>
                </div>
                <div class="form-group">
                  <label class="form-label">Reminder Hours Before Session</label>
                  <input type="number" class="form-input reminder-hours-input" id="reminderHours" value="24" min="1" max="72">
                </div>
                <button type="submit" class="btn btn-primary">Save Email Settings</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Security Tab -->
        <div class="tab-content" id="tab-security">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Change Admin Password</h3>
            </div>
            <div class="card-body">
              <div class="warning-box">
                <strong>‚ö†Ô∏è Important:</strong> Changing your password will log you out. You'll need to login again with your new password.
              </div>
              
              <form id="changePasswordForm" onsubmit="handlePasswordChange(event)">
                <div class="form-group">
                  <label class="form-label">Current Password <span class="required">*</span></label>
                  <input type="password" class="form-input" id="currentPassword" required minlength="8" autocomplete="current-password">
                </div>
                <div class="form-group">
                  <label class="form-label">New Password <span class="required">*</span></label>
                  <input type="password" class="form-input" id="newPassword" required minlength="12" autocomplete="new-password">
                  <small class="password-hint">Minimum 12 characters, mix of uppercase, lowercase, numbers, and symbols</small>
                </div>
                <div class="form-group">
                  <label class="form-label">Confirm New Password <span class="required">*</span></label>
                  <input type="password" class="form-input" id="confirmPassword" required minlength="12" autocomplete="new-password">
                </div>
                <div id="passwordStrength" class="password-strength">
                  <div class="strength-label"><strong>Password Strength:</strong> <span id="strengthText"></span></div>
                  <div class="strength-bar-container">
                    <div id="strengthBar" class="strength-bar"></div>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Change Password</button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üîê Password Recovery</h3>
            </div>
            <div class="card-body">
              <p class="recovery-instructions">If you forget your password, follow these steps:</p>
              <ol class="recovery-list">
                <li>Stop the server (if running locally)</li>
                <li>Edit the <code class="code-snippet">.env</code> file in your project directory</li>
                <li>Change <code class="code-snippet">ADMIN_PASSWORD</code> to a new password</li>
                <li>Restart the server</li>
                <li>Login with your new password</li>
              </ol>
              <div class="info-box">
                <strong>üí° Tip:</strong> Keep a secure backup of your credentials in a password manager like 1Password, LastPass, or Bitwarden.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">üìö Setup Documentation</h3>
            </div>
            <div class="card-body">
              <p class="recovery-instructions">Need help with configuration?</p>
              <div class="help-links">
                <a href="../SETUP_GUIDE.md" target="_blank" class="btn btn-outline help-link">
                  üìñ View Setup Guide
                </a>
                <p class="help-contact">
                  Complete guide for initial setup, email configuration, SMS setup, and deployment to production.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EXPORT PAGE -->
      <section class="page" id="page-export">
        <div class="page-header">
          <h1 class="page-title">Export & Backup</h1>
        </div>

        <div class="stats-grid">
          <div class="card export-card">
            <h3>üìä Export Bookings</h3>
            <p>Download all booking data as CSV</p>
            <button class="btn btn-primary" onclick="exportBookings()">Download CSV</button>
          </div>
          <div class="card export-card">
            <h3>üë• Export Clients</h3>
            <p>Download client directory as CSV</p>
            <button class="btn btn-primary" onclick="exportClients()">Download CSV</button>
          </div>
          <div class="card export-card">
            <h3>üíæ Full Backup</h3>
            <p>Download complete data backup</p>
            <button class="btn btn-secondary" onclick="downloadBackup()">Download Backup</button>
          </div>
          <div class="card export-card">
            <h3>üì• Restore Backup</h3>
            <p>Restore from backup file</p>
            <input type="file" id="restoreFile" accept=".json" class="display-none" onchange="handleRestore(this)">
            <button class="btn btn-outline" onclick="document.getElementById('restoreFile').click()">Upload Backup</button>
          </div>
        </div>

        <!-- AUTOMATIC BACKUP SYSTEM -->
        <div class="card backup-system-card">
          <div class="backup-header">
            <div>
              <h3 class="backup-title">üõ°Ô∏è Automatic Backup System</h3>
              <p class="form-description">
                Every data change is automatically backed up for maximum protection
              </p>
            </div>
            <button class="btn btn-primary" onclick="loadBackupStats()">üîÑ Refresh</button>
          </div>

          <!-- Backup Stats -->
          <div id="backupStats" class="stats-grid backup-stats-container">
            <div class="backup-stat-item">
              <div class="backup-stat-value" id="totalAutoBackups">-</div>
              <div class="backup-stat-label">Auto Backups</div>
            </div>
            <div class="backup-stat-item">
              <div class="backup-stat-value" id="totalManualBackups">-</div>
              <div class="backup-stat-label">Manual Backups</div>
            </div>
            <div class="backup-stat-item">
              <div class="backup-stat-value-small" id="backupSize">-</div>
              <div class="backup-stat-label">Total Size</div>
            </div>
            <div style="background: white; padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 16px; color: var(--burgundy); font-weight: bold;" id="newestBackup">-</div>
              <div style="color: var(--soft-gray); font-size: 12px; text-transform: uppercase; margin-top: 4px;">Latest Backup</div>
            </div>
          </div>

          <!-- Backup Info Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="background: #e8f5e9; padding: 16px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h4 style="color: #2e7d32; margin-bottom: 8px; font-size: 14px;">‚úì Real-Time Protection</h4>
              <p style="color: #555; font-size: 13px; line-height: 1.5;">
                Every booking, setting change, and data update is automatically backed up
              </p>
            </div>
            <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h4 style="color: #1565c0; margin-bottom: 8px; font-size: 14px;">üîí Encrypted Storage</h4>
              <p style="color: #555; font-size: 13px; line-height: 1.5;">
                All backups use military-grade AES-256-GCM encryption
              </p>
            </div>
            <div style="background: #fff3e0; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h4 style="color: #e65100; margin-bottom: 8px; font-size: 14px;">‚ôªÔ∏è Smart Rotation</h4>
              <p style="color: #555; font-size: 13px; line-height: 1.5;">
                Keeps last 50 automatic backups, removes older ones automatically
              </p>
            </div>
          </div>

          <!-- Filter Tabs -->
          <div style="margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-sm" onclick="filterBackups('all')" id="filterAll" style="background: var(--burgundy); color: white;">All</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('bookings')" id="filterBookings">Bookings</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('settings')" id="filterSettings">Settings</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('content')" id="filterContent">Content</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('clients')" id="filterClients">Clients</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('manual')" id="filterManual">Manual</button>
          </div>

          <!-- Backup List -->
          <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: var(--burgundy); color: white; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">File Type</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Date & Time</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Size</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Type</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                  </tr>
                </thead>
                <tbody id="backupListTable">
                  <tr>
                    <td colspan="5" style="padding: 40px; text-align: center; color: var(--soft-gray);">
                      <div style="font-size: 48px; margin-bottom: 8px;">üì¶</div>
                      <div>Loading backups...</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- DEMO MODE SECTION -->
        <div class="card" style="padding: 24px; margin-top: 24px; border: 2px dashed var(--gold);">
          <h3 style="margin-bottom: 12px; color: var(--gold);">üé≠ Demo Mode</h3>
          <p style="color: var(--soft-gray); margin-bottom: 16px;">Tools for demonstrating the system to Ravi</p>
          
          <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin-bottom: 8px;"><strong>Demo Invitation Code:</strong></p>
            <code style="background: var(--burgundy); color: white; padding: 8px 16px; border-radius: 4px; font-size: 18px; display: inline-block;">DEMO-2026</code>
            <p style="margin-top: 8px; font-size: 12px; color: var(--soft-gray);">Use this code at /portal.html to access the client experience</p>
          </div>

          <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin-bottom: 8px;"><strong>Demo Walkthrough:</strong></p>
            <ol style="margin-left: 20px; color: var(--soft-gray); font-size: 14px; line-height: 1.8;">
              <li>Landing page: <a href="/" target="_blank" style="color: var(--burgundy);">localhost:3000</a> - New visitor inquiry form</li>
              <li>Client portal: <a href="/portal.html" target="_blank" style="color: var(--burgundy);">localhost:3000/portal.html</a> - Enter DEMO-2026</li>
              <li>After code entry ‚Üí Full site with booking form</li>
              <li>Submit a booking ‚Üí View in Bookings page</li>
              <li>Confirm booking with date ‚Üí Appears on Calendar</li>
              <li>Complete booking ‚Üí Client record created</li>
            </ol>
          </div>

          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="populateDemoData()">
              ‚ú® Populate Demo Data
            </button>
            <button class="btn btn-outline" onclick="resetDemoData()" style="color: #c62828; border-color: #c62828;">
              üóëÔ∏è Clear All Data
            </button>
          </div>
        </div>
      </section>

      <!-- ============ USER GUIDE PAGE ============ -->
      <section class="page" id="page-help">
        <div class="page-header">
          <h1 class="page-title">üìö Admin User Guide</h1>
          <button class="btn btn-primary" onclick="showPage('overview')">‚Üê Back to Dashboard</button>
        </div>

        <div class="card" style="padding: 32px; max-width: 900px; margin: 0 auto;">
          <div style="margin-bottom: 32px; text-align: center;">
            <h2 style="color: var(--burgundy); margin-bottom: 8px;">Complete Guide to Your Admin Dashboard</h2>
            <p style="color: var(--soft-gray);">Everything you need to manage Ravi's Sacred Healing</p>
          </div>

          <!-- Table of Contents -->
          <div style="background: #f8f4ef; padding: 24px; border-radius: 8px; margin-bottom: 32px;">
            <h3 style="margin-bottom: 16px; color: var(--burgundy);">üìë Quick Navigation</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <a href="#guide-login" style="color: var(--burgundy); text-decoration: none;">üîê Logging In</a>
              <a href="#guide-overview" style="color: var(--burgundy); text-decoration: none;">üìä Dashboard Overview</a>
              <a href="#guide-inquiries" style="color: var(--burgundy); text-decoration: none;">üì¨ Inquiries</a>
              <a href="#guide-bookings" style="color: var(--burgundy); text-decoration: none;">üìã Bookings</a>
              <a href="#guide-calendar" style="color: var(--burgundy); text-decoration: none;">üìÖ Calendar</a>
              <a href="#guide-clients" style="color: var(--burgundy); text-decoration: none;">üë• Clients</a>
              <a href="#guide-invitations" style="color: var(--burgundy); text-decoration: none;">üéüÔ∏è Invitation Codes</a>
              <a href="#guide-content" style="color: var(--burgundy); text-decoration: none;">‚úèÔ∏è Content</a>
              <a href="#guide-settings" style="color: var(--burgundy); text-decoration: none;">‚öôÔ∏è Settings</a>
              <a href="#guide-export" style="color: var(--burgundy); text-decoration: none;">üì§ Export & Backup</a>
              <a href="#guide-tasks" style="color: var(--burgundy); text-decoration: none;">üîç Common Tasks</a>
              <a href="#guide-troubleshooting" style="color: var(--burgundy); text-decoration: none;">üÜò Troubleshooting</a>
            </div>
          </div>

          <!-- Content Sections -->
          <div style="line-height: 1.8; color: var(--soft-charcoal);">
            
            <!-- Logging In -->
            <div id="guide-login" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üîê Logging In</h2>
              <ol style="margin-left: 20px;">
                <li>Navigate to: <code style="background: #f8f4ef; padding: 4px 8px; border-radius: 4px;">http://localhost:3000/admin.html</code></li>
                <li>Enter your username: <strong>ravi</strong></li>
                <li>Enter your secure password</li>
                <li>Click "ü™∑ Enter Admin Portal"</li>
              </ol>
              <p style="background: #fff3e0; padding: 12px; border-left: 4px solid var(--gold); border-radius: 4px; margin-top: 16px;">
                <strong>Security Note:</strong> Your session stays active until you log out. Always log out when finished, especially on shared computers.
              </p>
            </div>

            <!-- Dashboard Overview -->
            <div id="guide-overview" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üìä Dashboard Overview</h2>
              <p>When you first log in, you'll see the Overview page with:</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Statistics Cards</h3>
              <ul style="margin-left: 20px;">
                <li><strong>üìã Total Bookings:</strong> All time booking count</li>
                <li><strong>‚úÖ Confirmed Sessions:</strong> Scheduled bookings</li>
                <li><strong>‚è≥ Pending:</strong> Awaiting your confirmation</li>
                <li><strong>‚ú® Completed:</strong> Finished sessions</li>
                <li><strong>üí∞ Total Revenue:</strong> Lifetime earnings</li>
                <li><strong>üë• Total Clients:</strong> Unique client count</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Recent Bookings</h3>
              <p>Quick view of your latest 5 bookings with client name, service, status, date, and quick actions.</p>
            </div>

            <!-- Inquiries -->
            <div id="guide-inquiries" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üì¨ Inquiries Section</h2>
              <p><strong>Purpose:</strong> Manage new visitor inquiries from your landing page contact form.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Actions You Can Take</h3>
              <ul style="margin-left: 20px;">
                <li><strong>üìß Send Invitation:</strong> Generate unique code for client access</li>
                <li><strong>üìÅ Archive:</strong> Mark as reviewed but not invited</li>
                <li><strong>üóëÔ∏è Delete:</strong> Permanently remove (cannot be undone)</li>
              </ul>
              <p style="background: #e3f2fd; padding: 12px; border-left: 4px solid #2196f3; border-radius: 4px; margin-top: 16px;">
                <strong>Best Practice:</strong> Check inquiries daily and respond within 24-48 hours.
              </p>
            </div>

            <!-- Bookings -->
            <div id="guide-bookings" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üìã Bookings Section</h2>
              <p><strong>Purpose:</strong> Manage all session applications and bookings.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Understanding Booking Statuses</h3>
              <ul style="margin-left: 20px;">
                <li><strong style="color: #2196f3;">Pending:</strong> New application, awaiting your review</li>
                <li><strong style="color: #4caf50;">Confirmed:</strong> You've confirmed and scheduled</li>
                <li><strong style="color: #9c27b0;">Completed:</strong> Session has occurred</li>
                <li><strong style="color: #f44336;">Cancelled:</strong> Session was cancelled</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Key Actions</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Confirm Booking:</strong> Set date/time and notify client</li>
                <li><strong>Mark as Completed:</strong> After session is finished</li>
                <li><strong>Save Changes:</strong> Update notes, date, or time</li>
                <li><strong>Send Reminder:</strong> Manual reminder email</li>
              </ul>
              <p style="background: #fff3e0; padding: 12px; border-left: 4px solid var(--gold); border-radius: 4px; margin-top: 16px;">
                <strong>Important:</strong> Bookings only appear on calendar after status is "Confirmed" AND a confirmed date is entered.
              </p>
            </div>

            <!-- Calendar -->
            <div id="guide-calendar" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üìÖ Calendar Section</h2>
              <p><strong>Purpose:</strong> Visual overview of your scheduled sessions.</p>
              <ul style="margin-left: 20px;">
                <li>Shows confirmed bookings on their scheduled dates</li>
                <li>Navigate months with ‚óÄ Previous / Next ‚ñ∂ buttons</li>
                <li>Click any day to see all bookings that day</li>
                <li>Upcoming sessions panel on the right</li>
              </ul>
              <p style="margin-top: 12px;">Days with bookings show light purple background. Click any session to view full details.</p>
            </div>

            <!-- Clients -->
            <div id="guide-clients" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üë• Clients Section</h2>
              <p><strong>Purpose:</strong> Manage your client database and history.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">What You'll See</h3>
              <ul style="margin-left: 20px;">
                <li>Name and contact info</li>
                <li>Number of completed sessions</li>
                <li>Total revenue from this client</li>
                <li>Last contact date</li>
                <li>Tags you've assigned</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Client Detail View</h3>
              <p>Click any client to see complete booking history, add private notes, and manage tags.</p>
              <p style="background: #e3f2fd; padding: 12px; border-left: 4px solid #2196f3; border-radius: 4px; margin-top: 16px;">
                <strong>Tip:</strong> Add notes after each session and tag regular clients for easy identification.
              </p>
            </div>

            <!-- Invitation Codes -->
            <div id="guide-invitations" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üéüÔ∏è Invitation Codes Section</h2>
              <p><strong>Purpose:</strong> Generate and manage exclusive access codes.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">What Are Invitation Codes?</h3>
              <p>Unique codes that grant access to your full website. More personal than generic passwords.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Generating New Codes</h3>
              <ol style="margin-left: 20px;">
                <li>Click "+ Generate New Code"</li>
                <li>Choose prefix: SACRED, LOTUS, HEALING, BLISS, or custom</li>
                <li>Toggle "Single Use" (works once vs. multiple times)</li>
                <li>Optional: Set expiration date</li>
                <li>Optional: Add note for yourself</li>
                <li>Click "Generate Code"</li>
              </ol>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Print Business Cards</h3>
              <ol style="margin-left: 20px;">
                <li>Generate batch of codes</li>
                <li>Select multiple codes (checkboxes)</li>
                <li>Click "Print Selected"</li>
                <li>Print on cardstock and distribute</li>
              </ol>
              <p style="background: #e3f2fd; padding: 12px; border-left: 4px solid #2196f3; border-radius: 4px; margin-top: 16px;">
                <strong>Best Practice:</strong> Use expiration dates for limited promotions. Multi-use codes work great for business cards.
              </p>
            </div>

            <!-- Content -->
            <div id="guide-content" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">‚úèÔ∏è Content Section</h2>
              <p><strong>Purpose:</strong> Manage all website content without touching code.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Services Management</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Add Service:</strong> Name, duration (minutes), price</li>
                <li><strong>Edit Service:</strong> Modify any details</li>
                <li><strong>Active/Inactive:</strong> Show or hide from booking form</li>
                <li><strong>Delete:</strong> Remove service (existing bookings unaffected)</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Testimonials Management</h3>
              <ul style="margin-left: 20px;">
                <li>Add client testimonials and reviews</li>
                <li>Mark as "Featured" for prominent display</li>
                <li>Toggle active/inactive visibility</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">FAQs Management</h3>
              <ul style="margin-left: 20px;">
                <li>Add frequently asked questions and answers</li>
                <li>Set order (1 = first, 2 = second, etc.)</li>
                <li>Edit or delete anytime</li>
              </ul>
            </div>

            <!-- Settings -->
            <div id="guide-settings" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">‚öôÔ∏è Settings Section</h2>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Availability Settings</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Available Days:</strong> Check boxes for days you offer sessions</li>
                <li><strong>Time Slots:</strong> Add your typical session start times</li>
                <li><strong>Block Dates:</strong> Mark specific dates as unavailable</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Email Settings</h3>
              <p>Configure automated notifications:</p>
              <ul style="margin-left: 20px;">
                <li><strong>SMTP Host:</strong> Your email provider's server (e.g., smtp.gmail.com)</li>
                <li><strong>SMTP Port:</strong> Usually 587 or 465</li>
                <li><strong>Email Address:</strong> Your sending email</li>
                <li><strong>Password:</strong> Use app-specific password for security</li>
              </ul>
              <p style="background: #fff3e0; padding: 12px; border-left: 4px solid var(--gold); border-radius: 4px; margin-top: 16px;">
                <strong>Important:</strong> For Gmail/Outlook, generate app-specific passwords in Account Settings ‚Üí Security.
              </p>
            </div>

            <!-- Export & Backup -->
            <div id="guide-export" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üì§ Export & Backup Section</h2>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Export Options</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Bookings CSV:</strong> All bookings for accounting and reports</li>
                <li><strong>Clients CSV:</strong> Client list for mailing/CRM</li>
                <li><strong>Full Backup:</strong> Complete encrypted JSON backup</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Restore from Backup</h3>
              <p>Upload a backup file to restore all data. <strong>Warning:</strong> This replaces everything. Make a current backup first!</p>
              <p style="background: #ffebee; padding: 12px; border-left: 4px solid #f44336; border-radius: 4px; margin-top: 16px;">
                <strong>Critical:</strong> Download weekly backups! Name them clearly (e.g., ravi-backup-2026-01-28.json) and store safely.
              </p>
            </div>

            <!-- Common Tasks -->
            <div id="guide-tasks" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üîç Common Tasks Quick Reference</h2>
              
              <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="color: var(--burgundy); margin-bottom: 8px;">Processing a New Booking</h4>
                <ol style="margin-left: 20px; font-size: 14px;">
                  <li>Go to Bookings section</li>
                  <li>Click on pending booking</li>
                  <li>Review intake information</li>
                  <li>Enter confirmed date and time</li>
                  <li>Click "Confirm Booking"</li>
                  <li>Choose "Yes" to send confirmation email</li>
                  <li>Booking appears on calendar</li>
                </ol>
              </div>

              <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="color: var(--burgundy); margin-bottom: 8px;">Responding to an Inquiry</h4>
                <ol style="margin-left: 20px; font-size: 14px;">
                  <li>Go to Inquiries section</li>
                  <li>Read their message</li>
                  <li>Click "Send Invitation" (üìß)</li>
                  <li>Code is generated automatically</li>
                  <li>Send code to client via email or text</li>
                </ol>
              </div>

              <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="color: var(--burgundy); margin-bottom: 8px;">Completing a Session</h4>
                <ol style="margin-left: 20px; font-size: 14px;">
                  <li>Go to Bookings section</li>
                  <li>Find the booking</li>
                  <li>Add Session Notes (private)</li>
                  <li>Click "Mark as Completed"</li>
                  <li>Client added to database, revenue updated</li>
                </ol>
              </div>
            </div>

            <!-- Troubleshooting -->
            <div id="guide-troubleshooting" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">üÜò Troubleshooting</h2>
              
              <div style="margin-bottom: 16px;">
                <h4 style="color: var(--soft-charcoal); margin-bottom: 8px;">"Bookings not showing on calendar"</h4>
                <ul style="margin-left: 20px; font-size: 14px;">
                  <li>Ensure booking status is "Confirmed"</li>
                  <li>Verify confirmed date is set</li>
                  <li>Both status AND date are required</li>
                </ul>
              </div>

              <div style="margin-bottom: 16px;">
                <h4 style="color: var(--soft-charcoal); margin-bottom: 8px;">"Emails not sending"</h4>
                <ul style="margin-left: 20px; font-size: 14px;">
                  <li>Check Settings ‚Üí Email configuration</li>
                  <li>Verify SMTP details are correct</li>
                  <li>Ensure you're using app-specific password</li>
                  <li>Check if email notifications toggle is ON</li>
                </ul>
              </div>

              <div style="margin-bottom: 16px;">
                <h4 style="color: var(--soft-charcoal); margin-bottom: 8px;">"Invitation code not working"</h4>
                <ul style="margin-left: 20px; font-size: 14px;">
                  <li>Check if code is active (not deactivated)</li>
                  <li>Verify code hasn't expired</li>
                  <li>If single-use, check if already used</li>
                  <li>Try copy-pasting code instead of typing</li>
                </ul>
              </div>
            </div>

            <!-- Daily Routine -->
            <div style="background: linear-gradient(135deg, var(--burgundy) 0%, #8B1538 100%); color: white; padding: 24px; border-radius: 8px; margin-top: 32px;">
              <h3 style="color: white; margin-bottom: 16px;">üí° Daily Routine Recommendations</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                <div>
                  <h4 style="color: var(--gold); margin-bottom: 8px;">Morning</h4>
                  <ul style="margin-left: 20px; font-size: 14px; line-height: 1.8;">
                    <li>Check new inquiries</li>
                    <li>Review pending bookings</li>
                    <li>Confirm appointments</li>
                    <li>Check calendar for today</li>
                  </ul>
                </div>
                <div>
                  <h4 style="color: var(--gold); margin-bottom: 8px;">After Sessions</h4>
                  <ul style="margin-left: 20px; font-size: 14px; line-height: 1.8;">
                    <li>Add session notes</li>
                    <li>Mark as completed</li>
                    <li>Send follow-up if needed</li>
                  </ul>
                </div>
                <div>
                  <h4 style="color: var(--gold); margin-bottom: 8px;">Weekly</h4>
                  <ul style="margin-left: 20px; font-size: 14px; line-height: 1.8;">
                    <li>Download backup (Sunday)</li>
                    <li>Send upcoming reminders</li>
                    <li>Review revenue stats</li>
                    <li>Update blocked dates</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- BOOKING DETAIL MODAL -->
  <div class="modal-overlay" id="bookingModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title">Booking Details</h2>
        <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
      </div>
      <div class="modal-body" id="bookingModalBody">
        <!-- Populated by JS -->
      </div>
      <div class="modal-footer" id="bookingModalFooter">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- CLIENT DETAIL MODAL -->
  <div class="modal-overlay" id="clientModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Client Details</h2>
        <button class="modal-close" onclick="closeModal('clientModal')">&times;</button>
      </div>
      <div class="modal-body" id="clientModalBody">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- TESTIMONIAL MODAL -->
  <div class="modal-overlay" id="testimonialModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="testimonialModalTitle">Add Testimonial</h2>
        <button class="modal-close" onclick="closeModal('testimonialModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="testimonialForm">
          <input type="hidden" id="testimonialId">
          <div class="form-group">
            <label class="form-label">Author Name</label>
            <input type="text" class="form-input" id="testimonialAuthor" required>
          </div>
          <div class="form-group">
            <label class="form-label">Testimonial Text</label>
            <textarea class="form-textarea" id="testimonialText" rows="6" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="testimonialFeatured"> Featured (highlighted on site)
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('testimonialModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTestimonial()">Save</button>
      </div>
    </div>
  </div>

  <!-- FAQ MODAL -->
  <div class="modal-overlay" id="faqModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="faqModalTitle">Add FAQ</h2>
        <button class="modal-close" onclick="closeModal('faqModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="faqForm">
          <input type="hidden" id="faqId">
          <div class="form-group">
            <label class="form-label">Question</label>
            <input type="text" class="form-input" id="faqQuestion" required>
          </div>
          <div class="form-group">
            <label class="form-label">Answer</label>
            <textarea class="form-textarea" id="faqAnswer" rows="6" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('faqModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveFaq()">Save</button>
      </div>
    </div>
  </div>

  <!-- BLOCK DATE MODAL -->
  <div class="modal-overlay" id="blockDateModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Block Date</h2>
        <button class="modal-close" onclick="closeModal('blockDateModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Date</label>
          <input type="date" class="form-input" id="blockDate" required>
        </div>
        <div class="form-group">
          <label class="form-label">Reason (optional)</label>
          <input type="text" class="form-input" id="blockReason" placeholder="e.g., Holiday, Personal day">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('blockDateModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveBlockedDate()">Block Date</button>
      </div>
    </div>
  </div>

  <!-- EMAIL MODAL -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Send Email</h2>
        <button class="modal-close" onclick="closeModal('emailModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="emailRecipient" style="margin-bottom: 16px; color: var(--soft-gray);"></p>
        <input type="hidden" id="emailBookingId">
        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" class="form-input" id="emailSubject" required>
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea class="form-textarea" id="emailMessage" rows="6" required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('emailModal')">Cancel</button>
        <button class="btn btn-primary" onclick="sendCustomEmail()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- CLIENT MESSAGE MODAL -->
  <div class="modal-overlay" id="clientMessageModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Send Message to Client</h2>
        <button class="modal-close" onclick="closeModal('clientMessageModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="clientMessageRecipient" style="margin-bottom: 16px; color: var(--soft-gray);"></p>
        <input type="hidden" id="clientMessageId">
        <input type="hidden" id="clientMessageType">
        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" class="form-input" id="clientMessageSubject" value="A Message from Ravi ü™∑" required>
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea class="form-textarea" id="clientMessageText" rows="6" required placeholder="Write your message here..."></textarea>
        </div>
        <div class="form-group" id="proposedTimeGroup" style="display: none;">
          <label class="form-label">Proposed Appointment</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <input type="date" class="form-input" id="proposedDate">
            <select class="form-input" id="proposedTime">
              <option value="">Select time...</option>
              <option value="9:00 AM">9:00 AM</option>
              <option value="10:00 AM">10:00 AM</option>
              <option value="10:30 AM">10:30 AM</option>
              <option value="11:00 AM">11:00 AM</option>
              <option value="12:00 PM">12:00 PM</option>
              <option value="1:00 PM">1:00 PM</option>
              <option value="2:00 PM">2:00 PM</option>
              <option value="3:00 PM">3:00 PM</option>
              <option value="4:00 PM">4:00 PM</option>
              <option value="5:00 PM">5:00 PM</option>
              <option value="6:00 PM">6:00 PM</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="includeTestimonialLink">
            <span>Include link to submit testimonial</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('clientMessageModal')">Cancel</button>
        <button class="btn btn-primary" onclick="sendClientMessage()">üìß Send Message</button>
      </div>
    </div>
  </div>

  <!-- PROPOSE TIME MODAL -->
  <div class="modal-overlay" id="proposeTimeModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--gold) 0%, #c9a227 100%); color: white;">
        <h2 class="modal-title">üìÖ Propose Session Time</h2>
        <button class="modal-close" onclick="closeModal('proposeTimeModal')" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="proposeBookingId">
        <div id="proposeBookingInfo" style="background: #f8f5f0; padding: 16px; border-radius: 8px; margin-bottom: 20px;"></div>
        
        <p style="margin-bottom: 16px; color: var(--soft-gray);">
          The client will receive an email (and SMS if enabled) with your proposed time and a link to accept or request a different time.
        </p>
        
        <div class="form-group">
          <label class="form-label">Proposed Date *</label>
          <input type="date" class="form-input" id="proposeDate" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Proposed Time *</label>
          <select class="form-input" id="proposeTime" required>
            <option value="">Select time...</option>
            <option value="9:00 AM">9:00 AM</option>
            <option value="9:30 AM">9:30 AM</option>
            <option value="10:00 AM">10:00 AM</option>
            <option value="10:30 AM">10:30 AM</option>
            <option value="11:00 AM">11:00 AM</option>
            <option value="11:30 AM">11:30 AM</option>
            <option value="12:00 PM">12:00 PM</option>
            <option value="12:30 PM">12:30 PM</option>
            <option value="1:00 PM">1:00 PM</option>
            <option value="1:30 PM">1:30 PM</option>
            <option value="2:00 PM">2:00 PM</option>
            <option value="2:30 PM">2:30 PM</option>
            <option value="3:00 PM">3:00 PM</option>
            <option value="3:30 PM">3:30 PM</option>
            <option value="4:00 PM">4:00 PM</option>
            <option value="4:30 PM">4:30 PM</option>
            <option value="5:00 PM">5:00 PM</option>
            <option value="5:30 PM">5:30 PM</option>
            <option value="6:00 PM">6:00 PM</option>
            <option value="6:30 PM">6:30 PM</option>
            <option value="7:00 PM">7:00 PM</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Personal Message (optional)</label>
          <textarea class="form-textarea" id="proposeMessage" rows="3" placeholder="Add a personal note to the client..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('proposeTimeModal')">Cancel</button>
        <button class="btn btn-primary" onclick="sendProposal()" style="background: var(--gold);">üìß Send Proposal</button>
      </div>
    </div>
  </div>

  <!-- GENERATE CODES MODAL -->
  <div class="modal-overlay" id="generateCodesModal">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #D4AF37 0%, #c9a227 100%); color: white;">
        <h2 class="modal-title">üéüÔ∏è Generate Invitation Codes</h2>
        <button class="modal-close" onclick="closeModal('generateCodesModal')" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 20px; color: var(--soft-gray);">
          Create unique codes to share with potential clients. Perfect for business cards, flyers, or personal invitations!
        </p>
        
        <div class="form-group">
          <label class="form-label">How many codes?</label>
          <select class="form-input" id="codeCount">
            <option value="1">1 code</option>
            <option value="5">5 codes</option>
            <option value="10" selected>10 codes</option>
            <option value="20">20 codes</option>
            <option value="50">50 codes</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Prefix (optional)</label>
          <select class="form-input" id="codePrefix">
            <option value="">Random (SACRED, LOTUS, etc.)</option>
            <option value="RAVI">RAVI-XXXX</option>
            <option value="SACRED">SACRED-XXXX</option>
            <option value="LOTUS">LOTUS-XXXX</option>
            <option value="HEAL">HEAL-XXXX</option>
            <option value="LOVE">LOVE-XXXX</option>
            <option value="SOUL">SOUL-XXXX</option>
            <option value="BLISS">BLISS-XXXX</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Label (optional)</label>
          <input type="text" class="form-input" id="codeLabel" placeholder="e.g., Business Cards Jan 2026">
          <small style="color: var(--soft-gray);">Helps you track where codes were distributed</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Expiration</label>
          <select class="form-input" id="codeExpiry">
            <option value="">Never expires</option>
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <option value="90" selected>90 days</option>
            <option value="180">6 months</option>
            <option value="365">1 year</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('generateCodesModal')">Cancel</button>
        <button class="btn btn-primary" onclick="generateCodes()" style="background: var(--gold);">üéüÔ∏è Generate Codes</button>
      </div>
    </div>
  </div>

  <!-- PENDING TESTIMONIAL MODAL -->
  <div class="modal-overlay" id="pendingTestimonialModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Review Testimonial</h2>
        <button class="modal-close" onclick="closeModal('pendingTestimonialModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="pendingTestimonialId">
        <div style="background: #f5f0eb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <p style="font-weight: 600; margin-bottom: 8px;" id="pendingTestimonialAuthor"></p>
          <p style="font-size: 14px; color: var(--soft-gray);" id="pendingTestimonialMeta"></p>
        </div>
        <div style="background: white; border: 1px solid #e0d6cc; padding: 16px; border-radius: 8px; font-style: italic;">
          <p id="pendingTestimonialText"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="rejectPendingTestimonial()">‚ùå Reject</button>
        <button class="btn btn-success" onclick="approvePendingTestimonial()">‚úì Approve & Publish</button>
      </div>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // ===========================================
    // STATE & CONFIG
    // ===========================================
    let token = localStorage.getItem('adminToken');
    let bookings = [];
    let clients = [];
    let invitationCodes = [];
    let inquiries = [];
    let content = {};
    let settings = {};
    let currentCalendarDate = new Date();
    let codeFilter = 'all';

    // ===========================================
    // API HELPERS
    // ===========================================
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;

      try {
        const res = await fetch(endpoint, { ...options, headers });
        if (res.status === 401 || res.status === 403) {
          logout();
          return null;
        }
        
        // Handle file downloads
        if (res.headers.get('content-type')?.includes('text/csv')) {
          return res;
        }
        
        return await res.json();
      } catch (err) {
        console.error('API Error:', err);
        showToast('Connection error. Please try again.', 'error');
        return null;
      }
    }

    // ===========================================
    // AUTH
    // ===========================================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      showLoading(true);
      const data = await api('/api/auth/admin', {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });
      showLoading(false);

      if (data?.success) {
        token = data.token;
        localStorage.setItem('adminToken', token);
        showDashboard();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    });

    function logout() {
      token = null;
      localStorage.removeItem('adminToken');
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);

    async function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      await refreshDashboard();
    }

    // ===========================================
    // NAVIGATION
    // ===========================================
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const page = item.dataset.page;
        if (page) {
          showPage(page);
        }
        // Close mobile menu
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.classList.remove('open');
        }
      });
    });

    function showPage(pageName) {
      // Remove active from all pages and nav items
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      // Find and activate the target page
      const targetPage = document.getElementById(`page-${pageName}`);
      if (targetPage) {
        targetPage.classList.add('active');
      } else {
        console.error('Page not found:', pageName);
        return;
      }
      
      // Activate the nav item
      const navItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }

      // Load page data
      if (pageName === 'bookings') loadBookings();
      if (pageName === 'calendar') renderCalendar();
      if (pageName === 'clients') loadClients();
      if (pageName === 'invitations') loadInvitationCodes();
      if (pageName === 'inquiries') loadInquiries();
      if (pageName === 'marketing') loadMarketing();
      if (pageName === 'content') loadContent();
      if (pageName === 'settings') loadSettings();
      if (pageName === 'export') loadBackupStats();
    }

    // Mobile menu
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    
    if (mobileMenuBtn && sidebar) {
      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
      });
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        const parent = tab.closest('section');
        
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
      });
    });

    // ===========================================
    // DASHBOARD
    // ===========================================
    async function refreshDashboard() {
      showLoading(true);
      const data = await api('/api/admin/dashboard');
      showLoading(false);
      
      if (!data) return;

      const { stats, recentBookings } = data;

      // Load inquiries count for badge
      inquiries = await api('/api/admin/inquiries') || [];
      updateInquiriesBadge();

      // Render stats
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card warning">
          <div class="stat-label">Pending</div>
          <div class="stat-value">${stats.pending}</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Confirmed</div>
          <div class="stat-value">${stats.confirmed}</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Completed</div>
          <div class="stat-value">${stats.completed}</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-label">This Month</div>
          <div class="stat-value">$${stats.revenueThisMonth}</div>
          ${stats.revenueLastMonth > 0 ? `
            <div class="stat-change ${stats.revenueThisMonth >= stats.revenueLastMonth ? 'positive' : 'negative'}">
              ${stats.revenueThisMonth >= stats.revenueLastMonth ? '‚Üë' : '‚Üì'} vs last month
            </div>
          ` : ''}
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value">$${stats.totalRevenue}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Clients</div>
          <div class="stat-value">${stats.totalClients}</div>
          <div class="stat-change">${stats.repeatClients} repeat</div>
        </div>
      `;

      // Render recent bookings
      document.getElementById('recentBookingsTable').innerHTML = recentBookings.map(b => `
        <tr>
          <td>${new Date(b.createdAt).toLocaleDateString()}</td>
          <td>${b.name}</td>
          <td>${b.serviceName}</td>
          <td><span class="badge badge-${b.status}">${b.status}</span></td>
          <td>
            <button class="action-btn" onclick="viewBooking('${b.id}')">View</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="empty-state">No bookings yet</td></tr>';
    }

    // ===========================================
    // BOOKINGS
    // ===========================================
    async function loadBookings() {
      showLoading(true);
      bookings = await api('/api/admin/bookings') || [];
      showLoading(false);
      renderBookings();
    }

    function renderBookings() {
      const search = document.getElementById('bookingSearch').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;

      let filtered = bookings;
      if (search) {
        filtered = filtered.filter(b => 
          b.name.toLowerCase().includes(search) ||
          b.email.toLowerCase().includes(search) ||
          b.phone.includes(search)
        );
      }
      if (status) {
        filtered = filtered.filter(b => b.status === status);
      }

      document.getElementById('bookingsTable').innerHTML = filtered.map(b => `
        <tr>
          <td>${new Date(b.createdAt).toLocaleDateString()}</td>
          <td><strong>${b.name}</strong></td>
          <td>
            <div>${b.email}</div>
            <small style="color: var(--soft-gray);">${b.phone}</small>
          </td>
          <td>${b.serviceName}</td>
          <td>$${b.servicePrice}</td>
          <td><span class="badge badge-${b.status}">${b.status}</span></td>
          <td>${b.confirmedDate ? `${b.confirmedDate} ${b.confirmedTime || ''}` : b.proposedDate ? `<span style="color: var(--gold);">üìß Proposed: ${b.proposedDate}</span>` : '-'}</td>
          <td>
            <div class="quick-actions">
              <button class="action-btn" onclick="viewBooking('${b.id}')" title="View Details">üëÅÔ∏è</button>
              <button class="action-btn" onclick="openBookingMessageModal('${b.id}')" title="Send Message">üí¨</button>
              ${b.status === 'pending' && !b.proposedDate ? `
                <button class="action-btn" onclick="openProposeTimeModal('${b.id}')" title="Propose Time" style="background: var(--gold);">üìÖ</button>
              ` : ''}
              ${b.status === 'pending' && b.proposedDate ? `
                <button class="action-btn" onclick="openProposeTimeModal('${b.id}')" title="Change Proposed Time" style="background: var(--warning);">üîÑ</button>
              ` : ''}
              ${b.status === 'pending' ? `
                <button class="action-btn" onclick="quickConfirm('${b.id}')" title="Confirm">‚úì</button>
              ` : ''}
              ${b.status === 'confirmed' ? `
                <button class="action-btn" onclick="sendReminder('${b.id}')" title="Send Reminder">üìß</button>
              ` : ''}
              ${b.status === 'completed' && !b.aftercareSent ? `
                <button class="action-btn" onclick="sendAftercare('${b.id}')" title="Send Aftercare Email">üíù</button>
              ` : ''}
              ${b.aftercareSent ? `<span title="Aftercare sent" style="opacity:0.5;">üíù</span>` : ''}
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="8" class="empty-state">No bookings found</td></tr>';
    }

    // Search and filter listeners
    document.getElementById('bookingSearch').addEventListener('input', renderBookings);
    document.getElementById('statusFilter').addEventListener('change', renderBookings);

    async function viewBooking(id) {
      showLoading(true);
      const booking = await api(`/api/admin/bookings/${id}`);
      showLoading(false);
      
      if (!booking) return;

      document.getElementById('bookingModalBody').innerHTML = `
        <div class="detail-grid">
          <div>
            <div class="detail-item">
              <div class="detail-label">Client Name</div>
              <div class="detail-value">${booking.name}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${booking.email}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value">${booking.phone} ${booking.textPermission ? '(Text OK)' : ''}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Gender</div>
              <div class="detail-value">${booking.gender || 'Not specified'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Pronouns</div>
              <div class="detail-value">${booking.pronouns || 'Not specified'}</div>
            </div>
          </div>
          <div>
            <div class="detail-item">
              <div class="detail-label">Service</div>
              <div class="detail-value">${booking.serviceName}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Price</div>
              <div class="detail-value">$${booking.servicePrice}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value"><span class="badge badge-${booking.status}">${booking.status}</span></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Submitted</div>
              <div class="detail-value">${new Date(booking.createdAt).toLocaleString()}</div>
            </div>
          </div>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">

        <div class="detail-item">
          <div class="detail-label">Availability</div>
          <div class="detail-value">${booking.availability || 'Not specified'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Intentions</div>
          <div class="detail-value">${booking.intentions || 'Not provided'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Concerns</div>
          <div class="detail-value">${booking.concerns || 'None'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Health/Trauma Notes</div>
          <div class="detail-value">${booking.healthNotes || 'Prefer to discuss in person'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Sensory Sensitivities</div>
          <div class="detail-value">${booking.sensitivities || 'None noted'}</div>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">

        ${booking.status !== 'cancelled' ? `
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Confirmed Date</label>
              <input type="date" class="form-input" id="modalConfirmedDate" value="${booking.confirmedDate || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Confirmed Time</label>
              <input type="time" class="form-input" id="modalConfirmedTime" value="${booking.confirmedTime || ''}">
            </div>
          </div>
        ` : ''}

        <div class="form-group">
          <label class="form-label">Admin Notes</label>
          <textarea class="form-textarea" id="modalNotes" rows="3">${booking.notes || ''}</textarea>
        </div>

        ${booking.status === 'completed' ? `
          <div class="form-group">
            <label class="form-label">Session Notes (private)</label>
            <textarea class="form-textarea" id="modalSessionNotes" rows="3">${booking.sessionNotes || ''}</textarea>
          </div>
        ` : ''}
      `;

      document.getElementById('bookingModalFooter').innerHTML = `
        <button class="btn btn-outline" onclick="openEmailModal('${booking.id}', '${booking.email}', '${booking.name}')">üìß Email Client</button>
        ${booking.status === 'pending' ? `
          <button class="btn btn-success" onclick="updateBookingStatus('${booking.id}', 'confirmed')">‚úì Confirm</button>
        ` : ''}
        ${booking.status === 'confirmed' ? `
          <button class="btn btn-success" onclick="updateBookingStatus('${booking.id}', 'completed')">‚úì Mark Complete</button>
        ` : ''}
        ${booking.status !== 'cancelled' && booking.status !== 'completed' ? `
          <button class="btn btn-danger" onclick="updateBookingStatus('${booking.id}', 'cancelled')">‚úó Cancel</button>
        ` : ''}
        <button class="btn btn-primary" onclick="saveBookingDetails('${booking.id}')">Save Changes</button>
      `;

      openModal('bookingModal');
    }

    async function saveBookingDetails(id) {
      const confirmedDate = document.getElementById('modalConfirmedDate')?.value;
      const confirmedTime = document.getElementById('modalConfirmedTime')?.value;
      const notes = document.getElementById('modalNotes').value;
      const sessionNotes = document.getElementById('modalSessionNotes')?.value;

      showLoading(true);
      const result = await api(`/api/admin/bookings/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ confirmedDate, confirmedTime, notes, sessionNotes })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Changes saved!', 'success');
        closeModal('bookingModal');
        loadBookings();
        refreshDashboard();
      }
    }

    async function updateBookingStatus(id, status) {
      // If confirming, also get the date/time from the modal fields
      let confirmedDate = document.getElementById('modalConfirmedDate')?.value;
      let confirmedTime = document.getElementById('modalConfirmedTime')?.value;
      
      // If confirming without a date, prompt for one
      if (status === 'confirmed' && !confirmedDate) {
        confirmedDate = prompt('Enter confirmed date (YYYY-MM-DD):');
        if (!confirmedDate) {
          showToast('Date is required to confirm booking', 'error');
          return;
        }
        confirmedTime = prompt('Enter confirmed time (e.g., 14:00):', '14:00') || '';
      }
      
      const sendConfirmation = status === 'confirmed' && confirm('Send confirmation email to client?');
      
      const payload = { status, sendConfirmation };
      if (status === 'confirmed') {
        payload.confirmedDate = confirmedDate;
        payload.confirmedTime = confirmedTime;
      }
      
      showLoading(true);
      const result = await api(`/api/admin/bookings/${id}`, {
        method: 'PATCH',
        body: JSON.stringify(payload)
      });
      showLoading(false);

      if (result?.success) {
        showToast(`Booking ${status}!`, 'success');
        closeModal('bookingModal');
        loadBookings();
        refreshDashboard();
      }
    }

    async function quickConfirm(id) {
      if (!confirm('Confirm this booking?')) return;
      await updateBookingStatus(id, 'confirmed');
    }

    async function sendReminder(id) {
      showLoading(true);
      const result = await api(`/api/admin/send-reminder/${id}`, { method: 'POST' });
      showLoading(false);
      
      if (result?.success) {
        showToast('Reminder sent!', 'success');
      }
    }

    // ===========================================
    // CALENDAR
    // ===========================================
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      renderCalendar();
    });

    document.getElementById('todayBtn').addEventListener('click', () => {
      currentCalendarDate = new Date();
      renderCalendar();
    });

    async function renderCalendar() {
      showLoading(true);
      const data = await api('/api/admin/calendar');
      showLoading(false);
      
      if (!data) return;

      const { events, blockedDates } = data;
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();

      document.getElementById('calendarTitle').textContent = 
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date().toDateString();

      let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
        .map(d => `<div class="calendar-day-header">${d}</div>`).join('');

      // Previous month padding
      const prevMonthDays = new Date(year, month, 0).getDate();
      for (let i = firstDay - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${prevMonthDays - i}</div>`;
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dateObj = new Date(year, month, day);
        const isToday = dateObj.toDateString() === today;
        const isBlocked = blockedDates.some(b => b.date === dateStr);
        const dayEvents = events.filter(e => e.date === dateStr);

        let classes = ['calendar-day'];
        if (isToday) classes.push('today');
        if (isBlocked) classes.push('blocked');
        if (dayEvents.length) classes.push('has-event');

        html += `
          <div class="${classes.join(' ')}" onclick="${isBlocked ? '' : `calendarDayClick('${dateStr}')`}">
            <div>${day}</div>
            ${dayEvents.slice(0, 2).map(e => `<div class="calendar-event ${e.status}">${e.time || ''} ${e.clientName}${e.status === 'pending' ? ' (?)' : ''}</div>`).join('')}
            ${dayEvents.length > 2 ? `<div style="font-size: 10px; color: var(--soft-gray);">+${dayEvents.length - 2} more</div>` : ''}
          </div>
        `;
      }

      // Next month padding
      const totalCells = firstDay + daysInMonth;
      const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }

      document.getElementById('calendarGrid').innerHTML = html;

      // Upcoming sessions list
      const upcoming = events
        .filter(e => new Date(e.date) >= new Date())
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 5);

      document.getElementById('upcomingList').innerHTML = upcoming.length ? upcoming.map(e => `
        <div class="client-card" onclick="viewBooking('${e.id}')">
          <div class="client-avatar">${e.clientName.charAt(0)}</div>
          <div class="client-info">
            <h4>${e.clientName}</h4>
            <p>${e.service}</p>
          </div>
          <div class="client-stats">
            <div class="sessions">${new Date(e.date).toLocaleDateString()}</div>
            <div>${e.time || 'TBD'}</div>
          </div>
        </div>
      `).join('') : '<div class="empty-state">No upcoming sessions</div>';
    }

    function calendarDayClick(date) {
      // Could open a modal to schedule on this date
      alert(`Selected: ${date}\n\nTo schedule a session, go to Bookings and set the confirmed date.`);
    }

    // ===========================================
    // CLIENTS
    // ===========================================
    async function loadClients() {
      showLoading(true);
      clients = await api('/api/admin/clients') || [];
      showLoading(false);
      renderClients();
    }

    function renderClients() {
      const search = document.getElementById('clientSearch').value.toLowerCase();
      let filtered = clients;
      
      if (search) {
        filtered = clients.filter(c =>
          c.name.toLowerCase().includes(search) ||
          c.email.toLowerCase().includes(search) ||
          c.phone?.includes(search)
        );
      }

      document.getElementById('totalClientsCount').textContent = clients.length;
      document.getElementById('repeatClientsCount').textContent = clients.filter(c => c.totalSessions > 1).length;

      document.getElementById('clientsList').innerHTML = filtered.length ? filtered.map(c => `
        <div class="client-card">
          <div class="client-avatar" onclick="viewClient('${c.id}')">${c.name.charAt(0)}</div>
          <div class="client-info" onclick="viewClient('${c.id}')" style="cursor: pointer;">
            <h4>${c.name}</h4>
            <p>${c.email}</p>
          </div>
          <div class="client-stats">
            <div class="sessions">${c.totalSessions || 0} sessions</div>
            ${c.totalSpent ? `<div class="spent">$${c.totalSpent} total</div>` : ''}
          </div>
          <button class="btn btn-sm btn-outline" onclick="openClientDirectMessageModal('${c.id}')" style="margin-left: auto;">üí¨ Message</button>
        </div>
      `).join('') : '<div class="empty-state"><div class="empty-state-icon">üë•</div><h3>No clients yet</h3><p>Clients will appear here after their first booking</p></div>';
    }

    document.getElementById('clientSearch').addEventListener('input', renderClients);

    async function viewClient(id) {
      showLoading(true);
      const client = await api(`/api/admin/clients/${id}`);
      showLoading(false);
      
      if (!client) return;

      document.getElementById('clientModalBody').innerHTML = `
        <div class="detail-item">
          <div class="detail-label">Name</div>
          <div class="detail-value">${client.name}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Email</div>
          <div class="detail-value">${client.email}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Phone</div>
          <div class="detail-value">${client.phone || 'N/A'}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Total Sessions</div>
          <div class="detail-value">${client.totalSessions || 0}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">Total Spent</div>
          <div class="detail-value">$${client.totalSpent || 0}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">First Contact</div>
          <div class="detail-value">${new Date(client.createdAt).toLocaleDateString()}</div>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">

        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="clientNotes" rows="4" onchange="updateClientNotes('${client.id}')">${client.notes || ''}</textarea>
        </div>

        <h4 style="margin: 20px 0 12px;">Session History</h4>
        ${client.sessions?.length ? client.sessions.map(s => `
          <div style="padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px;">
            <strong>${s.service}</strong> - $${s.price || 0}
            <br><small style="color: var(--soft-gray);">${s.date ? new Date(s.date).toLocaleDateString() : 'Date TBD'} ‚Ä¢ ${s.status}</small>
          </div>
        `).join('') : '<p style="color: var(--soft-gray);">No sessions yet</p>'}
      `;

      openModal('clientModal');
    }

    async function updateClientNotes(id) {
      const notes = document.getElementById('clientNotes').value;
      await api(`/api/admin/clients/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ notes })
      });
    }

    // ===========================================
    // INVITATION CODES
    // ===========================================
    async function loadInvitationCodes() {
      showLoading(true);
      invitationCodes = await api('/api/admin/invitation-codes') || [];
      showLoading(false);
      renderInvitationCodes();
    }

    function filterCodes(filter) {
      codeFilter = filter;
      document.querySelectorAll('#page-invitations .tabs .tab').forEach((tab, i) => {
        tab.classList.toggle('active', 
          (filter === 'all' && i === 0) || 
          (filter === 'available' && i === 1) || 
          (filter === 'used' && i === 2)
        );
      });
      renderInvitationCodes();
    }

    function renderInvitationCodes() {
      let filtered = [...invitationCodes].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      if (codeFilter === 'available') {
        filtered = filtered.filter(c => c.active && !c.usedBy);
      } else if (codeFilter === 'used') {
        filtered = filtered.filter(c => c.usedBy);
      }
      
      // Update stats
      document.getElementById('totalCodesCount').textContent = invitationCodes.length;
      document.getElementById('availableCodesCount').textContent = invitationCodes.filter(c => c.active && !c.usedBy).length;
      document.getElementById('usedCodesCount').textContent = invitationCodes.filter(c => c.usedBy).length;

      document.getElementById('invitationCodesTable').innerHTML = filtered.map(c => {
        const isExpired = c.expiresAt && new Date(c.expiresAt) < new Date();
        const status = c.usedBy ? 'used' : (!c.active || isExpired) ? 'expired' : 'available';
        const statusBadge = {
          used: '<span class="badge badge-confirmed">Used</span>',
          expired: '<span class="badge badge-cancelled">Expired</span>',
          available: '<span class="badge badge-pending" style="background: #e8f5e9; color: #2e7d32;">Available</span>'
        };

        return `
          <tr>
            <td>
              <code style="background: #f5f0eb; padding: 6px 12px; border-radius: 4px; font-weight: 600; letter-spacing: 1px; font-size: 14px;">
                ${c.code}
              </code>
              <button onclick="copyCode('${c.code}')" class="btn" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" title="Copy">üìã</button>
            </td>
            <td>${c.label || '-'}</td>
            <td>${new Date(c.createdAt).toLocaleDateString()}</td>
            <td>${statusBadge[status]}</td>
            <td>${c.usedBy ? `<span style="color: var(--burgundy);">${c.usedBy}</span><br><small style="color: var(--soft-gray);">${new Date(c.usedAt).toLocaleDateString()}</small>` : '-'}</td>
            <td>
              ${status === 'available' ? `
                <button class="action-btn" onclick="deactivateCode('${c.id}')" title="Deactivate">üóëÔ∏è</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="6" class="empty-state">No invitation codes yet. Generate some!</td></tr>';
    }

    function copyCode(code) {
      navigator.clipboard.writeText(code);
      showToast('Code copied: ' + code, 'success');
    }

    function openGenerateCodesModal() {
      document.getElementById('codeCount').value = '10';
      document.getElementById('codePrefix').value = '';
      document.getElementById('codeLabel').value = '';
      document.getElementById('codeExpiry').value = '90';
      openModal('generateCodesModal');
    }

    async function generateCodes() {
      const count = parseInt(document.getElementById('codeCount').value);
      const prefix = document.getElementById('codePrefix').value || null;
      const label = document.getElementById('codeLabel').value || null;
      const expiresInDays = parseInt(document.getElementById('codeExpiry').value) || null;

      showLoading(true);
      const result = await api('/api/admin/invitation-codes/generate', {
        method: 'POST',
        body: JSON.stringify({ count, prefix, label, expiresInDays })
      });
      showLoading(false);

      if (result?.success) {
        showToast(`‚ú® Generated ${result.codes.length} invitation code(s)!`, 'success');
        closeModal('generateCodesModal');
        loadInvitationCodes();
      } else {
        showToast(result?.error || 'Failed to generate codes', 'error');
      }
    }

    async function deactivateCode(id) {
      if (!confirm('Deactivate this invitation code?')) return;

      showLoading(true);
      const result = await api(`/api/admin/invitation-codes/${id}`, { method: 'DELETE' });
      showLoading(false);

      if (result?.success) {
        showToast('Code deactivated', 'success');
        loadInvitationCodes();
      }
    }

    function printCodes() {
      const available = invitationCodes.filter(c => c.active && !c.usedBy);
      if (available.length === 0) {
        showToast('No available codes to print', 'error');
        return;
      }

      document.getElementById('printPreview').style.display = 'block';
      document.getElementById('printableCards').innerHTML = available.map(c => `
        <div class="business-card">
          <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 12px;">ü™∑</div>
            <div style="font-family: Georgia, serif; color: #722F37; font-size: 22px; font-weight: 600; margin-bottom: 6px;">Ravi</div>
            <div style="font-size: 14px; color: #483434; margin-bottom: 24px; font-style: italic;">Intuitive Healer & Sensual Bodyworker</div>
            
            <div style="border-top: 2px solid #D4AF37; border-bottom: 2px solid #D4AF37; padding: 16px 0; margin: 20px 0;">
              <div style="font-size: 11px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1.5px;">Your Private Invitation Code</div>
              <div style="background: linear-gradient(135deg, #722F37 0%, #5a2429 100%); color: white; padding: 14px 24px; border-radius: 8px; font-size: 24px; letter-spacing: 4px; font-weight: 700; font-family: 'Courier New', monospace; box-shadow: 0 4px 8px rgba(114, 47, 55, 0.3);">
                ${c.code}
              </div>
            </div>
            
            <div style="margin-top: 20px; font-size: 13px; color: #666;">
              <div style="margin-bottom: 8px;">
                <strong style="color: #722F37;">Book Your Session:</strong><br>
                <span style="font-size: 12px;">localhost:3000</span>
              </div>
              ${c.label ? `<div style="font-size: 10px; color: #999; margin-top: 12px; font-style: italic;">${c.label}</div>` : ''}
              ${c.expiresAt ? `<div style="font-size: 10px; color: #999; margin-top: 8px;">Valid until: ${new Date(c.expiresAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>` : ''}
            </div>
          </div>
        </div>
      `).join('');

      // Scroll to preview
      document.getElementById('printPreview').scrollIntoView({ behavior: 'smooth' });
      
      // Open print dialog after a short delay
      setTimeout(() => {
        if (confirm('Open print dialog? (You can also right-click to print later)')) {
          window.print();
        }
      }, 500);
    }

    // ===========================================
    // INQUIRIES
    // ===========================================
    async function loadInquiries() {
      showLoading(true);
      inquiries = await api('/api/admin/inquiries') || [];
      showLoading(false);
      renderInquiries();
      updateInquiriesBadge();
    }

    function updateInquiriesBadge() {
      const newCount = inquiries.filter(i => i.status === 'new').length;
      const badge = document.getElementById('inquiriesBadge');
      if (newCount > 0) {
        badge.textContent = newCount;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderInquiries() {
      const newCount = inquiries.filter(i => i.status === 'new').length;
      const invitedCount = inquiries.filter(i => i.status === 'invited').length;
      
      document.getElementById('newInquiriesCount').textContent = newCount;
      document.getElementById('invitedInquiriesCount').textContent = invitedCount;
      document.getElementById('totalInquiriesCount').textContent = inquiries.length;

      const sorted = [...inquiries].sort((a, b) => {
        // New first, then by date
        if (a.status === 'new' && b.status !== 'new') return -1;
        if (b.status === 'new' && a.status !== 'new') return 1;
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      document.getElementById('inquiriesList').innerHTML = sorted.length ? sorted.map(i => {
        const statusBadge = {
          new: '<span class="badge" style="background: var(--gold); color: white;">New</span>',
          reviewed: '<span class="badge badge-pending">Reviewed</span>',
          invited: '<span class="badge badge-confirmed">Invited</span>',
          declined: '<span class="badge badge-cancelled">Declined</span>'
        };

        return `
          <div class="content-item" style="border-left: 4px solid ${i.status === 'new' ? 'var(--gold)' : i.status === 'invited' ? 'var(--success)' : '#e0d6cc'};">
            <div class="content-item-header">
              <div>
                <h4 style="margin-bottom: 4px;">${i.name}</h4>
                <div style="font-size: 13px; color: var(--soft-gray);">
                  ${i.email} ${i.phone ? `‚Ä¢ ${i.phone}` : ''}
                </div>
                <div style="font-size: 12px; color: var(--soft-gray); margin-top: 4px;">
                  ${new Date(i.createdAt).toLocaleDateString()} at ${new Date(i.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
              </div>
              <div style="text-align: right;">
                ${statusBadge[i.status]}
                ${i.invitationCode ? `<div style="font-size: 12px; margin-top: 4px; color: var(--burgundy);"><code>${i.invitationCode}</code></div>` : ''}
              </div>
            </div>
            <div style="background: #f8f5f0; padding: 12px; border-radius: 8px; margin: 12px 0; font-style: italic; color: var(--charcoal);">
              "${i.message}"
            </div>
            <div class="content-item-actions" style="justify-content: flex-start; gap: 8px;">
              ${i.status === 'new' ? `
                <button class="btn btn-sm btn-primary" onclick="sendInvitationToInquiry('${i.id}')" style="background: var(--gold);">
                  üéüÔ∏è Send Invitation
                </button>
                <button class="btn btn-sm btn-outline" onclick="markInquiryReviewed('${i.id}')">
                  Mark Reviewed
                </button>
              ` : ''}
              ${i.status === 'reviewed' ? `
                <button class="btn btn-sm btn-primary" onclick="sendInvitationToInquiry('${i.id}')" style="background: var(--gold);">
                  üéüÔ∏è Send Invitation
                </button>
              ` : ''}
              ${i.status === 'invited' ? `
                <span style="color: var(--success); font-size: 13px;">‚úì Invitation sent</span>
              ` : ''}
              <button class="btn btn-sm btn-outline" onclick="emailInquiry('${i.id}')" style="margin-left: auto;">
                üìß Email
              </button>
            </div>
          </div>
        `;
      }).join('') : '<p style="text-align: center; color: var(--soft-gray); padding: 40px;">No inquiries yet. They will appear here when visitors contact you through the site.</p>';
    }

    async function markInquiryReviewed(id) {
      showLoading(true);
      const result = await api(`/api/admin/inquiries/${id}/status`, {
        method: 'PATCH',
        body: JSON.stringify({ status: 'reviewed' })
      });
      showLoading(false);

      if (result?.success) {
        loadInquiries();
      }
    }

    async function sendInvitationToInquiry(id) {
      const inquiry = inquiries.find(i => i.id === id);
      if (!inquiry) return;

      if (!confirm(`Send an invitation code to ${inquiry.name} (${inquiry.email})?`)) return;

      showLoading(true);
      const result = await api(`/api/admin/inquiries/${id}/invite`, { method: 'POST' });
      showLoading(false);

      if (result?.success) {
        showToast(`‚ú® Invitation sent to ${inquiry.name}!`, 'success');
        loadInquiries();
      } else {
        showToast(result?.error || 'Failed to send invitation', 'error');
      }
    }

    function emailInquiry(id) {
      const inquiry = inquiries.find(i => i.id === id);
      if (inquiry) {
        window.open(`mailto:${inquiry.email}?subject=Re: Your Inquiry - Ravi Sacred Healing`);
      }
    }

    // ===========================================
    // CONTENT MANAGEMENT
    // ===========================================
    async function loadContent() {
      showLoading(true);
      content = await api('/api/admin/content') || {};
      showLoading(false);
      renderContent();
      loadPendingTestimonials();
    }

    async function loadPendingTestimonials() {
      const pending = await api('/api/admin/testimonials/pending') || [];
      const badge = document.getElementById('pendingBadge');
      if (pending.length > 0) {
        badge.textContent = pending.length;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
      renderPendingTestimonials(pending);
    }

    function renderPendingTestimonials(pending) {
      const container = document.getElementById('pendingTestimonialsList');
      if (!pending || pending.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--soft-gray); padding: 40px;">No pending testimonials</p>';
        return;
      }

      container.innerHTML = pending.map(t => `
        <div class="content-item" style="border-left: 4px solid var(--gold);">
          <div class="content-item-header">
            <h4>${t.displayName}</h4>
            <div class="content-item-actions">
              <span style="color: var(--soft-gray); font-size: 12px;">${new Date(t.submittedAt).toLocaleDateString()}</span>
              <button class="btn btn-sm btn-primary" onclick="reviewPendingTestimonial('${t.id}')">Review</button>
            </div>
          </div>
          <p style="font-style: italic;">"${t.text.substring(0, 200)}${t.text.length > 200 ? '...' : ''}"</p>
          ${t.email ? `<p style="font-size: 12px; color: var(--soft-gray);">üìß ${t.email}</p>` : ''}
        </div>
      `).join('');
    }

    function reviewPendingTestimonial(id) {
      const pending = content.pendingTestimonials?.find(t => t.id === id);
      if (!pending) {
        // Reload and try again
        loadPendingTestimonials();
        return;
      }
      document.getElementById('pendingTestimonialId').value = id;
      document.getElementById('pendingTestimonialAuthor').textContent = pending.displayName;
      document.getElementById('pendingTestimonialMeta').innerHTML = `
        ${pending.email ? `üìß ${pending.email}<br>` : ''}
        ${pending.sessionType ? `Session: ${pending.sessionType}<br>` : ''}
        Submitted: ${new Date(pending.submittedAt).toLocaleString()}
        ${pending.featured ? '<br>‚≠ê Willing to be featured' : ''}
      `;
      document.getElementById('pendingTestimonialText').textContent = pending.text;
      openModal('pendingTestimonialModal');
    }

    async function approvePendingTestimonial() {
      const id = document.getElementById('pendingTestimonialId').value;
      showLoading(true);
      const result = await api(`/api/admin/testimonials/${id}/approve`, { method: 'POST' });
      showLoading(false);
      if (result?.success) {
        showToast('Testimonial approved and published!', 'success');
        closeModal('pendingTestimonialModal');
        loadContent();
      } else {
        showToast('Failed to approve testimonial', 'error');
      }
    }

    async function rejectPendingTestimonial() {
      const id = document.getElementById('pendingTestimonialId').value;
      if (!confirm('Are you sure you want to reject this testimonial?')) return;
      
      showLoading(true);
      const result = await api(`/api/admin/testimonials/${id}/reject`, { method: 'POST' });
      showLoading(false);
      if (result?.success) {
        showToast('Testimonial rejected', 'info');
        closeModal('pendingTestimonialModal');
        loadContent();
      } else {
        showToast('Failed to reject testimonial', 'error');
      }
    }

    function renderContent() {
      // Testimonials
      document.getElementById('testimonialsList').innerHTML = content.testimonials?.length ? 
        content.testimonials.map(t => `
          <div class="content-item ${t.active ? '' : 'inactive'}">
            <div class="content-item-header">
              <h4>${t.author} ${t.featured ? '‚≠ê' : ''}</h4>
              <div class="content-item-actions">
                <button class="action-btn" onclick="editTestimonial('${t.id}')">Edit</button>
                <button class="action-btn" onclick="toggleTestimonial('${t.id}', ${!t.active})">${t.active ? 'Hide' : 'Show'}</button>
                <button class="action-btn" onclick="deleteTestimonial('${t.id}')" style="color: var(--danger);">Delete</button>
              </div>
            </div>
            <p>${t.text.substring(0, 200)}${t.text.length > 200 ? '...' : ''}</p>
          </div>
        `).join('') : '<div class="empty-state">No testimonials</div>';

      // Store pending for review modal
      content.pendingTestimonials = content.pendingTestimonials || [];

      // FAQs
      document.getElementById('faqsList').innerHTML = content.faqs?.length ?
        content.faqs.sort((a, b) => a.order - b.order).map(f => `
          <div class="content-item ${f.active ? '' : 'inactive'}">
            <div class="content-item-header">
              <h4>${f.question}</h4>
              <div class="content-item-actions">
                <button class="action-btn" onclick="editFaq('${f.id}')">Edit</button>
                <button class="action-btn" onclick="toggleFaq('${f.id}', ${!f.active})">${f.active ? 'Hide' : 'Show'}</button>
                <button class="action-btn" onclick="deleteFaq('${f.id}')" style="color: var(--danger);">Delete</button>
              </div>
            </div>
            <p>${f.answer.substring(0, 150)}${f.answer.length > 150 ? '...' : ''}</p>
          </div>
        `).join('') : '<div class="empty-state">No FAQs</div>';

      // Site settings
      if (content.siteSettings) {
        document.getElementById('siteName').value = content.siteSettings.siteName || '';
        document.getElementById('siteTagline').value = content.siteSettings.tagline || '';
        document.getElementById('siteEmail').value = content.siteSettings.email || '';
        document.getElementById('siteLocation').value = content.siteSettings.location || '';
        document.getElementById('maintenanceMode').checked = content.siteSettings.maintenanceMode || false;
      }
    }

    // Testimonials
    function openTestimonialModal(id = null) {
      document.getElementById('testimonialId').value = id || '';
      document.getElementById('testimonialModalTitle').textContent = id ? 'Edit Testimonial' : 'Add Testimonial';
      
      if (id) {
        const t = content.testimonials.find(x => x.id === id);
        document.getElementById('testimonialAuthor').value = t.author;
        document.getElementById('testimonialText').value = t.text;
        document.getElementById('testimonialFeatured').checked = t.featured;
      } else {
        document.getElementById('testimonialForm').reset();
      }
      
      openModal('testimonialModal');
    }

    function editTestimonial(id) { openTestimonialModal(id); }

    async function saveTestimonial() {
      const id = document.getElementById('testimonialId').value;
      const author = document.getElementById('testimonialAuthor').value;
      const text = document.getElementById('testimonialText').value;
      const featured = document.getElementById('testimonialFeatured').checked;

      showLoading(true);
      const result = id ?
        await api(`/api/admin/testimonials/${id}`, { method: 'PATCH', body: JSON.stringify({ author, text, featured }) }) :
        await api('/api/admin/testimonials', { method: 'POST', body: JSON.stringify({ author, text, featured }) });
      showLoading(false);

      if (result?.success) {
        showToast('Testimonial saved!', 'success');
        closeModal('testimonialModal');
        loadContent();
      }
    }

    async function toggleTestimonial(id, active) {
      await api(`/api/admin/testimonials/${id}`, { method: 'PATCH', body: JSON.stringify({ active }) });
      loadContent();
    }

    async function deleteTestimonial(id) {
      if (!confirm('Delete this testimonial?')) return;
      await api(`/api/admin/testimonials/${id}`, { method: 'DELETE' });
      showToast('Testimonial deleted', 'success');
      loadContent();
    }

    // FAQs
    function openFaqModal(id = null) {
      document.getElementById('faqId').value = id || '';
      document.getElementById('faqModalTitle').textContent = id ? 'Edit FAQ' : 'Add FAQ';
      
      if (id) {
        const f = content.faqs.find(x => x.id === id);
        document.getElementById('faqQuestion').value = f.question;
        document.getElementById('faqAnswer').value = f.answer;
      } else {
        document.getElementById('faqForm').reset();
      }
      
      openModal('faqModal');
    }

    function editFaq(id) { openFaqModal(id); }

    async function saveFaq() {
      const id = document.getElementById('faqId').value;
      const question = document.getElementById('faqQuestion').value;
      const answer = document.getElementById('faqAnswer').value;

      showLoading(true);
      const result = id ?
        await api(`/api/admin/faqs/${id}`, { method: 'PATCH', body: JSON.stringify({ question, answer }) }) :
        await api('/api/admin/faqs', { method: 'POST', body: JSON.stringify({ question, answer }) });
      showLoading(false);

      if (result?.success) {
        showToast('FAQ saved!', 'success');
        closeModal('faqModal');
        loadContent();
      }
    }

    async function toggleFaq(id, active) {
      await api(`/api/admin/faqs/${id}`, { method: 'PATCH', body: JSON.stringify({ active }) });
      loadContent();
    }

    async function deleteFaq(id) {
      if (!confirm('Delete this FAQ?')) return;
      await api(`/api/admin/faqs/${id}`, { method: 'DELETE' });
      showToast('FAQ deleted', 'success');
      loadContent();
    }

    // Site settings form
    document.getElementById('siteSettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const siteSettings = {
        siteName: document.getElementById('siteName').value,
        tagline: document.getElementById('siteTagline').value,
        email: document.getElementById('siteEmail').value,
        location: document.getElementById('siteLocation').value,
        maintenanceMode: document.getElementById('maintenanceMode').checked
      };

      showLoading(true);
      const result = await api('/api/admin/content', {
        method: 'PUT',
        body: JSON.stringify({ siteSettings })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Settings saved!', 'success');
      }
    });

    // ===========================================
    // SETTINGS
    // ===========================================
    async function loadSettings() {
      showLoading(true);
      settings = await api('/api/admin/settings') || {};
      showLoading(false);
      renderSettings();
    }

    function renderSettings() {
      // Services
      document.getElementById('servicesList').innerHTML = settings.services?.map((s, index) => `
        <div class="content-item ${s.active ? '' : 'inactive'}">
          <div class="content-item-header">
            <h4>${s.name}</h4>
            <div class="content-item-actions">
              <button class="action-btn" onclick="editService(${index})" title="Edit">‚úèÔ∏è</button>
              <button class="action-btn" onclick="toggleServiceActive(${index})" title="${s.active ? 'Hide' : 'Show'}">${s.active ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}</button>
              <button class="action-btn" onclick="deleteService(${index})" title="Delete" style="color: #dc3545;">üóëÔ∏è</button>
            </div>
          </div>
          <p style="margin-bottom: 8px;">${s.description || ''}</p>
          <div style="display: flex; gap: 16px; font-size: 14px; color: var(--soft-gray);">
            <span style="font-weight: 600; color: var(--burgundy);">$${s.price}</span>
            <span>${s.duration} min</span>
          </div>
        </div>
      `).join('') || '<p>No services configured</p>';

      // Render Calendly-style availability interface
      renderWeeklyAvailability();

      // Blocked dates
      document.getElementById('blockedDatesList').innerHTML = settings.blockedDates?.length ?
        settings.blockedDates.map(b => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px;">
            <div>
              <strong>${new Date(b.date).toLocaleDateString()}</strong>
              ${b.reason ? `<span style="color: var(--soft-gray);"> - ${b.reason}</span>` : ''}
            </div>
            <button class="action-btn" onclick="unblockDate('${b.date}')" style="color: var(--danger);">Remove</button>
          </div>
        `).join('') : '<p style="color: var(--soft-gray);">No blocked dates</p>';

      // Email settings
      document.getElementById('emailNotifications').checked = settings.emailNotifications !== false;
      document.getElementById('autoConfirmationEmail').checked = settings.autoConfirmationEmail !== false;
      document.getElementById('reminderEmails').checked = settings.reminderEmails !== false;
      document.getElementById('reminderHours').value = settings.reminderHours || 24;
    }

    // OLD AVAILABILITY FORM (replaced by Calendly-style interface)
    // Keeping for reference - can be removed after testing
    /*
    document.getElementById('availabilityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const availableDays = Array.from(document.querySelectorAll('input[name="availableDay"]:checked')).map(c => c.value);
      const availableSlots = document.getElementById('availableSlots').value.split('\n').filter(s => s.trim());

      showLoading(true);
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify({ availableDays, availableSlots })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Availability saved!', 'success');
        settings = result.settings;
      }
    });
    */

    // Email settings form
    document.getElementById('emailSettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailNotifications = document.getElementById('emailNotifications').checked;
      const autoConfirmationEmail = document.getElementById('autoConfirmationEmail').checked;
      const reminderEmails = document.getElementById('reminderEmails').checked;
      const reminderHours = parseInt(document.getElementById('reminderHours').value);

      showLoading(true);
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify({ emailNotifications, autoConfirmationEmail, reminderEmails, reminderHours })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Email settings saved!', 'success');
      }
    });

    function openBlockDateModal() {
      document.getElementById('blockDate').value = '';
      document.getElementById('blockReason').value = '';
      openModal('blockDateModal');
    }

    async function saveBlockedDate() {
      const date = document.getElementById('blockDate').value;
      const reason = document.getElementById('blockReason').value;
      
      if (!date) return;

      showLoading(true);
      const result = await api('/api/admin/settings/block-date', {
        method: 'POST',
        body: JSON.stringify({ date, reason })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Date blocked!', 'success');
        closeModal('blockDateModal');
        settings.blockedDates = result.blockedDates;
        renderSettings();
      }
    }

    async function unblockDate(date) {
      showLoading(true);
      const result = await api(`/api/admin/settings/block-date/${date}`, { method: 'DELETE' });
      showLoading(false);

      if (result?.success) {
        showToast('Date unblocked!', 'success');
        settings.blockedDates = result.blockedDates;
        renderSettings();
      }
    }

    // ===========================================
    // CALENDLY-STYLE AVAILABILITY
    // ===========================================
    function renderWeeklyAvailability() {
      const container = document.getElementById('weeklyAvailability');
      if (!container) return;

      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      
      // Get current availability data or initialize
      if (!settings.weeklyAvailability) {
        settings.weeklyAvailability = {};
        dayKeys.forEach(key => {
          settings.weeklyAvailability[key] = {
            enabled: settings.availableDays?.includes(key) || false,
            slots: []
          };
        });
      }

      // Generate time slots (9am - 6pm in 30min intervals by default)
      const generateTimeSlots = (startHour = 9, endHour = 18, interval = 30) => {
        const slots = [];
        for (let hour = startHour; hour < endHour; hour++) {
          for (let min = 0; min < 60; min += interval) {
            const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
            slots.push(timeStr);
          }
        }
        return slots;
      };

      const allTimeSlots = generateTimeSlots();

      container.innerHTML = `
        <div class="slot-duration-selector">
          <label>Time Slot Interval:</label>
          <label><input type="radio" name="slotInterval" value="15" ${settings.slotInterval === 15 ? 'checked' : ''}> 15 min</label>
          <label><input type="radio" name="slotInterval" value="30" ${!settings.slotInterval || settings.slotInterval === 30 ? 'checked' : ''}> 30 min</label>
          <label><input type="radio" name="slotInterval" value="60" ${settings.slotInterval === 60 ? 'checked' : ''}> 60 min</label>
        </div>
        <div class="weekly-availability-container">
          ${days.map((day, index) => {
            const dayKey = dayKeys[index];
            const dayData = settings.weeklyAvailability[dayKey] || { enabled: false, slots: [] };
            
            return `
              <div class="availability-day-card ${!dayData.enabled ? 'disabled' : ''}">
                <div class="day-header">
                  <span class="day-name">${day}</span>
                  <label class="day-toggle">
                    <input type="checkbox" ${dayData.enabled ? 'checked' : ''} 
                           onchange="toggleDay('${dayKey}', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                ${dayData.enabled ? `
                  <div class="time-slots-container" id="slots-${dayKey}">
                    ${allTimeSlots.map(slot => `
                      <button class="time-slot-btn ${dayData.slots.includes(slot) ? 'selected' : ''}"
                              onclick="toggleTimeSlot('${dayKey}', '${slot}')">
                        ${formatTime(slot)}
                      </button>
                    `).join('')}
                  </div>
                ` : '<p style="color: var(--soft-gray); margin-top: 12px; font-style: italic;">Day is disabled</p>'}
              </div>
            `;
          }).join('')}
        </div>
        <div class="availability-summary">
          <strong>Quick Actions:</strong><br>
          <button class="btn btn-secondary" onclick="selectBusinessHours()" style="margin-top: 8px; padding: 8px 16px;">
            Select Business Hours (9am-5pm)
          </button>
          <button class="btn btn-secondary" onclick="clearAllSlots()" style="margin-top: 8px; padding: 8px 16px; margin-left: 8px;">
            Clear All
          </button>
        </div>
        <div class="availability-actions">
          <button class="btn btn-primary" onclick="saveAvailability()">üíæ Save Availability</button>
          <button class="btn btn-secondary" onclick="renderWeeklyAvailability()">‚Üª Reset Changes</button>
        </div>
      `;

      // Add interval change listener
      document.querySelectorAll('input[name="slotInterval"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          settings.slotInterval = parseInt(e.target.value);
          renderWeeklyAvailability();
        });
      });
    }

    function formatTime(time24) {
      const [hours, minutes] = time24.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function toggleDay(dayKey, enabled) {
      if (!settings.weeklyAvailability) settings.weeklyAvailability = {};
      if (!settings.weeklyAvailability[dayKey]) settings.weeklyAvailability[dayKey] = { enabled: false, slots: [] };
      settings.weeklyAvailability[dayKey].enabled = enabled;
      renderWeeklyAvailability();
    }

    function toggleTimeSlot(dayKey, slot) {
      if (!settings.weeklyAvailability[dayKey].slots) settings.weeklyAvailability[dayKey].slots = [];
      const slots = settings.weeklyAvailability[dayKey].slots;
      const index = slots.indexOf(slot);
      
      if (index > -1) {
        slots.splice(index, 1);
      } else {
        slots.push(slot);
        slots.sort();
      }
      
      // Update button visual
      const btn = event.target;
      btn.classList.toggle('selected');
    }

    function selectBusinessHours() {
      const businessDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
      const businessHours = [];
      
      // Generate 9am-5pm slots
      for (let hour = 9; hour < 17; hour++) {
        const interval = settings.slotInterval || 30;
        for (let min = 0; min < 60; min += interval) {
          businessHours.push(`${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
        }
      }
      
      businessDays.forEach(day => {
        if (!settings.weeklyAvailability[day]) settings.weeklyAvailability[day] = { enabled: false, slots: [] };
        settings.weeklyAvailability[day].enabled = true;
        settings.weeklyAvailability[day].slots = [...businessHours];
      });
      
      renderWeeklyAvailability();
      showToast('Business hours selected (Mon-Fri, 9am-5pm)', 'success');
    }

    function clearAllSlots() {
      if (!confirm('Clear all availability? This will disable all days and remove all time slots.')) return;
      
      const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      dayKeys.forEach(day => {
        if (!settings.weeklyAvailability[day]) settings.weeklyAvailability[day] = { enabled: false, slots: [] };
        settings.weeklyAvailability[day].enabled = false;
        settings.weeklyAvailability[day].slots = [];
      });
      
      renderWeeklyAvailability();
      showToast('All availability cleared', 'info');
    }

    async function saveAvailability() {
      showLoading(true);
      
      // Convert new format to legacy format for backward compatibility
      const availableDays = [];
      const availableSlots = [];
      
      Object.keys(settings.weeklyAvailability).forEach(day => {
        const dayData = settings.weeklyAvailability[day];
        if (dayData.enabled) {
          availableDays.push(day);
          // Convert time slots to readable format for legacy field
          dayData.slots.forEach(slot => {
            const formatted = `${day.charAt(0).toUpperCase() + day.slice(1)} ${formatTime(slot)}`;
            if (!availableSlots.includes(formatted)) {
              availableSlots.push(formatted);
            }
          });
        }
      });
      
      settings.availableDays = availableDays;
      settings.availableSlots = availableSlots;
      
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify(settings)
      });
      
      showLoading(false);

      if (result?.success) {
        showToast('Availability saved successfully!', 'success');
        settings = result.settings;
      } else {
        showToast('Failed to save availability', 'error');
      }
    }

    // ===========================================
    // SERVICE MANAGEMENT
    // ===========================================
    function editService(index) {
      const service = settings.services[index];
      const newName = prompt('Service Name:', service.name);
      if (newName === null) return;
      
      const newPrice = prompt('Price ($):', service.price);
      if (newPrice === null) return;
      
      const newDuration = prompt('Duration (minutes):', service.duration);
      if (newDuration === null) return;
      
      const newDescription = prompt('Description (optional):', service.description || '');
      if (newDescription === null) return;
      
      settings.services[index] = {
        ...service,
        name: newName.trim(),
        price: parseInt(newPrice),
        duration: parseInt(newDuration),
        description: newDescription.trim()
      };
      
      saveSettings();
    }

    async function toggleServiceActive(index) {
      settings.services[index].active = !settings.services[index].active;
      await saveSettings();
    }

    async function deleteService(index) {
      const service = settings.services[index];
      if (!confirm(`Delete "${service.name}"? This cannot be undone.`)) return;
      
      settings.services.splice(index, 1);
      await saveSettings();
    }

    async function saveSettings() {
      showLoading(true);
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify(settings)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Settings saved!', 'success');
        settings = result.settings;
        renderSettings();
      } else {
        showToast('Failed to save settings', 'error');
      }
    }

    // ===========================================
    // MARKETING AUTOMATION
    // ===========================================
    let campaigns = [];
    let segments = [];
    let workflows = [];
    let templates = [];
    let marketingAnalytics = {};

    async function loadMarketing() {
      await Promise.all([
        loadCampaigns(),
        loadSegments(),
        loadWorkflows(),
        loadTemplates(),
        loadMarketingAnalytics()
      ]);
    }

    async function loadCampaigns() {
      const result = await api('/api/admin/campaigns');
      if (result?.campaigns) {
        campaigns = result.campaigns;
        renderCampaigns();
      }
    }

    function renderCampaigns() {
      const total = campaigns.length;
      const sent = campaigns.filter(c => c.status === 'sent').length;
      const openRates = campaigns.filter(c => c.stats?.openRate).map(c => c.stats.openRate);
      const clickRates = campaigns.filter(c => c.stats?.clickRate).map(c => c.stats.clickRate);
      
      document.getElementById('totalCampaigns').textContent = total;
      document.getElementById('sentCampaigns').textContent = sent;
      document.getElementById('avgOpenRate').textContent = openRates.length ? 
        (openRates.reduce((a,b) => a+b, 0) / openRates.length).toFixed(1) + '%' : '0%';
      document.getElementById('avgClickRate').textContent = clickRates.length ? 
        (clickRates.reduce((a,b) => a+b, 0) / clickRates.length).toFixed(1) + '%' : '0%';

      const list = document.getElementById('campaignsList');
      if (campaigns.length === 0) {
        list.innerHTML = '<p class="no-items-message">No campaigns yet. Create your first email campaign!</p>';
        return;
      }

      list.innerHTML = campaigns.map(campaign => `
        <div class="campaign-item">
          <div class="campaign-header">
            <div>
              <div class="campaign-title">${campaign.name}</div>
              <div class="campaign-meta">
                <span><span class="status-badge ${campaign.status}">${campaign.status.toUpperCase()}</span></span>
                <span>üìß ${campaign.recipientCount || 0} recipients</span>
                ${campaign.sentDate ? `<span>üìÖ ${new Date(campaign.sentDate).toLocaleDateString()}</span>` : ''}
                ${campaign.stats ? `<span>üìä ${campaign.stats.openRate}% opens, ${campaign.stats.clickRate}% clicks</span>` : ''}
              </div>
            </div>
            <div class="campaign-actions">
              ${campaign.status === 'draft' ? `
                <button class="btn btn-sm btn-secondary" onclick="editCampaign('${campaign.id}')">‚úèÔ∏è Edit</button>
                <button class="btn btn-sm btn-primary" onclick="sendCampaign('${campaign.id}')">üìß Send</button>
              ` : ''}
              ${campaign.status === 'sent' ? `
                <button class="btn btn-sm btn-secondary" onclick="viewCampaignStats('${campaign.id}')">üìä Stats</button>
                <button class="btn btn-sm btn-secondary" onclick="duplicateCampaign('${campaign.id}')">üìã Duplicate</button>
              ` : ''}
              <button class="btn btn-sm" onclick="deleteCampaign('${campaign.id}')" style="color: var(--danger);">üóëÔ∏è</button>
            </div>
          </div>
          ${campaign.subject ? `<div style="color: var(--soft-gray); margin-top: 8px;">Subject: ${campaign.subject}</div>` : ''}
        </div>
      `).join('');
    }

    function showCampaignBuilder() {
      const modal = `
        <div class="modal-overlay active" id="campaignModal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Create Email Campaign</h2>
              <button class="modal-close" onclick="closeCampaignModal()">√ó</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Campaign Name</label>
                <input type="text" id="campaignName" class="form-control" placeholder="e.g., Monthly Newsletter">
              </div>
              <div class="form-group">
                <label>Email Subject</label>
                <input type="text" id="campaignSubject" class="form-control" placeholder="Your subject line">
              </div>
              <div class="form-group">
                <label>Target Audience</label>
                <select id="campaignSegment" class="form-control">
                  <option value="all">All Clients</option>
                  ${segments.map(s => `<option value="${s.id}">${s.name} (${s.count} clients)</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>Email Template</label>
                <select id="campaignTemplate" class="form-control" onchange="previewTemplate()">
                  <option value="">Select a template...</option>
                  ${templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>Email Body</label>
                <textarea id="campaignBody" class="form-control" rows="8" placeholder="Your email content here..."></textarea>
                <small style="color: var(--soft-gray);">Use {{firstName}}, {{lastName}}, {{email}} for personalization</small>
              </div>
              <div class="email-preview" id="emailPreview" style="display:none;">
                <div class="email-preview-subject" id="previewSubject"></div>
                <div class="email-preview-body" id="previewBody"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeCampaignModal()">Cancel</button>
              <button class="btn btn-secondary" onclick="saveCampaignDraft()">üíæ Save Draft</button>
              <button class="btn btn-primary" onclick="scheduleCampaign()">üìß Send Now</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeCampaignModal() {
      document.getElementById('campaignModal')?.remove();
    }

    async function saveCampaignDraft() {
      const campaign = {
        id: Date.now().toString(),
        name: document.getElementById('campaignName').value,
        subject: document.getElementById('campaignSubject').value,
        body: document.getElementById('campaignBody').value,
        segment: document.getElementById('campaignSegment').value,
        template: document.getElementById('campaignTemplate').value,
        status: 'draft',
        createdDate: new Date().toISOString()
      };

      if (!campaign.name || !campaign.subject || !campaign.body) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      showLoading(true);
      const result = await api('/api/admin/campaigns', {
        method: 'POST',
        body: JSON.stringify(campaign)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Campaign saved as draft!', 'success');
        closeCampaignModal();
        await loadCampaigns();
      } else {
        showToast('Failed to save campaign', 'error');
      }
    }

    async function scheduleCampaign() {
      if (!confirm('Send this campaign now to all recipients?')) return;
      
      const campaign = {
        id: Date.now().toString(),
        name: document.getElementById('campaignName').value,
        subject: document.getElementById('campaignSubject').value,
        body: document.getElementById('campaignBody').value,
        segment: document.getElementById('campaignSegment').value,
        template: document.getElementById('campaignTemplate').value,
        status: 'scheduled',
        createdDate: new Date().toISOString()
      };

      showLoading(true);
      const result = await api('/api/admin/campaigns/send', {
        method: 'POST',
        body: JSON.stringify(campaign)
      });
      showLoading(false);

      if (result?.success) {
        showToast(`Campaign sent to ${result.recipientCount} recipients!`, 'success');
        closeCampaignModal();
        await loadCampaigns();
      } else {
        showToast('Failed to send campaign', 'error');
      }
    }

    async function loadSegments() {
      const result = await api('/api/admin/segments');
      if (result?.segments) {
        segments = result.segments;
        renderSegments();
      }
    }

    function renderSegments() {
      const list = document.getElementById('segmentsList');
      if (segments.length === 0) {
        list.innerHTML = '<p class="no-items-message">No segments yet. Create your first audience segment!</p>';
        return;
      }

      list.innerHTML = segments.map(segment => `
        <div class="segment-item">
          <div class="segment-header">
            <div>
              <div class="segment-title">${segment.name}</div>
              <div class="segment-meta">
                <span>üë• ${segment.count || 0} clients</span>
                <span>üéØ ${segment.filters?.length || 0} filters</span>
                <span>üìÖ Updated ${new Date(segment.updatedDate).toLocaleDateString()}</span>
              </div>
            </div>
            <div class="segment-actions">
              <button class="btn btn-sm btn-secondary" onclick="editSegment('${segment.id}')">‚úèÔ∏è Edit</button>
              <button class="btn btn-sm btn-primary" onclick="exportSegment('${segment.id}')">üì• Export</button>
              <button class="btn btn-sm" onclick="deleteSegment('${segment.id}')" style="color: var(--danger);">üóëÔ∏è</button>
            </div>
          </div>
          <div style="color: var(--soft-gray); margin-top: 8px; font-size: 14px;">${segment.description || ''}</div>
        </div>
      `).join('');
    }

    function showSegmentBuilder() {
      const modal = `
        <div class="modal-overlay active" id="segmentModal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Create Client Segment</h2>
              <button class="modal-close" onclick="closeSegmentModal()">√ó</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Segment Name</label>
                <input type="text" id="segmentName" class="form-control" placeholder="e.g., Active Clients">
              </div>
              <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="segmentDescription" class="form-control" placeholder="Who this segment includes">
              </div>
              <div class="form-group">
                <label>Filters</label>
                <div id="segmentFilters">
                  <div class="segment-filter">
                    <div class="segment-filter-row">
                      <select class="form-control filter-field">
                        <option value="bookingCount">Total Bookings</option>
                        <option value="lastBooking">Last Booking Date</option>
                        <option value="totalSpent">Total Spent</option>
                        <option value="service">Service Type</option>
                        <option value="lifecycle">Lifecycle Stage</option>
                      </select>
                      <select class="form-control filter-operator">
                        <option value="equals">Equals</option>
                        <option value="greater">Greater Than</option>
                        <option value="less">Less Than</option>
                        <option value="contains">Contains</option>
                      </select>
                      <input type="text" class="form-control filter-value" placeholder="Value">
                    </div>
                  </div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="addSegmentFilter()" style="margin-top: 8px;">+ Add Filter</button>
              </div>
              <div style="background: var(--gold-light); padding: 12px; border-radius: 8px; margin-top: 16px;">
                <strong>Estimated audience:</strong> <span id="segmentEstimate">Calculating...</span>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeSegmentModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveSegment()">üíæ Create Segment</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
      calculateSegmentEstimate();
    }

    function closeSegmentModal() {
      document.getElementById('segmentModal')?.remove();
    }

    async function calculateSegmentEstimate() {
      // Simulate calculation - in real implementation, would query server
      setTimeout(() => {
        const estimate = Math.floor(Math.random() * clients.length);
        document.getElementById('segmentEstimate').textContent = `~${estimate} clients`;
      }, 500);
    }

    async function saveSegment() {
      const filters = Array.from(document.querySelectorAll('.segment-filter')).map(filter => ({
        field: filter.querySelector('.filter-field').value,
        operator: filter.querySelector('.filter-operator').value,
        value: filter.querySelector('.filter-value').value
      }));

      const segment = {
        id: Date.now().toString(),
        name: document.getElementById('segmentName').value,
        description: document.getElementById('segmentDescription').value,
        filters: filters,
        count: 0, // Will be calculated server-side
        createdDate: new Date().toISOString(),
        updatedDate: new Date().toISOString()
      };

      if (!segment.name) {
        showToast('Please enter a segment name', 'error');
        return;
      }

      showLoading(true);
      const result = await api('/api/admin/segments', {
        method: 'POST',
        body: JSON.stringify(segment)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Segment created!', 'success');
        closeSegmentModal();
        await loadSegments();
      } else {
        showToast('Failed to create segment', 'error');
      }
    }

    async function loadWorkflows() {
      const result = await api('/api/admin/automation');
      if (result?.workflows) {
        workflows = result.workflows;
        renderWorkflows();
      }
    }

    function renderWorkflows() {
      const list = document.getElementById('workflowsList');
      if (workflows.length === 0) {
        list.innerHTML = '<p class="no-items-message">No workflows yet. Automate your client communications!</p>';
        return;
      }

      list.innerHTML = workflows.map(workflow => `
        <div class="workflow-item">
          <div class="workflow-header">
            <div>
              <div class="workflow-title">${workflow.name}</div>
              <div class="workflow-meta">
                <span><span class="status-badge ${workflow.active ? 'active' : 'paused'}">${workflow.active ? 'ACTIVE' : 'PAUSED'}</span></span>
                <span>‚ö° ${workflow.trigger}</span>
                <span>üìß ${workflow.steps?.length || 0} steps</span>
                <span>üë• ${workflow.executed || 0} sent</span>
              </div>
            </div>
            <div class="workflow-actions">
              <button class="btn btn-sm btn-secondary" onclick="toggleWorkflow('${workflow.id}')">${workflow.active ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Activate'}</button>
              <button class="btn btn-sm btn-secondary" onclick="editWorkflow('${workflow.id}')">‚úèÔ∏è Edit</button>
              <button class="btn btn-sm" onclick="deleteWorkflow('${workflow.id}')" style="color: var(--danger);">üóëÔ∏è</button>
            </div>
          </div>
          <div style="color: var(--soft-gray); margin-top: 8px; font-size: 14px;">${workflow.description || ''}</div>
        </div>
      `).join('');
    }

    function showWorkflowBuilder() {
      const modal = `
        <div class="modal-overlay active" id="workflowModal">
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h2>Create Automated Workflow</h2>
              <button class="modal-close" onclick="closeWorkflowModal()">√ó</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Workflow Name</label>
                <input type="text" id="workflowName" class="form-control" placeholder="e.g., Welcome Sequence">
              </div>
              <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="workflowDescription" class="form-control" placeholder="What this workflow does">
              </div>
              <div class="form-group">
                <label>Trigger Event</label>
                <select id="workflowTrigger" class="form-control">
                  <option value="new_booking">New Booking Confirmed</option>
                  <option value="booking_completed">Booking Completed</option>
                  <option value="new_client">New Client Registered</option>
                  <option value="inactive_30days">Client Inactive for 30 Days</option>
                  <option value="birthday">Client Birthday</option>
                </select>
              </div>
              <div class="form-group">
                <label>Email Steps</label>
                <div id="workflowSteps">
                  <div class="workflow-step">
                    <div class="workflow-step-header">
                      <span class="workflow-step-title">Step 1: Immediate</span>
                      <button class="btn btn-sm" onclick="this.parentElement.parentElement.remove()" style="color: var(--danger);">Remove</button>
                    </div>
                    <input type="text" class="form-control step-subject" placeholder="Email subject" style="margin-bottom: 8px;">
                    <textarea class="form-control step-body" rows="4" placeholder="Email body"></textarea>
                    <div style="margin-top: 8px;">
                      <label style="font-size: 13px;">Delay before next step:</label>
                      <input type="number" class="form-control step-delay" value="3" style="width: 80px; display: inline-block; margin: 0 8px;"> days
                    </div>
                  </div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="addWorkflowStep()" style="margin-top: 8px;">+ Add Step</button>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeWorkflowModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveWorkflow()">üíæ Create Workflow</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeWorkflowModal() {
      document.getElementById('workflowModal')?.remove();
    }

    function addWorkflowStep() {
      const steps = document.getElementById('workflowSteps');
      const stepNum = steps.children.length + 1;
      const stepHTML = `
        <div class="workflow-step">
          <div class="workflow-step-header">
            <span class="workflow-step-title">Step ${stepNum}</span>
            <button class="btn btn-sm" onclick="this.parentElement.parentElement.remove()" style="color: var(--danger);">Remove</button>
          </div>
          <input type="text" class="form-control step-subject" placeholder="Email subject" style="margin-bottom: 8px;">
          <textarea class="form-control step-body" rows="4" placeholder="Email body"></textarea>
          <div style="margin-top: 8px;">
            <label style="font-size: 13px;">Delay before next step:</label>
            <input type="number" class="form-control step-delay" value="3" style="width: 80px; display: inline-block; margin: 0 8px;"> days
          </div>
        </div>
      `;
      steps.insertAdjacentHTML('beforeend', stepHTML);
    }

    async function saveWorkflow() {
      const steps = Array.from(document.querySelectorAll('.workflow-step')).map((step, idx) => ({
        stepNumber: idx + 1,
        subject: step.querySelector('.step-subject').value,
        body: step.querySelector('.step-body').value,
        delay: parseInt(step.querySelector('.step-delay').value) || 0
      }));

      const workflow = {
        id: Date.now().toString(),
        name: document.getElementById('workflowName').value,
        description: document.getElementById('workflowDescription').value,
        trigger: document.getElementById('workflowTrigger').value,
        steps: steps,
        active: true,
        executed: 0,
        createdDate: new Date().toISOString()
      };

      if (!workflow.name || steps.length === 0) {
        showToast('Please enter a name and at least one email step', 'error');
        return;
      }

      showLoading(true);
      const result = await api('/api/admin/automation', {
        method: 'POST',
        body: JSON.stringify(workflow)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Workflow created!', 'success');
        closeWorkflowModal();
        await loadWorkflows();
      } else {
        showToast('Failed to create workflow', 'error');
      }
    }

    async function loadTemplates() {
      const result = await api('/api/admin/templates');
      if (result?.templates) {
        templates = result.templates;
      } else {
        // Load default templates
        templates = [
          {
            id: 'welcome',
            name: 'Welcome Email',
            description: 'Greet new clients and introduce your services',
            icon: 'üëã',
            subject: 'Welcome to {{businessName}}!',
            body: 'Hi {{firstName}},\n\nThank you for choosing us! We\'re excited to have you.\n\nBest regards,\n{{businessName}}'
          },
          {
            id: 'booking_confirmation',
            name: 'Booking Confirmation',
            description: 'Confirm upcoming appointments',
            icon: 'üìÖ',
            subject: 'Your booking is confirmed',
            body: 'Hi {{firstName}},\n\nYour booking for {{service}} on {{date}} is confirmed.\n\nSee you soon!'
          },
          {
            id: 'thank_you',
            name: 'Thank You',
            description: 'Follow up after appointments',
            icon: 'üíù',
            subject: 'Thank you for visiting us!',
            body: 'Hi {{firstName}},\n\nThank you for your recent visit. We hope you enjoyed your experience.\n\nWe\'d love to see you again soon!'
          },
          {
            id: 're_engagement',
            name: 'Re-engagement',
            description: 'Win back inactive clients',
            icon: 'üîî',
            subject: 'We miss you!',
            body: 'Hi {{firstName}},\n\nIt\'s been a while since we last saw you. We have some exciting new services and special offers.\n\nCome back and visit us!'
          },
          {
            id: 'newsletter',
            name: 'Newsletter',
            description: 'Regular updates and announcements',
            icon: 'üì∞',
            subject: 'Monthly Newsletter',
            body: 'Hi {{firstName}},\n\nHere\'s what\'s new this month...\n\n[Your content here]'
          },
          {
            id: 'promotion',
            name: 'Promotion',
            description: 'Special offers and discounts',
            icon: 'üéÅ',
            subject: 'Special offer just for you!',
            body: 'Hi {{firstName}},\n\nWe have a special promotion for you: [Your offer details]\n\nDon\'t miss out!'
          }
        ];
      }
      renderTemplates();
    }

    function renderTemplates() {
      const gallery = document.getElementById('templateGallery');
      gallery.innerHTML = templates.map(template => `
        <div class="template-card" onclick="useTemplate('${template.id}')">
          <div class="template-preview">${template.icon || 'üìß'}</div>
          <div class="template-info">
            <div class="template-name">${template.name}</div>
            <div class="template-description">${template.description}</div>
          </div>
        </div>
      `).join('');
    }

    function useTemplate(templateId) {
      const template = templates.find(t => t.id === templateId);
      if (!template) return;
      
      showToast(`Using template: ${template.name}`, 'info');
      // Template will be used when creating campaign
    }

    function showTemplateEditor() {
      showToast('Custom template editor coming soon! Use the built-in templates for now.', 'info');
    }

    async function loadMarketingAnalytics() {
      const days = parseInt(document.getElementById('analyticsDateRange')?.value || 30);
      const result = await api(`/api/admin/analytics/marketing?days=${days}`);
      
      if (result?.analytics) {
        marketingAnalytics = result.analytics;
        renderMarketingAnalytics();
      } else {
        // Default/demo data
        marketingAnalytics = {
          totalSubscribers: clients.length,
          emailsSent: campaigns.filter(c => c.status === 'sent').length * 50,
          totalOpens: campaigns.filter(c => c.status === 'sent').length * 25,
          totalClicks: campaigns.filter(c => c.status === 'sent').length * 8,
          lifecycle: {
            'New Lead': 12,
            'Active Client': 45,
            'Returning Client': 23,
            'At Risk': 8,
            'Inactive': 5
          }
        };
        renderMarketingAnalytics();
      }
    }

    function renderMarketingAnalytics() {
      document.getElementById('totalSubscribers').textContent = marketingAnalytics.totalSubscribers || clients.length;
      document.getElementById('totalEmailsSent').textContent = marketingAnalytics.emailsSent || 0;
      document.getElementById('totalOpens').textContent = marketingAnalytics.totalOpens || 0;
      document.getElementById('totalClicks').textContent = marketingAnalytics.totalClicks || 0;

      // Lifecycle chart
      const lifecycleData = marketingAnalytics.lifecycle || {};
      const total = Object.values(lifecycleData).reduce((a, b) => a + b, 0) || 1;
      
      const lifecycleHTML = Object.entries(lifecycleData).map(([stage, count]) => {
        const percentage = (count / total * 100).toFixed(0);
        return `
          <div class="lifecycle-bar">
            <div class="lifecycle-label">${stage}</div>
            <div class="lifecycle-progress">
              <div class="lifecycle-progress-fill" style="width: ${percentage}%">${percentage}%</div>
            </div>
            <div class="lifecycle-count">${count}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('lifecycleChart').innerHTML = lifecycleHTML || '<p class="no-items-message">No data available</p>';

      // Campaign performance
      const performanceHTML = campaigns
        .filter(c => c.status === 'sent' && c.stats)
        .sort((a, b) => (b.stats.openRate || 0) - (a.stats.openRate || 0))
        .slice(0, 5)
        .map(c => `
          <div style="padding: 12px; border: 1px solid #e0d6cc; border-radius: 8px; margin-bottom: 8px;">
            <strong>${c.name}</strong><br>
            <small style="color: var(--soft-gray);">
              üìß ${c.recipientCount} sent | 
              üìä ${c.stats.openRate}% opens | 
              üñ±Ô∏è ${c.stats.clickRate}% clicks
            </small>
          </div>
        `).join('');
      
      document.getElementById('campaignPerformanceList').innerHTML = performanceHTML || '<p class="no-items-message">No sent campaigns yet</p>';
    }

    async function deleteCampaign(id) {
      if (!confirm('Delete this campaign?')) return;
      showLoading(true);
      const result = await api(`/api/admin/campaigns/${id}`, { method: 'DELETE' });
      showLoading(false);
      if (result?.success) {
        showToast('Campaign deleted', 'success');
        await loadCampaigns();
      }
    }

    async function deleteSegment(id) {
      if (!confirm('Delete this segment?')) return;
      showLoading(true);
      const result = await api(`/api/admin/segments/${id}`, { method: 'DELETE' });
      showLoading(false);
      if (result?.success) {
        showToast('Segment deleted', 'success');
        await loadSegments();
      }
    }

    async function deleteWorkflow(id) {
      if (!confirm('Delete this workflow?')) return;
      showLoading(true);
      const result = await api(`/api/admin/automation/${id}`, { method: 'DELETE' });
      showLoading(false);
      if (result?.success) {
        showToast('Workflow deleted', 'success');
        await loadWorkflows();
      }
    }

    async function toggleWorkflow(id) {
      const workflow = workflows.find(w => w.id === id);
      if (!workflow) return;
      
      workflow.active = !workflow.active;
      showLoading(true);
      const result = await api(`/api/admin/automation/${id}`, {
        method: 'PUT',
        body: JSON.stringify(workflow)
      });
      showLoading(false);
      
      if (result?.success) {
        showToast(workflow.active ? 'Workflow activated' : 'Workflow paused', 'success');
        await loadWorkflows();
      }
    }

    // ===========================================
    // EXPORT & BACKUP
    // ===========================================
    async function exportBookings() {
      window.open('/api/admin/export/bookings', '_blank');
    }

    async function exportClients() {
      window.open('/api/admin/export/clients', '_blank');
    }

    async function downloadBackup() {
      window.open('/api/admin/backup', '_blank');
      showToast('Backup downloading...', 'info');
    }

    async function handleRestore(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const backup = JSON.parse(e.target.result);
          if (!confirm('This will replace all current data. Are you sure?')) return;

          showLoading(true);
          const result = await api('/api/admin/restore', {
            method: 'POST',
            body: JSON.stringify({ backup })
          });
          showLoading(false);

          if (result?.success) {
            showToast('Backup restored successfully!', 'success');
            refreshDashboard();
          }
        } catch (err) {
          showToast('Invalid backup file', 'error');
        }
      };
      reader.readAsText(file);
      input.value = '';
    }

    // ===========================================
    // AUTOMATIC BACKUP MANAGEMENT
    // ===========================================
    
    let allBackups = { auto: [], manual: [] };
    let currentFilter = 'all';

    async function loadBackupStats() {
      try {
        const stats = await api('/api/admin/backups/stats');
        
        // Update stat cards
        document.getElementById('totalAutoBackups').textContent = stats.autoBackups.total || 0;
        document.getElementById('totalManualBackups').textContent = stats.manualBackups.total || 0;
        
        // Format size
        const totalBytes = (stats.autoBackups.totalSize || 0) + (stats.manualBackups.totalSize || 0);
        const sizeMB = (totalBytes / 1024 / 1024).toFixed(2);
        document.getElementById('backupSize').textContent = sizeMB + ' MB';
        
        // Format newest backup time
        if (stats.newestBackup) {
          const date = new Date(stats.newestBackup);
          const timeAgo = getTimeAgo(date);
          document.getElementById('newestBackup').textContent = timeAgo;
        } else {
          document.getElementById('newestBackup').textContent = 'None';
        }
        
        // Load backup list
        await loadBackupList();
      } catch (err) {
        console.error('Failed to load backup stats:', err);
        showToast('Failed to load backup stats', 'error');
      }
    }

    async function loadBackupList() {
      try {
        const backups = await api('/api/admin/backups/list');
        allBackups = backups;
        renderBackupList();
      } catch (err) {
        console.error('Failed to load backup list:', err);
        const tbody = document.getElementById('backupListTable');
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 40px; text-align: center; color: #c62828;">
              <div style="font-size: 48px; margin-bottom: 8px;">‚ö†Ô∏è</div>
              <div>Failed to load backups</div>
            </td>
          </tr>
        `;
      }
    }

    function filterBackups(type) {
      currentFilter = type;
      
      // Update button styles
      ['All', 'Bookings', 'Settings', 'Content', 'Clients', 'Manual'].forEach(t => {
        const btn = document.getElementById('filter' + t);
        if (btn) {
          if (t.toLowerCase() === type) {
            btn.style.background = 'var(--burgundy)';
            btn.style.color = 'white';
            btn.classList.remove('btn-outline');
          } else {
            btn.style.background = '';
            btn.style.color = '';
            btn.classList.add('btn-outline');
          }
        }
      });
      
      renderBackupList();
    }

    function renderBackupList() {
      const tbody = document.getElementById('backupListTable');
      
      // Filter backups
      let filtered = [];
      
      if (currentFilter === 'all') {
        filtered = [...allBackups.auto, ...allBackups.manual];
      } else if (currentFilter === 'manual') {
        filtered = allBackups.manual;
      } else {
        filtered = allBackups.auto.filter(b => b.fileType === currentFilter);
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 40px; text-align: center; color: var(--soft-gray);">
              <div style="font-size: 48px; margin-bottom: 8px;">üì≠</div>
              <div>No backups found</div>
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort by date (newest first)
      filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Render rows
      tbody.innerHTML = filtered.map(backup => {
        const date = new Date(backup.date);
        const fileType = backup.fileType || 'Full Backup';
        const type = backup.path === 'auto' ? 'Auto' : 'Manual';
        const icon = backup.path === 'auto' ? 'üîÑ' : 'üíæ';
        const sizeKB = (backup.size / 1024).toFixed(1);
        
        return `
          <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 12px;">
              <strong>${fileType}</strong>
            </td>
            <td style="padding: 12px; color: var(--soft-gray);">
              ${formatDateTime(date)}
            </td>
            <td style="padding: 12px; color: var(--soft-gray);">
              ${sizeKB} KB
            </td>
            <td style="padding: 12px;">
              <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${type === 'Auto' ? '#e3f2fd' : '#fff3e0'}; color: ${type === 'Auto' ? '#1565c0' : '#e65100'};">
                ${icon} ${type}
              </span>
            </td>
            <td style="padding: 12px; text-align: center;">
              ${backup.path === 'auto' && backup.fileType ? `
                <button class="btn btn-sm btn-outline" onclick="restoreAutoBackup('${backup.name}', '${backup.fileType}')" style="padding: 6px 12px; font-size: 12px;">
                  ‚Ü©Ô∏è Restore
                </button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');
    }

    async function restoreAutoBackup(filename, fileType) {
      if (!confirm(`‚ö†Ô∏è Restore ${fileType} from this backup?\n\nYour current ${fileType} data will be backed up before restoring.\n\nContinue?`)) {
        return;
      }
      
      try {
        showLoading(true);
        const result = await api('/api/admin/backups/restore', {
          method: 'POST',
          body: JSON.stringify({ filename, fileType })
        });
        showLoading(false);
        
        if (result?.success) {
          showToast(result.message, 'success');
          await loadBackupStats();
          refreshDashboard();
        }
      } catch (err) {
        showLoading(false);
        console.error('Restore failed:', err);
        showToast('Failed to restore backup: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      
      return date.toLocaleDateString();
    }

    function formatDateTime(date) {
      const options = {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return date.toLocaleDateString('en-US', options);
    }

    // ===========================================
    // DEMO MODE
    // ===========================================
    async function populateDemoData() {
      if (!confirm('This will add sample bookings, clients, inquiries, and invitation codes. Continue?')) return;
      
      showLoading(true);
      const result = await api('/api/admin/demo/populate', { method: 'POST' });
      showLoading(false);
      
      if (result?.success) {
        showToast(`Demo data populated! Added ${result.counts.bookings} bookings, ${result.counts.clients} clients, ${result.counts.inquiries} inquiries`, 'success');
        refreshDashboard();
      }
    }

    async function resetDemoData() {
      if (!confirm('‚ö†Ô∏è This will DELETE ALL DATA (bookings, clients, inquiries, invitation codes). This cannot be undone. Are you absolutely sure?')) return;
      if (!confirm('Last chance! Click OK to permanently delete everything.')) return;
      
      showLoading(true);
      const result = await api('/api/admin/demo/reset', { method: 'POST' });
      showLoading(false);
      
      if (result?.success) {
        showToast('All data cleared!', 'success');
        refreshDashboard();
      }
    }

    // ===========================================
    // PASSWORD MANAGEMENT
    // ===========================================
    
    // Password strength checker
    function checkPasswordStrength(password) {
      const strengthEl = document.getElementById('passwordStrength');
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');
      
      if (!password) {
        strengthEl.style.display = 'none';
        return;
      }
      
      strengthEl.style.display = 'block';
      
      let strength = 0;
      let feedback = [];
      
      // Length check
      if (password.length >= 12) strength += 25;
      else feedback.push('at least 12 characters');
      
      // Uppercase check
      if (/[A-Z]/.test(password)) strength += 25;
      else feedback.push('uppercase letters');
      
      // Lowercase check
      if (/[a-z]/.test(password)) strength += 25;
      else feedback.push('lowercase letters');
      
      // Number check
      if (/[0-9]/.test(password)) strength += 12.5;
      else feedback.push('numbers');
      
      // Special character check
      if (/[^A-Za-z0-9]/.test(password)) strength += 12.5;
      else feedback.push('special characters');
      
      // Display strength
      strengthBar.style.width = strength + '%';
      
      if (strength < 50) {
        strengthBar.style.background = '#f44336';
        strengthText.textContent = 'Weak';
        strengthText.style.color = '#f44336';
      } else if (strength < 75) {
        strengthBar.style.background = '#ff9800';
        strengthText.textContent = 'Medium';
        strengthText.style.color = '#ff9800';
      } else {
        strengthBar.style.background = '#4caf50';
        strengthText.textContent = 'Strong';
        strengthText.style.color = '#4caf50';
      }
      
      if (feedback.length > 0) {
        strengthText.textContent += ' - Add: ' + feedback.join(', ');
      }
    }
    
    // Add event listener for password input
    document.addEventListener('DOMContentLoaded', () => {
      const newPasswordInput = document.getElementById('newPassword');
      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', (e) => {
          checkPasswordStrength(e.target.value);
        });
      }
    });
    
    async function handlePasswordChange(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validation
      if (newPassword !== confirmPassword) {
        showToast('New passwords do not match', 'error');
        return;
      }
      
      if (newPassword.length < 12) {
        showToast('New password must be at least 12 characters', 'error');
        return;
      }
      
      // Check password strength requirements
      const hasUpper = /[A-Z]/.test(newPassword);
      const hasLower = /[a-z]/.test(newPassword);
      const hasNumber = /[0-9]/.test(newPassword);
      const hasSpecial = /[^A-Za-z0-9]/.test(newPassword);
      
      if (!hasUpper || !hasLower || !hasNumber || !hasSpecial) {
        showToast('Password must include uppercase, lowercase, numbers, and special characters', 'error');
        return;
      }
      
      if (currentPassword === newPassword) {
        showToast('New password must be different from current password', 'error');
        return;
      }
      
      if (!confirm('Changing your password will log you out. Continue?')) {
        return;
      }
      
      showLoading(true);
      
      const result = await api('/api/admin/change-password', {
        method: 'POST',
        body: JSON.stringify({
          currentPassword,
          newPassword
        })
      });
      
      showLoading(false);
      
      if (result?.success) {
        showToast('Password changed successfully! Logging out...', 'success');
        setTimeout(() => {
          localStorage.removeItem('adminToken');
          window.location.href = '/admin.html';
        }, 2000);
      } else {
        showToast(result?.error || 'Failed to change password', 'error');
      }
    }

    // ===========================================
    // EMAIL
    // ===========================================
    function openEmailModal(bookingId, email, name) {
      document.getElementById('emailBookingId').value = bookingId;
      document.getElementById('emailRecipient').textContent = `To: ${name} (${email})`;
      document.getElementById('emailSubject').value = '';
      document.getElementById('emailMessage').value = '';
      openModal('emailModal');
    }

    async function sendCustomEmail() {
      const bookingId = document.getElementById('emailBookingId').value;
      const subject = document.getElementById('emailSubject').value;
      const message = document.getElementById('emailMessage').value;

      if (!subject || !message) {
        showToast('Please enter subject and message', 'error');
        return;
      }

      showLoading(true);
      const result = await api(`/api/admin/send-custom-email/${bookingId}`, {
        method: 'POST',
        body: JSON.stringify({ subject, message })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Email sent!', 'success');
        closeModal('emailModal');
      }
    }

    // ===========================================
    // CLIENT MESSAGING
    // ===========================================
    function openClientMessageModal(id, type, name, email) {
      document.getElementById('clientMessageId').value = id;
      document.getElementById('clientMessageType').value = type;
      document.getElementById('clientMessageRecipient').textContent = `To: ${name} (${email})`;
      document.getElementById('clientMessageSubject').value = 'A Message from Ravi ü™∑';
      document.getElementById('clientMessageText').value = '';
      document.getElementById('proposedDate').value = '';
      document.getElementById('proposedTime').value = '';
      document.getElementById('includeTestimonialLink').checked = false;
      
      // Show proposed time fields for booking messages
      document.getElementById('proposedTimeGroup').style.display = type === 'booking' ? 'block' : 'none';
      
      openModal('clientMessageModal');
    }

    function openBookingMessageModal(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;
      openClientMessageModal(bookingId, 'booking', booking.name, booking.email);
    }

    function openClientDirectMessageModal(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      openClientMessageModal(clientId, 'client', client.name, client.email);
    }

    async function sendClientMessage() {
      const id = document.getElementById('clientMessageId').value;
      const type = document.getElementById('clientMessageType').value;
      const subject = document.getElementById('clientMessageSubject').value;
      const message = document.getElementById('clientMessageText').value;
      const proposedDate = document.getElementById('proposedDate').value;
      const proposedTime = document.getElementById('proposedTime').value;
      const includeTestimonialLink = document.getElementById('includeTestimonialLink').checked;

      if (!subject || !message) {
        showToast('Please enter subject and message', 'error');
        return;
      }

      showLoading(true);
      
      let endpoint = type === 'booking' 
        ? `/api/admin/bookings/${id}/message`
        : `/api/admin/clients/${id}/message`;
      
      const result = await api(endpoint, {
        method: 'POST',
        body: JSON.stringify({ 
          subject, 
          message, 
          proposedDate, 
          proposedTime,
          includeTestimonialLink
        })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Message sent successfully!', 'success');
        closeModal('clientMessageModal');
      } else {
        showToast(result?.error || 'Failed to send message', 'error');
      }
    }

    // ===========================================
    // PROPOSE TIME FUNCTIONS
    // ===========================================
    function openProposeTimeModal(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;
      
      document.getElementById('proposeBookingId').value = bookingId;
      document.getElementById('proposeBookingInfo').innerHTML = `
        <strong>${booking.name}</strong><br>
        <span style="color: var(--soft-gray);">${booking.serviceName} ‚Ä¢ $${booking.servicePrice}</span><br>
        <span style="color: var(--soft-gray);">Their availability: ${booking.availability || 'Not specified'}</span>
        ${booking.rescheduleAvailability ? `<br><span style="color: var(--burgundy);">üìù Reschedule request: ${booking.rescheduleAvailability}</span>` : ''}
      `;
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('proposeDate').min = today;
      document.getElementById('proposeDate').value = booking.proposedDate || '';
      document.getElementById('proposeTime').value = booking.proposedTime || '';
      document.getElementById('proposeMessage').value = '';
      
      openModal('proposeTimeModal');
    }

    async function sendProposal() {
      const bookingId = document.getElementById('proposeBookingId').value;
      const proposedDate = document.getElementById('proposeDate').value;
      const proposedTime = document.getElementById('proposeTime').value;
      const message = document.getElementById('proposeMessage').value;

      if (!proposedDate || !proposedTime) {
        showToast('Please select both date and time', 'error');
        return;
      }

      showLoading(true);
      
      const result = await api(`/api/admin/bookings/${bookingId}/propose`, {
        method: 'POST',
        body: JSON.stringify({ proposedDate, proposedTime, message })
      });
      
      showLoading(false);

      if (result?.success) {
        showToast('‚ú® Proposal sent to client!', 'success');
        closeModal('proposeTimeModal');
        loadBookings();
      } else {
        showToast(result?.error || 'Failed to send proposal', 'error');
      }
    }

    // ===========================================
    // AFTERCARE & UTILITIES
    // ===========================================
    async function sendAftercare(bookingId) {
      if (!confirm('Send aftercare email with testimonial link to this client?')) return;
      
      showLoading(true);
      const result = await api(`/api/admin/bookings/${bookingId}/aftercare`, { method: 'POST' });
      showLoading(false);

      if (result?.success) {
        showToast('Aftercare email sent!', 'success');
        loadBookings();
      } else {
        showToast(result?.error || 'Failed to send aftercare email', 'error');
      }
    }

    // ===========================================
    // UTILITIES
    // ===========================================
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úó' : '‚Ñπ'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      
      setTimeout(() => toast.remove(), 4000);
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // ===========================================
    // INIT
    // ===========================================
    if (token) {
      showDashboard();
    }
  </script>

  <div style="position: fixed; bottom: 0; right: 0; padding: 8px 16px; font-size: 11px; color: #9E9890; background: rgba(253, 248, 243, 0.95); border-top-left-radius: 8px; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); z-index: 9999;">
    <p style="margin: 0;">Built by <a href="mailto:Anth@StructuredForGrowth.com" style="color: #722F37; text-decoration: none;">Anth@StructuredForGrowth.com</a></p>
  </div>
</body>
</html>
