<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin Dashboard | Ravi Sacred Healing</title>
  <style>
    :root {
      --burgundy: #722F37;
      --burgundy-light: #8B3A44;
      --burgundy-dark: #5C252C;
      --cream: #FDF8F3;
      --warm-white: #FEFCFA;
      --gold: #D4AF37;
      --gold-light: #F0E6C8;
      --charcoal: #3D3630;
      --soft-gray: #9E9890;
      --success: #4CAF50;
      --warning: #FF9800;
      --danger: #f44336;
      --info: #2196F3;
      /* Dark mode vars */
      --bg-primary: #FDF8F3;
      --bg-secondary: #FEFCFA;
      --bg-card: white;
      --text-primary: #3D3630;
      --text-secondary: #9E9890;
      --border-color: #e0d6cc;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --cream: #1a1a1a;
      --warm-white: #242424;
      --bg-primary: #1a1a1a;
      --bg-secondary: #242424;
      --bg-card: #2d2d2d;
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --charcoal: #e8e8e8;
      --soft-gray: #a0a0a0;
      --border-color: #404040;
    }

    [data-theme="dark"] .sidebar {
      background: #242424;
      border-right-color: #404040;
    }

    [data-theme="dark"] .card,
    [data-theme="dark"] .stat-card,
    [data-theme="dark"] .modal,
    [data-theme="dark"] .client-card,
    [data-theme="dark"] .booking-card,
    [data-theme="dark"] .template-btn,
    [data-theme="dark"] .insight-card,
    [data-theme="dark"] .timeline-content {
      background: var(--bg-card);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .insights-panel {
      background: linear-gradient(135deg, #2d2520 0%, #1a1a1a 100%);
      border-color: #5c4a3a;
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .client-filter-btn {
      background: var(--bg-card);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .client-filter-btn.active {
      background: var(--burgundy);
      color: white;
    }

    [data-theme="dark"] table th {
      background: #2d2d2d;
    }

    [data-theme="dark"] table td {
      border-color: var(--border-color);
    }

    [data-theme="dark"] .detail-grid {
      background: var(--bg-card);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Global subtle animations */
    *, *::before, *::after {
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    /* Page fade in */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .page.active {
      animation: fadeInUp 0.3s ease;
    }

    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    [data-theme="dark"] .skeleton {
      background: linear-gradient(90deg, #2d2d2d 25%, #3d3d3d 50%, #2d2d2d 75%);
      background-size: 200% 100%;
    }

    /* Card hover effects */
    .client-card, .insight-card, .stat-card {
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    /* Button press effect */
    .btn:active {
      transform: scale(0.98);
    }

    /* Badge pulse for new items */
    .badge.gold-badge {
      animation: pulse 2s infinite;
    }

    /* Smooth modal transitions */
    .modal-overlay {
      transition: opacity 0.2s ease;
    }

    .modal-overlay.active .modal {
      animation: fadeInUp 0.25s ease;
    }

    /* Focus states for accessibility */
    button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
      outline: 2px solid var(--gold);
      outline-offset: 2px;
    }

    /* Hover ripple effect for nav items */
    .nav-item::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .nav-item:hover::after {
      opacity: 1;
    }

    .nav-item {
      position: relative;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--cream);
      color: var(--charcoal);
      line-height: 1.6;
    }

    /* ============ LOGIN ============ */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-dark) 100%);
    }

    .login-card {
      background: var(--warm-white);
      padding: 40px;
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-card h1 {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 28px;
      color: var(--burgundy);
      text-align: center;
      margin-bottom: 30px;
    }

    .login-card input {
      width: 100%;
      padding: 14px 18px;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
      transition: border-color 0.3s;
    }

    .login-card input:focus {
      outline: none;
      border-color: var(--burgundy);
    }

    .login-card button {
      width: 100%;
      padding: 14px;
      background: var(--burgundy);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .login-card button:hover {
      background: var(--burgundy-dark);
      transform: translateY(-2px);
    }

    .login-error {
      color: var(--danger);
      text-align: center;
      margin-top: 16px;
      display: none;
    }

    /* ============ DASHBOARD LAYOUT ============ */
    .dashboard { display: none; }
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: linear-gradient(180deg, var(--burgundy) 0%, var(--burgundy-dark) 100%);
      color: white;
      padding: 20px 0;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s;
    }

    .sidebar-header {
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .sidebar-header h2 {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 24px;
      margin-bottom: 4px;
    }

    .sidebar-header small {
      opacity: 0.7;
      font-size: 12px;
    }

    .nav-menu { list-style: none; }

    .nav-item {
      padding: 14px 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
      border-left: 3px solid transparent;
      user-select: none;
      -webkit-user-select: none;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255,255,255,0.1);
      border-left-color: var(--gold);
    }

    .nav-item.active {
      background: rgba(255,255,255,0.15);
    }

    .nav-icon {
      width: 20px;
      text-align: center;
      font-size: 16px;
      pointer-events: none;
    }
    
    .nav-item .badge {
      pointer-events: none;
    }

    .nav-divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 16px 0;
    }

    /* Theme Toggle */
    .theme-toggle {
      margin: 16px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.2);
    }

    [data-theme="dark"] .theme-toggle {
      background: rgba(255,255,255,0.05);
    }

    .main-content {
      margin-left: 260px;
      padding: 24px;
      min-height: 100vh;
    }

    /* ============ PAGES ============ */
    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    /* ============ HEADER ============ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 32px;
      color: var(--burgundy);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* ============ STATS CARDS ============ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      border-left: 4px solid var(--burgundy);
    }

    .stat-card.success { border-left-color: var(--success); }
    .stat-card.warning { border-left-color: var(--warning); }
    .stat-card.info { border-left-color: var(--info); }
    .stat-card.gold { border-left-color: var(--gold); }

    .stat-label {
      font-size: 13px;
      color: var(--soft-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 600;
      color: var(--charcoal);
    }

    .stat-change {
      font-size: 13px;
      margin-top: 8px;
    }

    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }

    /* ============ SMART INSIGHTS ============ */
    .insights-panel {
      background: linear-gradient(135deg, #fff9f0 0%, #fff5eb 100%);
      border: 2px solid #ffd9b3;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
    }

    .insight-count {
      background: var(--burgundy);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
    }

    .insights-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .insight-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.2s;
      cursor: pointer;
    }

    .insight-card:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .insight-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      flex-shrink: 0;
    }

    .insight-icon.urgent { background: #ffebee; }
    .insight-icon.important { background: #fff3e0; }
    .insight-icon.info { background: #e3f2fd; }
    .insight-icon.success { background: #e8f5e9; }

    .insight-content {
      flex: 1;
    }

    .insight-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .insight-desc {
      font-size: 13px;
      color: var(--soft-gray);
    }

    .insight-action {
      padding: 8px 16px;
      background: var(--burgundy);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      white-space: nowrap;
    }

    .insight-action:hover {
      background: var(--burgundy-light);
    }

    .insights-empty {
      text-align: center;
      padding: 32px;
      color: var(--soft-gray);
    }

    /* ============ BUTTONS ============ */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--burgundy);
      color: white;
    }

    .btn-primary:hover {
      background: var(--burgundy-dark);
    }

    .btn-secondary {
      background: var(--gold-light);
      color: var(--charcoal);
    }

    .btn-secondary:hover {
      background: var(--gold);
      color: white;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-outline {
      background: transparent;
      border: 2px solid var(--burgundy);
      color: var(--burgundy);
    }

    .btn-outline:hover {
      background: var(--burgundy);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-icon {
      padding: 8px;
      min-width: auto;
    }

    /* ============ MESSAGE TEMPLATES ============ */
    .template-btn {
      padding: 6px 12px;
      border: 1px solid #e0d6cc;
      border-radius: 16px;
      background: #faf8f5;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .template-btn:hover {
      background: var(--burgundy);
      color: white;
      border-color: var(--burgundy);
      transform: translateY(-1px);
    }

    /* ============ CARDS & PANELS ============ */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 24px;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 20px;
      color: var(--burgundy);
    }

    .card-body {
      padding: 24px;
    }

    /* ============ TABLES ============ */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: var(--cream);
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--soft-gray);
    }

    tr:hover {
      background: #faf8f5;
    }

    /* ============ STATUS BADGES ============ */
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-confirmed { background: #d4edda; color: #155724; }
    .badge-completed { background: #cce5ff; color: #004085; }
    .badge-cancelled { background: #f8d7da; color: #721c24; }

    /* ============ FORMS ============ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--charcoal);
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--burgundy);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    /* ============ TABS ============ */
    .tabs {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      font-weight: 500;
      color: var(--soft-gray);
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--burgundy);
    }

    .tab.active {
      color: var(--burgundy);
      border-bottom-color: var(--burgundy);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* ============ MODAL ============ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 24px;
      color: var(--burgundy);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--soft-gray);
      line-height: 1;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    /* ============ SEARCH ============ */
    .search-box {
      position: relative;
    }

    .search-input {
      padding: 10px 16px 10px 40px;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      font-size: 14px;
      width: 250px;
      transition: all 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--burgundy);
      width: 300px;
    }

    .search-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--soft-gray);
    }

    /* ============ CALENDAR ============ */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 20px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
    }

    .calendar-day-header {
      padding: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      color: var(--soft-gray);
      text-transform: uppercase;
    }

    .calendar-day {
      aspect-ratio: 1;
      padding: 8px;
      border: 1px solid #eee;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      min-height: 80px;
    }

    .calendar-day:hover {
      border-color: var(--burgundy);
      background: #faf8f5;
    }

    .calendar-day.other-month {
      color: #ccc;
      background: #f9f9f9;
    }

    .calendar-day.today {
      border-color: var(--gold);
      border-width: 2px;
    }

    .calendar-day.blocked {
      background: #f8d7da;
    }

    .calendar-day.has-event {
      background: #d4edda;
    }

    .calendar-event {
      font-size: 10px;
      padding: 2px 4px;
      background: var(--burgundy);
      color: white;
      border-radius: 4px;
      margin-top: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .calendar-event.pending {
      background: #ffc107;
      color: #333;
      border: 1px dashed #ff9800;
    }
    
    .calendar-event.confirmed {
      background: var(--burgundy);
      color: white;
    }

    /* ============ CLIENT LIST ============ */
    .clients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .client-card {
      display: flex;
      flex-direction: column;
      padding: 20px;
      border: 2px solid #e0d6cc;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      position: relative;
    }

    .client-card:hover {
      border-color: var(--burgundy);
      box-shadow: 0 8px 24px rgba(114, 47, 55, 0.15);
      transform: translateY(-2px);
    }

    .client-card.has-unread {
      border-color: var(--gold);
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, white 100%);
    }

    .client-card.suspended {
      border-color: var(--warning);
      background: #fff8e6;
      opacity: 0.85;
    }

    .client-card.banned {
      border-color: var(--danger);
      background: #ffebee;
      opacity: 0.7;
    }

    /* Client Tier Badge */
    .client-tier-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Journey Timeline */
    .journey-timeline {
      position: relative;
      padding-left: 24px;
    }

    .journey-timeline::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, var(--burgundy), #e0d6cc);
    }

    .timeline-event {
      position: relative;
      padding-bottom: 24px;
      padding-left: 24px;
    }

    .timeline-event:last-child {
      padding-bottom: 0;
    }

    .timeline-dot {
      position: absolute;
      left: -24px;
      width: 24px;
      height: 24px;
      background: white;
      border: 3px solid var(--event-color, var(--burgundy));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      z-index: 1;
    }

    .timeline-content {
      background: #faf8f5;
      padding: 12px 16px;
      border-radius: 8px;
      border-left: 3px solid var(--event-color, var(--burgundy));
    }

    .timeline-event.milestone .timeline-content {
      background: linear-gradient(135deg, #fff8e1 0%, #fffde7 100%);
    }

    .timeline-date {
      font-size: 11px;
      color: var(--soft-gray);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .timeline-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .timeline-desc {
      font-size: 13px;
      color: var(--soft-gray);
    }

    .client-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      margin-top: 8px;
    }

    .client-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-light) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 20px;
      flex-shrink: 0;
      position: relative;
    }

    .client-avatar .message-dot {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 18px;
      height: 18px;
      background: var(--gold);
      border-radius: 50%;
      border: 2px solid white;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }

    .client-info {
      flex: 1;
      min-width: 0;
    }

    .client-info h4 {
      font-size: 16px;
      margin-bottom: 2px;
      color: var(--charcoal);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .client-info h4 .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }

    .client-info h4 .status-indicator.suspended {
      background: var(--warning);
    }

    .client-info h4 .status-indicator.banned {
      background: var(--danger);
    }

    .client-info p {
      font-size: 13px;
      color: var(--soft-gray);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .client-stats-row {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f0ebe4;
    }

    .client-stat {
      text-align: center;
      flex: 1;
    }

    .client-stat-value {
      font-size: 18px;
      font-weight: 600;
      color: var(--burgundy);
    }

    .client-stat-label {
      font-size: 11px;
      color: var(--soft-gray);
      text-transform: uppercase;
    }

    .client-quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .client-quick-actions .btn {
      flex: 1;
      justify-content: center;
      padding: 8px 12px;
      font-size: 13px;
    }

    /* Client Status Badges */
    .client-status-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .client-status-badge.suspended {
      background: #fff3cd;
      color: #856404;
    }

    .client-status-badge.banned {
      background: #f8d7da;
      color: #721c24;
    }

    /* Filter tabs for clients */
    .client-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .client-filter-btn {
      padding: 8px 12px;
      border: 2px solid #e0d6cc;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .client-filter-btn:hover {
      border-color: var(--burgundy);
    }

    .client-filter-btn.active {
      background: var(--burgundy);
      color: white;
      border-color: var(--burgundy);
    }

    .filter-count {
      font-size: 11px;
      background: rgba(0,0,0,0.1);
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    .client-filter-btn.active .filter-count {
      background: rgba(255,255,255,0.25);
    }

    .filter-count.badge-alert {
      background: #f44336;
      color: white;
    }

    .client-filter-btn.active .filter-count.badge-alert {
      background: #ffcdd2;
      color: #b71c1c;
    }

    .msg-badge {
      font-size: 10px;
      background: #ff5722;
      color: white;
      padding: 2px 5px;
      border-radius: 8px;
      margin-left: 2px;
      display: none;
    }

    .msg-badge.has-messages {
      display: inline-block;
    }

    .tier-filters {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #eee;
    }

    .filter-label {
      font-size: 12px;
      color: #666;
      margin-right: 8px;
      font-weight: 500;
    }

    /* Mobile filter styles */
    @media (max-width: 768px) {
      .client-filters {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .client-filter-btn {
        padding: 10px 8px;
        font-size: 12px;
        justify-content: center;
        text-align: center;
      }

      .tier-filters {
        grid-template-columns: repeat(2, 1fr);
      }

      .filter-label {
        grid-column: 1 / -1;
        text-align: center;
        margin-bottom: 4px;
      }
    }

    @media (max-width: 480px) {
      .client-filter-btn {
        padding: 12px 6px;
        font-size: 11px;
        flex-direction: column;
        gap: 2px;
      }

      .filter-count, .msg-badge {
        font-size: 10px;
      }
    }

    /* ============ TOAST NOTIFICATIONS ============ */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      padding: 16px 24px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-left: 4px solid var(--success); }
    .toast.error { border-left: 4px solid var(--danger); }
    .toast.info { border-left: 4px solid var(--info); }

    /* ============ LOADING ============ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 400;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--burgundy);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ============ EMPTY STATE ============ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--soft-gray);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--charcoal);
    }

    /* ============ DETAIL VIEW ============ */
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }

    .detail-item {
      margin-bottom: 20px;
    }

    .detail-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--soft-gray);
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 16px;
      color: var(--charcoal);
    }

    /* ============ MOBILE RESPONSIVE ============ */
    .mobile-menu-btn {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--burgundy);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      z-index: 150;
      box-shadow: 0 4px 20px rgba(114, 47, 55, 0.4);
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .search-input {
        width: 100%;
      }

      .search-input:focus {
        width: 100%;
      }

      .modal {
        max-height: 100vh;
        border-radius: 0;
      }

      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }

      /* Mobile clients grid */
      .clients-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .client-card {
        padding: 16px;
      }

      .client-avatar {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }

      .client-tier-badge {
        font-size: 10px;
        padding: 3px 8px;
      }

      .client-card-footer {
        flex-wrap: wrap;
      }

      .client-stat {
        font-size: 11px;
      }

      /* Mobile tabs in modal */
      .tabs {
        justify-content: space-around;
      }

      .tab {
        padding: 10px 8px;
        font-size: 12px;
        flex: 1;
        text-align: center;
      }

      /* Mobile modal body */
      .modal-body {
        max-height: calc(100vh - 180px) !important;
      }

      /* Tier management mobile */
      .tier-management-section {
        flex-direction: column;
      }

      .tier-select-group {
        width: 100%;
      }
    }

    /* ============ CALENDLY-STYLE AVAILABILITY ============ */
    .weekly-availability-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    .availability-day-card {
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
    }

    .availability-day-card.disabled {
      background: #f5f5f5;
      opacity: 0.6;
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0d6cc;
    }

    .day-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--charcoal);
    }

    .day-toggle {
      position: relative;
      width: 52px;
      height: 28px;
    }

    .day-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .day-toggle input:checked + .toggle-slider {
      background-color: var(--burgundy);
    }

    .day-toggle input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    .time-slots-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }

    .time-slot-btn {
      padding: 10px 12px;
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: var(--charcoal);
      text-align: center;
      transition: all 0.2s;
      font-weight: 500;
    }

    .time-slot-btn:hover:not(.selected) {
      border-color: var(--burgundy);
      background: var(--gold-light);
    }

    .time-slot-btn.selected {
      background: var(--burgundy);
      color: white;
      border-color: var(--burgundy);
    }

    .time-slot-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .slot-duration-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--gold-light);
      border-radius: 8px;
    }

    .slot-duration-selector label {
      font-size: 14px;
      font-weight: 600;
      color: var(--charcoal);
      margin-right: 8px;
    }

    .slot-duration-selector input[type="radio"] {
      margin-right: 6px;
    }

    .availability-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 2px solid #e0d6cc;
    }

    .availability-summary {
      background: var(--gold-light);
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      color: var(--charcoal);
    }

    .availability-summary strong {
      color: var(--burgundy);
    }

    /* ============ MARKETING COMPONENTS ============ */
    .template-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .template-card {
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }

    .template-card:hover {
      border-color: var(--burgundy);
      box-shadow: 0 8px 24px rgba(114, 47, 55, 0.15);
      transform: translateY(-4px);
    }

    .template-preview {
      height: 200px;
      background: linear-gradient(135deg, var(--gold-light) 0%, var(--cream) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      border-bottom: 1px solid #e0d6cc;
    }

    .template-info {
      padding: 16px;
    }

    .template-name {
      font-weight: 600;
      font-size: 16px;
      color: var(--charcoal);
      margin-bottom: 6px;
    }

    .template-description {
      font-size: 13px;
      color: var(--soft-gray);
      line-height: 1.5;
    }

    .campaign-item, .segment-item, .workflow-item {
      background: white;
      border: 2px solid #e0d6cc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .campaign-item:hover, .segment-item:hover, .workflow-item:hover {
      border-color: var(--burgundy);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .campaign-header, .segment-header, .workflow-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .campaign-title, .segment-title, .workflow-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--burgundy);
      margin-bottom: 6px;
    }

    .campaign-meta, .segment-meta, .workflow-meta {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      font-size: 14px;
      color: var(--soft-gray);
    }

    .campaign-meta span, .segment-meta span, .workflow-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .campaign-actions, .segment-actions, .workflow-actions {
      display: flex;
      gap: 8px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.draft {
      background: var(--soft-gray);
      color: white;
    }

    .status-badge.scheduled {
      background: var(--info);
      color: white;
    }

    .status-badge.sent {
      background: var(--success);
      color: white;
    }

    .status-badge.active {
      background: var(--burgundy);
      color: white;
    }

    .status-badge.paused {
      background: var(--warning);
      color: white;
    }

    .analytics-chart {
      background: white;
      border: 1px solid #e0d6cc;
      border-radius: 8px;
      padding: 20px;
      min-height: 200px;
    }

    .lifecycle-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--gold-light);
      border-radius: 8px;
    }

    .lifecycle-label {
      min-width: 120px;
      font-weight: 600;
      color: var(--charcoal);
    }

    .lifecycle-progress {
      flex: 1;
      height: 24px;
      background: #e0d6cc;
      border-radius: 12px;
      overflow: hidden;
    }

    .lifecycle-progress-fill {
      height: 100%;
      background: var(--burgundy);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: 600;
    }

    .lifecycle-count {
      min-width: 60px;
      text-align: right;
      font-weight: 600;
      color: var(--burgundy);
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--warm-white);
      border-radius: 16px;
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 2px solid #e0d6cc;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-family: Georgia, 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
      font-size: 24px;
      color: var(--burgundy);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--soft-gray);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--burgundy);
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 2px solid #e0d6cc;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .segment-filter {
      background: var(--gold-light);
      border: 1px solid #e0d6cc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .segment-filter-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .segment-filter-row select, .segment-filter-row input {
      flex: 1;
      min-width: 150px;
    }

    .workflow-step {
      background: white;
      border: 2px solid var(--burgundy);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      position: relative;
    }

    .workflow-step::after {
      content: 'â†“';
      display: block;
      text-align: center;
      font-size: 24px;
      color: var(--burgundy);
      margin: 8px 0 -8px 0;
    }

    .workflow-step:last-child::after {
      display: none;
    }

    .workflow-step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .workflow-step-title {
      font-weight: 600;
      color: var(--burgundy);
    }

    .email-preview {
      background: white;
      border: 1px solid #e0d6cc;
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }

    .email-preview-subject {
      font-size: 18px;
      font-weight: 600;
      color: var(--charcoal);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e0d6cc;
    }

    .email-preview-body {
      line-height: 1.7;
      color: var(--charcoal);
    }

    /* ============ PRINT STYLES ============ */
    @media print {
      .sidebar, .mobile-menu-btn, .btn, .toast-container, .page-header, .card-header {
        display: none !important;
      }

      .main-content {
        margin-left: 0;
      }

      .card {
        box-shadow: none;
        border: none;
      }
      
      .business-card {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      /* Remove screen-only elements from print */
      body * {
        visibility: hidden;
      }
      
      #printableCards, #printableCards * {
        visibility: visible;
      }
      
      #printableCards {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
    
    /* Business Card Styles */
    .business-card {
      width: 3.5in;
      height: 2in;
      border: 2px solid #D4AF37;
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      display: inline-block;
      background: linear-gradient(135deg, #ffffff 0%, #fdfaf5 50%, #fff8f0 100%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      page-break-inside: avoid;
      position: relative;
      overflow: hidden;
    }
    
    .business-card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
      pointer-events: none;
    }
    
    @media print {
      .business-card {
        margin: 0.25in;
        box-shadow: none;
      }
    }

    /* ============ QUICK ACTIONS ============ */
    .quick-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      background: #f0f0f0;
      color: var(--charcoal);
    }

    .action-btn:hover {
      background: var(--burgundy);
      color: white;
    }

    /* ============ CONTENT EDITOR ============ */
    .content-item {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      position: relative;
    }

    .content-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .content-item-actions {
      display: flex;
      gap: 8px;
    }

    .content-item h4 {
      font-size: 16px;
      color: var(--burgundy);
      margin-bottom: 8px;
    }

    .content-item p {
      font-size: 14px;
      color: var(--charcoal);
      white-space: pre-wrap;
    }

    .content-item.inactive {
      opacity: 0.5;
      border-style: dashed;
    }

    .drag-handle {
      cursor: grab;
      color: var(--soft-gray);
      margin-right: 8px;
    }

    /* ============ REVENUE CHART ============ */
    .revenue-chart {
      height: 200px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 20px 0;
    }

    .revenue-bar {
      flex: 1;
      background: linear-gradient(to top, var(--burgundy), var(--burgundy-light));
      border-radius: 4px 4px 0 0;
      position: relative;
      min-height: 20px;
    }

    .revenue-bar:hover {
      background: linear-gradient(to top, var(--burgundy-dark), var(--burgundy));
    }

    .revenue-bar span {
      position: absolute;
      bottom: -20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--soft-gray);
    }

    /* ============ LEAD GENERATION STYLES ============ */
    .funnel-visual {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      background: linear-gradient(135deg, rgba(155, 89, 182, 0.05), rgba(52, 152, 219, 0.05));
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .funnel-stage {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .funnel-count {
      font-size: 24px;
      font-weight: 700;
      color: var(--burgundy);
      min-width: 60px;
      text-align: right;
    }

    .funnel-label {
      font-weight: 600;
      color: var(--text);
      min-width: 100px;
    }

    .funnel-bar {
      height: 36px;
      border-radius: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
    }

    .funnel-bar:hover {
      transform: scaleX(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .conversion-metrics {
      display: flex;
      justify-content: space-around;
      padding: 15px;
      background: white;
      border-radius: 8px;
      margin-top: 10px;
    }

    .metric {
      text-align: center;
    }

    .metric span {
      display: block;
      font-size: 13px;
      color: var(--soft-gray);
      margin-bottom: 5px;
    }

    .metric strong {
      font-size: 20px;
      color: var(--burgundy);
    }

    .filter-chips {
      display: flex;
      gap: 8px;
    }

    .chip {
      padding: 6px 16px;
      border-radius: 20px;
      border: 2px solid var(--border);
      background: white;
      color: var(--text);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .chip:hover {
      border-color: var(--burgundy);
      background: var(--background);
    }

    .chip.active {
      border-color: var(--burgundy);
      background: var(--burgundy);
      color: white;
    }

    .leads-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lead-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .lead-item:hover {
      border-color: var(--burgundy);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }

    .lead-info {
      flex: 1;
    }

    .lead-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .lead-email {
      font-size: 13px;
      color: var(--soft-gray);
    }

    .lead-source {
      font-size: 12px;
      color: var(--gold);
      margin-top: 4px;
    }

    .lead-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .lead-status.new {
      background: #e3f2fd;
      color: #1976d2;
    }

    .lead-status.contacted {
      background: #fff3e0;
      color: #f57c00;
    }

    .lead-status.qualified {
      background: #e8f5e9;
      color: #388e3c;
    }

    .lead-status.converted {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .lead-magnet-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .lead-magnet-card:hover {
      border-color: var(--burgundy);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      transform: translateY(-4px);
    }

    .magnet-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .magnet-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--burgundy);
      margin-bottom: 8px;
    }

    .magnet-type {
      display: inline-block;
      padding: 4px 12px;
      background: var(--gold);
      color: white;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .magnet-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--border);
    }

    .magnet-stat {
      text-align: center;
    }

    .magnet-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--burgundy);
    }

    .magnet-stat-label {
      font-size: 11px;
      color: var(--soft-gray);
      text-transform: uppercase;
      margin-top: 4px;
    }

    .drip-campaigns-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .drip-campaign-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s ease;
    }

    .drip-campaign-item:hover {
      border-color: var(--burgundy);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .drip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .drip-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .drip-timeline {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .drip-email {
      flex: 1;
      padding: 12px;
      background: var(--background);
      border-radius: 8px;
      border-left: 4px solid var(--burgundy);
    }

    .drip-email-day {
      font-size: 11px;
      color: var(--gold);
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .drip-email-subject {
      font-size: 13px;
      color: var(--text);
      font-weight: 500;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 0;
    }

    .tabs .tab {
      padding: 12px 20px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      color: var(--soft-gray);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: -2px;
    }

    .tabs .tab:hover {
      color: var(--burgundy);
      background: var(--background);
    }

    .tabs .tab.active {
      color: var(--burgundy);
      border-bottom-color: var(--burgundy);
    }

    /* Additional utility classes */
    .badge-gold {
      background: var(--gold);
    }

    .btn-gold {
      background: var(--gold) !important;
    }

    .text-muted {
      color: var(--soft-gray);
    }

    .mt-8 {
      margin-top: 8px;
    }

    .mt-20 {
      margin-top: 20px;
    }

    .mb-20 {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div class="login-container" id="loginScreen">
    <div class="login-card">
      <h1>ðŸª· Admin Dashboard</h1>
      <form id="loginForm">
        <input type="text" id="loginUsername" placeholder="Username" required autocomplete="username">
        <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
        <button type="submit">Sign In</button>
        <p class="login-error" id="loginError">Invalid credentials</p>
      </form>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="dashboard" id="dashboard">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>ðŸª· Ravi</h2>
        <small>Admin Dashboard</small>
      </div>
      <ul class="nav-menu">
        <li class="nav-item active" data-page="overview">
          <span class="nav-icon">ðŸ“Š</span> Overview
        </li>
        <li class="nav-item" data-page="bookings">
          <span class="nav-icon">ðŸ“‹</span> Bookings
        </li>
        <li class="nav-item" data-page="calendar">
          <span class="nav-icon">ðŸ“…</span> Calendar
        </li>
        <li class="nav-item" data-page="clients">
          <span class="nav-icon">ðŸ‘¥</span> Clients
        </li>
        <li class="nav-item" data-page="invitations">
          <span class="nav-icon">ðŸŽŸï¸</span> Invitation Codes
        </li>
        <li class="nav-item" data-page="inquiries">
          <span class="nav-icon">ðŸ“¬</span> Inquiries <span id="inquiriesBadge" class="badge gold-badge display-none">0</span>
        </li>
        <li class="nav-item" data-page="messages">
          <span class="nav-icon">ðŸ’¬</span> Messages <span id="messagesBadge" class="badge gold-badge display-none">0</span>
        </li>
        <li class="nav-divider" aria-hidden="true"></li>
        <li class="nav-item" data-page="marketing">
          <span class="nav-icon">ðŸ“§</span> Marketing <span class="badge badge-gold">NEW</span>
        </li>
        <li class="nav-item" data-page="content">
          <span class="nav-icon">âœï¸</span> Content
        </li>
        <li class="nav-item" data-page="settings">
          <span class="nav-icon">âš™ï¸</span> Settings
        </li>
        <li class="nav-divider" aria-hidden="true"></li>
        <li class="nav-item" data-page="export">
          <span class="nav-icon">ðŸ“¤</span> Export & Backup
        </li>
        <li class="nav-item" data-page="help">
          <span class="nav-icon">ðŸ“š</span> User Guide
        </li>
        <li class="nav-item" id="logoutBtn">
          <span class="nav-icon">ðŸšª</span> Logout
        </li>
      </ul>
      
      <!-- Dark Mode Toggle -->
      <div class="theme-toggle" onclick="toggleDarkMode()">
        <span id="themeIcon">ðŸŒ™</span>
        <span id="themeLabel">Dark Mode</span>
      </div>
    </aside>

    <!-- MOBILE MENU BUTTON -->
    <button class="mobile-menu-btn" id="mobileMenuBtn">â˜°</button>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- OVERVIEW PAGE -->
      <section class="page active" id="page-overview">
        <div class="page-header">
          <h1 class="page-title">Dashboard Overview</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshDashboard()">ðŸ”„ Refresh</button>
          </div>
        </div>

        <div class="stats-grid" id="statsGrid">
          <!-- Stats populated by JS -->
        </div>

        <!-- Smart Insights Panel -->
        <div class="insights-panel" id="insightsPanel">
          <h3 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
            ðŸŽ¯ Action Items
            <span class="insight-count" id="insightCount">0</span>
          </h3>
          <div id="insightsList" class="insights-list">
            <!-- Populated by JS -->
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Booking Requests</h3>
            <a href="#" onclick="showPage('bookings')" class="btn btn-sm btn-outline">View All</a>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="recentBookingsTable">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Revenue Overview</h3>
          </div>
          <div class="card-body">
            <div class="revenue-chart" id="revenueChart">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- BOOKINGS PAGE -->
      <section class="page" id="page-bookings">
        <div class="page-header">
          <h1 class="page-title">Bookings</h1>
          <div class="header-actions">
            <div class="search-box">
              <span class="search-icon">ðŸ”</span>
              <input type="text" class="search-input" id="bookingSearch" placeholder="Search bookings...">
            </div>
            <select class="form-select form-select-auto" id="statusFilter">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Contact</th>
                    <th>Service</th>
                    <th>Price</th>
                    <th>Status</th>
                    <th>Scheduled</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bookingsTable">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- CALENDAR PAGE -->
      <section class="page" id="page-calendar">
        <div class="page-header">
          <h1 class="page-title">Calendar</h1>
          <div style="display: flex; gap: 16px; font-size: 12px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 16px; height: 16px; background: var(--burgundy); border-radius: 3px;"></div>
              <span>Confirmed</span>
            </div>
            <div style="display: flex; align-items: center; gap: 6px;">
              <div style="width: 16px; height: 16px; background: #ffc107; border: 1px dashed #ff9800; border-radius: 3px;"></div>
              <span>Pending</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="calendar-header">
              <h3 id="calendarTitle">December 2024</h3>
              <div class="calendar-nav">
                <button class="btn btn-sm btn-outline" id="prevMonth">â† Prev</button>
                <button class="btn btn-sm btn-outline" id="todayBtn">Today</button>
                <button class="btn btn-sm btn-outline" id="nextMonth">Next â†’</button>
              </div>
            </div>
            <div class="calendar" id="calendarGrid">
              <!-- Calendar populated by JS -->
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Upcoming Sessions</h3>
          </div>
          <div class="card-body" id="upcomingList">
            <!-- Populated by JS -->
          </div>
        </div>

        <!-- Appointment Reminders Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">â° Appointment Reminders</h3>
            <button class="btn btn-sm btn-outline" onclick="loadReminders()">ðŸ”„ Refresh</button>
          </div>
          <div class="card-body" id="remindersCard">
            <p style="color: var(--soft-gray); text-align: center; padding: 20px;">
              Reminders are automatically sent 24 hours and 1 hour before confirmed sessions.
            </p>
            <div id="remindersList"></div>
          </div>
        </div>
      </section>

      <!-- CLIENTS PAGE -->
      <section class="page" id="page-clients">
        <div class="page-header">
          <h1 class="page-title">ðŸ‘¥ Client Navigator</h1>
          <div class="header-actions">
            <div class="search-box">
              <span class="search-icon">ðŸ”</span>
              <input type="text" class="search-input" id="clientSearch" placeholder="Search clients...">
            </div>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card stat-card-gold">
            <div class="stat-label">ðŸ’¬ Need Response</div>
            <div class="stat-value" id="clientsNeedResponseCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Clients</div>
            <div class="stat-value" id="totalClientsCount">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Repeat Clients</div>
            <div class="stat-value" id="repeatClientsCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Lifetime Value</div>
            <div class="stat-value" id="totalLifetimeValue">$0</div>
          </div>
        </div>

        <!-- Filter Tabs -->
        <div class="client-filters" id="clientFilters">
          <button class="client-filter-btn active" data-filter="all" id="filter-all" onclick="filterClients('all')">All <span class="filter-count" id="count-all"></span></button>
          <button class="client-filter-btn" data-filter="unread" id="filter-unread" onclick="filterClients('unread')">ðŸ’¬ Unread <span class="filter-count badge-alert" id="count-unread"></span></button>
          <button class="client-filter-btn" data-filter="active" id="filter-active" onclick="filterClients('active')">âœ“ Active <span class="filter-count" id="count-active"></span></button>
          <button class="client-filter-btn" data-filter="suspended" id="filter-suspended" onclick="filterClients('suspended')">âš ï¸ Suspended <span class="filter-count" id="count-suspended"></span></button>
          <button class="client-filter-btn" data-filter="banned" id="filter-banned" onclick="filterClients('banned')">ðŸš« Banned <span class="filter-count" id="count-banned"></span></button>
        </div>
        <div class="client-filters tier-filters" id="tierFilters">
          <span class="filter-label">By Tier:</span>
          <button class="client-filter-btn tier-btn" data-filter="favored" id="filter-favored" onclick="filterClients('favored')">ðŸ’Ž Favored <span class="filter-count" id="count-favored"></span><span class="msg-badge" id="msg-favored"></span></button>
          <button class="client-filter-btn tier-btn" data-filter="vip" id="filter-vip" onclick="filterClients('vip')">â­ VIP <span class="filter-count" id="count-vip"></span><span class="msg-badge" id="msg-vip"></span></button>
          <button class="client-filter-btn tier-btn" data-filter="regular" id="filter-regular" onclick="filterClients('regular')">ðŸŒ³ Regular <span class="filter-count" id="count-regular"></span><span class="msg-badge" id="msg-regular"></span></button>
          <button class="client-filter-btn tier-btn" data-filter="new" id="filter-new" onclick="filterClients('new')">ðŸŒ± New <span class="filter-count" id="count-new"></span><span class="msg-badge" id="msg-new"></span></button>
        </div>

        <div class="clients-grid" id="clientsList">
          <!-- Populated by JS -->
        </div>
      </section>

      <!-- INVITATION CODES PAGE -->
      <section class="page" id="page-invitations">
        <div class="page-header">
          <h1 class="page-title">ðŸŽŸï¸ Invitation Codes</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="printCodes()">ðŸ–¨ï¸ Print Cards</button>
            <button class="btn btn-primary" onclick="openGenerateCodesModal()">+ Generate Codes</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Codes</div>
            <div class="stat-value" id="totalCodesCount">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Available</div>
            <div class="stat-value" id="availableCodesCount">0</div>
          </div>
          <div class="stat-card primary">
            <div class="stat-label">Used</div>
            <div class="stat-value" id="usedCodesCount">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Invitation Codes</h3>
            <p class="form-description">Create unique codes to give to potential clients</p>
          </div>
          <div class="card-body">
            <div class="tabs tabs-container">
              <div class="tab active" onclick="filterCodes('all')">All</div>
              <div class="tab" onclick="filterCodes('available')">Available</div>
              <div class="tab" onclick="filterCodes('used')">Used</div>
            </div>
            <div class="table-container">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Label</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Used By</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="invitationCodesTable">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Print Preview -->
        <div id="printPreview" class="print-preview">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ðŸ–¨ï¸ Print Preview - Business Card Codes</h3>
            </div>
            <div class="card-body printable-cards" id="printableCards">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- INQUIRIES PAGE -->
      <section class="page" id="page-inquiries">
        <div class="page-header">
          <h1 class="page-title">ðŸ“¬ Visitor Inquiries</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadInquiries()">ðŸ”„ Refresh</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card stat-card-gold">
            <div class="stat-label">New Inquiries</div>
            <div class="stat-value" id="newInquiriesCount">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">Invited</div>
            <div class="stat-value" id="invitedInquiriesCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total</div>
            <div class="stat-value" id="totalInquiriesCount">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">People Who Want to Connect</h3>
            <p class="form-description">Review inquiries and send invitation codes to approved visitors</p>
          </div>
          <div class="card-body" id="inquiriesList">
            <p class="no-items-message">No inquiries yet</p>
          </div>
        </div>
      </section>

      <!-- MESSAGES PAGE -->
      <section class="page" id="page-messages">
        <div class="page-header">
          <h1 class="page-title">ðŸ’¬ Client Messages</h1>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="loadConversations()">ðŸ”„ Refresh</button>
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card stat-card-gold">
            <div class="stat-label">Unread Messages</div>
            <div class="stat-value" id="unreadMessagesCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Conversations</div>
            <div class="stat-value" id="activeConversationsCount">0</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 24px;">
          <!-- Conversations List -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Conversations</h3>
            </div>
            <div class="card-body" id="conversationsList" style="max-height: 500px; overflow-y: auto;">
              <p class="no-items-message">No conversations yet</p>
            </div>
          </div>

          <!-- Active Conversation -->
          <div class="card">
            <div class="card-header" id="conversationHeader">
              <h3 class="card-title">Select a conversation</h3>
            </div>
            <div class="card-body">
              <div id="conversationMessages" style="max-height: 350px; overflow-y: auto; margin-bottom: 20px;">
                <p class="no-items-message" style="text-align: center; color: #9E9890;">
                  â† Click on a conversation to view messages
                </p>
              </div>
              
              <!-- Reply Form -->
              <div id="replyForm" style="display: none; border-top: 1px solid #e0d6cc; padding-top: 16px;">
                <textarea id="replyInput" placeholder="Type your reply..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e0d6cc; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;"></textarea>
                <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center;">
                  <button class="btn btn-primary" onclick="sendReply()">ðŸ“¨ Send Reply</button>
                  <label style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #666;">
                    <input type="checkbox" id="sendEmailNotification" checked>
                    Also send email notification
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <p style="text-align: center; margin-top: 20px; font-size: 13px; color: #9E9890;">
          ðŸ”’ All messages are encrypted at rest with AES-256-GCM â€¢ Clients can only message you, never each other
        </p>
      </section>

      <!-- MARKETING PAGE -->
      <section class="page" id="page-marketing">
        <div class="page-header">
          <h1 class="page-title">Marketing Automation</h1>
          <p class="text-muted mt-8">Lead Generation â€¢ Drip Campaigns â€¢ Automation â€¢ Analytics</p>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="leads">ðŸŽ¯ Leads</div>
          <div class="tab" data-tab="lead-magnets">ðŸ§² Lead Magnets</div>
          <div class="tab" data-tab="drip-campaigns">ðŸ’§ Drip Campaigns</div>
          <div class="tab" data-tab="campaigns">ðŸ“§ Campaigns</div>
          <div class="tab" data-tab="segments">ðŸ‘¥ Segments</div>
          <div class="tab" data-tab="automation">âš¡ Automation</div>
          <div class="tab" data-tab="templates">ðŸ“„ Templates</div>
          <div class="tab" data-tab="analytics">ðŸ“Š Analytics</div>
        </div>

        <!-- Leads Tab -->
        <div class="tab-content active" data-content="leads">
          <div class="card">
            <div class="card-header">
              <h3>Lead Generation Funnel</h3>
            </div>
            <div class="card-body">
              <div class="funnel-visual">
                <div class="funnel-stage">
                  <div class="funnel-count" id="visitorCount">0</div>
                  <div class="funnel-label">Visitors</div>
                  <div class="funnel-bar" style="width: 100%; background: #9b59b6;"></div>
                </div>
                <div class="funnel-stage">
                  <div class="funnel-count" id="leadCount">0</div>
                  <div class="funnel-label">Leads</div>
                  <div class="funnel-bar" id="leadBar" style="width: 60%; background: #3498db;"></div>
                </div>
                <div class="funnel-stage">
                  <div class="funnel-count" id="prospectCount">0</div>
                  <div class="funnel-label">Prospects</div>
                  <div class="funnel-bar" id="prospectBar" style="width: 40%; background: #e67e22;"></div>
                </div>
                <div class="funnel-stage">
                  <div class="funnel-count" id="clientCount">0</div>
                  <div class="funnel-label">Clients</div>
                  <div class="funnel-bar" id="clientBar" style="width: 20%; background: #27ae60;"></div>
                </div>
              </div>
              <div class="conversion-metrics">
                <div class="metric">
                  <span>Visitor â†’ Lead:</span>
                  <strong id="visitorLeadRate">0%</strong>
                </div>
                <div class="metric">
                  <span>Lead â†’ Prospect:</span>
                  <strong id="leadProspectRate">0%</strong>
                </div>
                <div class="metric">
                  <span>Prospect â†’ Client:</span>
                  <strong id="prospectClientRate">0%</strong>
                </div>
              </div>
            </div>
          </div>
          <div class="card mt-20">
            <div class="card-header">
              <h3>Active Leads</h3>
              <div class="filter-chips">
                <button class="chip active" data-filter="all">All</button>
                <button class="chip" data-filter="new">New</button>
                <button class="chip" data-filter="contacted">Contacted</button>
                <button class="chip" data-filter="qualified">Qualified</button>
                <button class="chip" data-filter="converted">Converted</button>
              </div>
            </div>
            <div class="card-body">
              <div id="leadsList">
                <p class="no-items-message">No leads yet. Create a lead magnet to start capturing leads!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Lead Magnets Tab -->
        <div class="tab-content" data-content="lead-magnets">
          <div class="card">
            <div class="card-header">
              <h3>Lead Magnets</h3>
              <button class="btn btn-primary" onclick="showLeadMagnetBuilder()">
                <span>ðŸ§²</span> Create Lead Magnet
              </button>
            </div>
            <div class="card-body">
              <p class="text-muted mb-20">
                AI-powered lead magnet creation: free guides, assessments, consultations, or healing resources that capture email addresses.
              </p>
              <div id="leadMagnetGrid" class="template-grid">
                <p class="no-items-message">No lead magnets yet. Create your first lead capture offer!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Drip Campaigns Tab -->
        <div class="tab-content" data-content="drip-campaigns">
          <div class="card">
            <div class="card-header">
              <h3>Drip Campaigns</h3>
              <button class="btn btn-primary" onclick="showDripCampaignBuilder()">
                <span>ðŸ’§</span> Create Drip Campaign
              </button>
            </div>
            <div class="card-body">
              <p class="text-muted mb-20">
                Automated email sequences that nurture leads over time. Set up welcome series, education sequences, or re-engagement campaigns.
              </p>
              <div id="dripCampaignsList">
                <p class="no-items-message">No drip campaigns yet. Create your first automated email sequence!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Campaigns Tab -->
        <div class="tab-content" data-content="campaigns">
          <div class="card">
            <div class="card-header">
              <h3>Email Campaigns</h3>
              <button class="btn btn-primary" onclick="showCampaignBuilder()">
                <span>ðŸ“§</span> Create Campaign
              </button>
            </div>
            <div class="card-body">
              <div class="stats-grid" class="mb-20">
                <div class="stat-card">
                  <div class="stat-label">Total Campaigns</div>
                  <div class="stat-value" id="totalCampaigns">0</div>
                </div>
                <div class="stat-card success">
                  <div class="stat-label">Sent</div>
                  <div class="stat-value" id="sentCampaigns">0</div>
                </div>
                <div class="stat-card info">
                  <div class="stat-label">Avg Open Rate</div>
                  <div class="stat-value" id="avgOpenRate">0%</div>
                </div>
                <div class="stat-card gold">
                  <div class="stat-label">Avg Click Rate</div>
                  <div class="stat-value" id="avgClickRate">0%</div>
                </div>
              </div>
              <div id="campaignsList">
                <p class="no-items-message">No campaigns yet. Create your first email campaign!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Segments Tab -->
        <div class="tab-content" data-content="segments">
          <div class="card">
            <div class="card-header">
              <h3>Client Segments</h3>
              <button class="btn btn-primary" onclick="showSegmentBuilder()">
                <span>ðŸŽ¯</span> Create Segment
              </button>
            </div>
            <div class="card-body">
              <p class="text-muted mb-20">
                Group clients by behavior, booking history, service preferences, or engagement level for targeted campaigns.
              </p>
              <div id="segmentsList">
                <p class="no-items-message">No segments yet. Create your first audience segment!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Automation Tab -->
        <div class="tab-content" data-content="automation">
          <div class="card">
            <div class="card-header">
              <h3>Automated Workflows</h3>
              <button class="btn btn-primary" onclick="showWorkflowBuilder()">
                <span>âš¡</span> Create Workflow
              </button>
            </div>
            <div class="card-body">
              <p class="text-muted mb-20">
                Set up automated email sequences triggered by client actions: new bookings, follow-ups, re-engagement, birthdays.
              </p>
              <div id="workflowsList">
                <p class="no-items-message">No workflows yet. Automate your client communications!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Templates Tab -->
        <div class="tab-content" data-content="templates">
          <div class="card">
            <div class="card-header">
              <h3>Email Templates</h3>
              <button class="btn btn-primary" onclick="showTemplateEditor()">
                <span>ðŸ“„</span> Create Template
              </button>
            </div>
            <div class="card-body">
              <div class="template-gallery" id="templateGallery">
                <!-- Pre-built templates will be loaded here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" data-content="analytics">
          <div class="card">
            <div class="card-header">
              <h3>Marketing Analytics</h3>
              <div class="header-actions">
                <select id="analyticsDateRange" class="form-control" style="width: auto;" onchange="loadMarketingAnalytics()">
                  <option value="7">Last 7 Days</option>
                  <option value="30" selected>Last 30 Days</option>
                  <option value="90">Last 90 Days</option>
                  <option value="365">Last Year</option>
                </select>
              </div>
            </div>
            <div class="card-body">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-label">Total Subscribers</div>
                  <div class="stat-value" id="totalSubscribers">0</div>
                </div>
                <div class="stat-card success">
                  <div class="stat-label">Emails Sent</div>
                  <div class="stat-value" id="totalEmailsSent">0</div>
                </div>
                <div class="stat-card info">
                  <div class="stat-label">Total Opens</div>
                  <div class="stat-value" id="totalOpens">0</div>
                </div>
                <div class="stat-card gold">
                  <div class="stat-label">Total Clicks</div>
                  <div class="stat-value" id="totalClicks">0</div>
                </div>
              </div>

              <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 16px;">Client Lifecycle Distribution</h4>
                <div id="lifecycleChart" class="analytics-chart"></div>
              </div>

              <div style="margin-top: 30px;">
                <h4 style="margin-bottom: 16px;">Campaign Performance</h4>
                <div id="campaignPerformanceList"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CONTENT PAGE -->
      <section class="page" id="page-content">
        <div class="page-header">
          <h1 class="page-title">Content Management</h1>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="testimonials">Testimonials</div>
          <div class="tab" data-tab="pending-testimonials">Pending <span id="pendingBadge" class="badge display-none">0</span></div>
          <div class="tab" data-tab="faqs">FAQs</div>
          <div class="tab" data-tab="site-settings">Site Settings</div>
        </div>

        <!-- Testimonials Tab -->
        <div class="tab-content active" id="tab-testimonials">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Testimonials</h3>
              <button class="btn btn-primary" onclick="openTestimonialModal()">+ Add Testimonial</button>
            </div>
            <div class="card-body" id="testimonialsList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Pending Testimonials Tab -->
        <div class="tab-content" id="tab-pending-testimonials">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Pending Testimonials</h3>
              <p class="form-description">Client-submitted testimonials awaiting your approval</p>
            </div>
            <div class="card-body" id="pendingTestimonialsList">
              <p class="no-items-message">No pending testimonials</p>
            </div>
          </div>
        </div>

        <!-- FAQs Tab -->
        <div class="tab-content" id="tab-faqs">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Frequently Asked Questions</h3>
              <button class="btn btn-primary" onclick="openFaqModal()">+ Add FAQ</button>
            </div>
            <div class="card-body" id="faqsList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Site Settings Tab -->
        <div class="tab-content" id="tab-site-settings">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Site Settings</h3>
            </div>
            <div class="card-body">
              <form id="siteSettingsForm">
                <div class="form-group">
                  <label class="form-label">Site Name</label>
                  <input type="text" class="form-input" id="siteName">
                </div>
                <div class="form-group">
                  <label class="form-label">Tagline</label>
                  <input type="text" class="form-input" id="siteTagline">
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-input" id="siteEmail">
                </div>
                <div class="form-group">
                  <label class="form-label">Location</label>
                  <input type="text" class="form-input" id="siteLocation">
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="maintenanceMode"> Maintenance Mode (hide site from public)
                  </label>
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
              </form>
            </div>
          </div>
        </div>
      </section>

      <!-- SETTINGS PAGE -->
      <section class="page" id="page-settings">
        <div class="page-header">
          <h1 class="page-title">Settings</h1>
        </div>

        <div class="tabs">
          <div class="tab active" data-tab="services">Services</div>
          <div class="tab" data-tab="availability">Availability</div>
          <div class="tab" data-tab="email">Email Settings</div>
          <div class="tab" data-tab="security">Security</div>
        </div>

        <!-- Services Tab -->
        <div class="tab-content active" id="tab-services">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Services & Pricing</h3>
            </div>
            <div class="card-body" id="servicesList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Availability Tab -->
        <div class="tab-content" id="tab-availability">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Weekly Availability</h3>
              <p style="color: var(--soft-gray); font-size: 14px; margin-top: 8px;">Set your recurring weekly schedule</p>
            </div>
            <div class="card-body">
              <div id="weeklyAvailability">
                <!-- Populated by JS with day-by-day time slot picker -->
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Blocked Dates</h3>
              <button class="btn btn-secondary" onclick="openBlockDateModal()">+ Block Date</button>
            </div>
            <div class="card-body" id="blockedDatesList">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

        <!-- Email Tab -->
        <div class="tab-content" id="tab-email">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Email Notification Settings</h3>
            </div>
            <div class="card-body">
              <form id="emailSettingsForm">
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="emailNotifications" checked> Email notifications for new bookings
                  </label>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="autoConfirmationEmail" checked> Auto-send confirmation to clients
                  </label>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="reminderEmails" checked> Send reminder emails
                  </label>
                </div>
                <div class="form-group">
                  <label class="form-label">Reminder Hours Before Session</label>
                  <input type="number" class="form-input reminder-hours-input" id="reminderHours" value="24" min="1" max="72">
                </div>
                <button type="submit" class="btn btn-primary">Save Email Settings</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Security Tab -->
        <div class="tab-content" id="tab-security">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Change Admin Password</h3>
            </div>
            <div class="card-body">
              <div class="warning-box">
                <strong>âš ï¸ Important:</strong> Changing your password will log you out. You'll need to login again with your new password.
              </div>
              
              <form id="changePasswordForm" onsubmit="handlePasswordChange(event)">
                <div class="form-group">
                  <label class="form-label">Current Password <span class="required">*</span></label>
                  <input type="password" class="form-input" id="currentPassword" required minlength="8" autocomplete="current-password">
                </div>
                <div class="form-group">
                  <label class="form-label">New Password <span class="required">*</span></label>
                  <input type="password" class="form-input" id="newPassword" required minlength="12" autocomplete="new-password">
                  <small class="password-hint">Minimum 12 characters, mix of uppercase, lowercase, numbers, and symbols</small>
                </div>
                <div class="form-group">
                  <label class="form-label">Confirm New Password <span class="required">*</span></label>
                  <input type="password" class="form-input" id="confirmPassword" required minlength="12" autocomplete="new-password">
                </div>
                <div id="passwordStrength" class="password-strength">
                  <div class="strength-label"><strong>Password Strength:</strong> <span id="strengthText"></span></div>
                  <div class="strength-bar-container">
                    <div id="strengthBar" class="strength-bar"></div>
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">Change Password</button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ðŸ” Password Recovery</h3>
            </div>
            <div class="card-body">
              <p class="recovery-instructions">If you forget your password, follow these steps:</p>
              <ol class="recovery-list">
                <li>Stop the server (if running locally)</li>
                <li>Edit the <code class="code-snippet">.env</code> file in your project directory</li>
                <li>Change <code class="code-snippet">ADMIN_PASSWORD</code> to a new password</li>
                <li>Restart the server</li>
                <li>Login with your new password</li>
              </ol>
              <div class="info-box">
                <strong>ðŸ’¡ Tip:</strong> Keep a secure backup of your credentials in a password manager like 1Password, LastPass, or Bitwarden.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ðŸ“š Setup Documentation</h3>
            </div>
            <div class="card-body">
              <p class="recovery-instructions">Need help with configuration?</p>
              <div class="help-links">
                <a href="../SETUP_GUIDE.md" target="_blank" class="btn btn-outline help-link">
                  ðŸ“– View Setup Guide
                </a>
                <p class="help-contact">
                  Complete guide for initial setup, email configuration, SMS setup, and deployment to production.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EXPORT PAGE -->
      <section class="page" id="page-export">
        <div class="page-header">
          <h1 class="page-title">Export & Backup</h1>
        </div>

        <div class="stats-grid">
          <div class="card export-card">
            <h3>ðŸ“Š Export Bookings</h3>
            <p>Download all booking data as CSV</p>
            <button class="btn btn-primary" onclick="exportBookings()">Download CSV</button>
          </div>
          <div class="card export-card">
            <h3>ðŸ‘¥ Export Clients</h3>
            <p>Download client directory as CSV</p>
            <button class="btn btn-primary" onclick="exportClients()">Download CSV</button>
          </div>
          <div class="card export-card">
            <h3>ðŸ’¾ Full Backup</h3>
            <p>Download complete data backup</p>
            <button class="btn btn-secondary" onclick="downloadBackup()">Download Backup</button>
          </div>
          <div class="card export-card">
            <h3>ðŸ“¥ Restore Backup</h3>
            <p>Restore from backup file</p>
            <input type="file" id="restoreFile" accept=".json" class="display-none" onchange="handleRestore(this)">
            <button class="btn btn-outline" onclick="document.getElementById('restoreFile').click()">Upload Backup</button>
          </div>
        </div>

        <!-- AUTOMATIC BACKUP SYSTEM -->
        <div class="card backup-system-card">
          <div class="backup-header">
            <div>
              <h3 class="backup-title">ðŸ›¡ï¸ Automatic Backup System</h3>
              <p class="form-description">
                Every data change is automatically backed up for maximum protection
              </p>
            </div>
            <button class="btn btn-primary" onclick="loadBackupStats()">ðŸ”„ Refresh</button>
          </div>

          <!-- Backup Stats -->
          <div id="backupStats" class="stats-grid backup-stats-container">
            <div class="backup-stat-item">
              <div class="backup-stat-value" id="totalAutoBackups">-</div>
              <div class="backup-stat-label">Auto Backups</div>
            </div>
            <div class="backup-stat-item">
              <div class="backup-stat-value" id="totalManualBackups">-</div>
              <div class="backup-stat-label">Manual Backups</div>
            </div>
            <div class="backup-stat-item">
              <div class="backup-stat-value-small" id="backupSize">-</div>
              <div class="backup-stat-label">Total Size</div>
            </div>
            <div style="background: white; padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 16px; color: var(--burgundy); font-weight: bold;" id="newestBackup">-</div>
              <div style="color: var(--soft-gray); font-size: 12px; text-transform: uppercase; margin-top: 4px;">Latest Backup</div>
            </div>
          </div>

          <!-- Backup Info Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="background: #e8f5e9; padding: 16px; border-radius: 8px; border-left: 4px solid #4caf50;">
              <h4 style="color: #2e7d32; margin-bottom: 8px; font-size: 14px;">âœ“ Real-Time Protection</h4>
              <p style="color: #555; font-size: 13px; line-height: 1.5;">
                Every booking, setting change, and data update is automatically backed up
              </p>
            </div>
            <div style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid #2196f3;">
              <h4 style="color: #1565c0; margin-bottom: 8px; font-size: 14px;">ðŸ”’ Encrypted Storage</h4>
              <p style="color: #555; font-size: 13px; line-height: 1.5;">
                All backups use military-grade AES-256-GCM encryption
              </p>
            </div>
            <div style="background: #fff3e0; padding: 16px; border-radius: 8px; border-left: 4px solid #ff9800;">
              <h4 style="color: #e65100; margin-bottom: 8px; font-size: 14px;">â™»ï¸ Smart Rotation</h4>
              <p style="color: #555; font-size: 13px; line-height: 1.5;">
                Keeps last 50 automatic backups, removes older ones automatically
              </p>
            </div>
          </div>

          <!-- Filter Tabs -->
          <div style="margin-bottom: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-sm" onclick="filterBackups('all')" id="filterAll" style="background: var(--burgundy); color: white;">All</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('bookings')" id="filterBookings">Bookings</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('settings')" id="filterSettings">Settings</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('content')" id="filterContent">Content</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('clients')" id="filterClients">Clients</button>
            <button class="btn btn-sm btn-outline" onclick="filterBackups('manual')" id="filterManual">Manual</button>
          </div>

          <!-- Backup List -->
          <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: var(--burgundy); color: white; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">File Type</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Date & Time</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Size</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600;">Type</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                  </tr>
                </thead>
                <tbody id="backupListTable">
                  <tr>
                    <td colspan="5" style="padding: 40px; text-align: center; color: var(--soft-gray);">
                      <div style="font-size: 48px; margin-bottom: 8px;">ðŸ“¦</div>
                      <div>Loading backups...</div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- DEMO MODE SECTION -->
        <div class="card" style="padding: 24px; margin-top: 24px; border: 2px dashed var(--gold);">
          <h3 style="margin-bottom: 12px; color: var(--gold);">ðŸŽ­ Demo Mode</h3>
          <p style="color: var(--soft-gray); margin-bottom: 16px;">Tools for demonstrating the system to Ravi</p>
          
          <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin-bottom: 8px;"><strong>Demo Invitation Code:</strong></p>
            <code style="background: var(--burgundy); color: white; padding: 8px 16px; border-radius: 4px; font-size: 18px; display: inline-block;">DEMO-2026</code>
            <p style="margin-top: 8px; font-size: 12px; color: var(--soft-gray);">Use this code at /portal.html to access the client experience</p>
          </div>

          <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <p style="margin-bottom: 8px;"><strong>Demo Walkthrough:</strong></p>
            <ol style="margin-left: 20px; color: var(--soft-gray); font-size: 14px; line-height: 1.8;">
              <li>Landing page: <a href="/" target="_blank" style="color: var(--burgundy);">localhost:3000</a> - New visitor inquiry form</li>
              <li>Client portal: <a href="/portal.html" target="_blank" style="color: var(--burgundy);">localhost:3000/portal.html</a> - Enter DEMO-2026</li>
              <li>After code entry â†’ Full site with booking form</li>
              <li>Submit a booking â†’ View in Bookings page</li>
              <li>Confirm booking with date â†’ Appears on Calendar</li>
              <li>Complete booking â†’ Client record created</li>
            </ol>
          </div>

          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="populateDemoData()">
              âœ¨ Populate Demo Data
            </button>
            <button class="btn btn-outline" onclick="resetDemoData()" style="color: #c62828; border-color: #c62828;">
              ðŸ—‘ï¸ Clear All Data
            </button>
          </div>
        </div>
      </section>

      <!-- ============ USER GUIDE PAGE ============ -->
      <section class="page" id="page-help">
        <div class="page-header">
          <h1 class="page-title">ðŸ“š Admin User Guide</h1>
          <button class="btn btn-primary" onclick="showPage('overview')">â† Back to Dashboard</button>
        </div>

        <div class="card" style="padding: 32px; max-width: 900px; margin: 0 auto;">
          <div style="margin-bottom: 32px; text-align: center;">
            <h2 style="color: var(--burgundy); margin-bottom: 8px;">Complete Guide to Your Admin Dashboard</h2>
            <p style="color: var(--soft-gray);">Everything you need to manage Ravi's Sacred Healing</p>
          </div>

          <!-- Table of Contents -->
          <div style="background: #f8f4ef; padding: 24px; border-radius: 8px; margin-bottom: 32px;">
            <h3 style="margin-bottom: 16px; color: var(--burgundy);">ðŸ“‘ Quick Navigation</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <a href="#guide-login" style="color: var(--burgundy); text-decoration: none;">ðŸ” Logging In</a>
              <a href="#guide-overview" style="color: var(--burgundy); text-decoration: none;">ðŸ“Š Dashboard Overview</a>
              <a href="#guide-inquiries" style="color: var(--burgundy); text-decoration: none;">ðŸ“¬ Inquiries</a>
              <a href="#guide-bookings" style="color: var(--burgundy); text-decoration: none;">ðŸ“‹ Bookings</a>
              <a href="#guide-calendar" style="color: var(--burgundy); text-decoration: none;">ðŸ“… Calendar</a>
              <a href="#guide-clients" style="color: var(--burgundy); text-decoration: none;">ðŸ‘¥ Clients</a>
              <a href="#guide-invitations" style="color: var(--burgundy); text-decoration: none;">ðŸŽŸï¸ Invitation Codes</a>
              <a href="#guide-content" style="color: var(--burgundy); text-decoration: none;">âœï¸ Content</a>
              <a href="#guide-settings" style="color: var(--burgundy); text-decoration: none;">âš™ï¸ Settings</a>
              <a href="#guide-export" style="color: var(--burgundy); text-decoration: none;">ðŸ“¤ Export & Backup</a>
              <a href="#guide-tasks" style="color: var(--burgundy); text-decoration: none;">ðŸ” Common Tasks</a>
              <a href="#guide-troubleshooting" style="color: var(--burgundy); text-decoration: none;">ðŸ†˜ Troubleshooting</a>
            </div>
          </div>

          <!-- Content Sections -->
          <div style="line-height: 1.8; color: var(--soft-charcoal);">
            
            <!-- Logging In -->
            <div id="guide-login" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ” Logging In</h2>
              <ol style="margin-left: 20px;">
                <li>Navigate to: <code style="background: #f8f4ef; padding: 4px 8px; border-radius: 4px;">http://localhost:3000/admin.html</code></li>
                <li>Enter your username: <strong>ravi</strong></li>
                <li>Enter your secure password</li>
                <li>Click "ðŸª· Enter Admin Portal"</li>
              </ol>
              <p style="background: #fff3e0; padding: 12px; border-left: 4px solid var(--gold); border-radius: 4px; margin-top: 16px;">
                <strong>Security Note:</strong> Your session stays active until you log out. Always log out when finished, especially on shared computers.
              </p>
            </div>

            <!-- Dashboard Overview -->
            <div id="guide-overview" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ“Š Dashboard Overview</h2>
              <p>When you first log in, you'll see the Overview page with:</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Statistics Cards</h3>
              <ul style="margin-left: 20px;">
                <li><strong>ðŸ“‹ Total Bookings:</strong> All time booking count</li>
                <li><strong>âœ… Confirmed Sessions:</strong> Scheduled bookings</li>
                <li><strong>â³ Pending:</strong> Awaiting your confirmation</li>
                <li><strong>âœ¨ Completed:</strong> Finished sessions</li>
                <li><strong>ðŸ’° Total Revenue:</strong> Lifetime earnings</li>
                <li><strong>ðŸ‘¥ Total Clients:</strong> Unique client count</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Recent Bookings</h3>
              <p>Quick view of your latest 5 bookings with client name, service, status, date, and quick actions.</p>
            </div>

            <!-- Inquiries -->
            <div id="guide-inquiries" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ“¬ Inquiries Section</h2>
              <p><strong>Purpose:</strong> Manage new visitor inquiries from your landing page contact form.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Actions You Can Take</h3>
              <ul style="margin-left: 20px;">
                <li><strong>ðŸ“§ Send Invitation:</strong> Generate unique code for client access</li>
                <li><strong>ðŸ“ Archive:</strong> Mark as reviewed but not invited</li>
                <li><strong>ðŸ—‘ï¸ Delete:</strong> Permanently remove (cannot be undone)</li>
              </ul>
              <p style="background: #e3f2fd; padding: 12px; border-left: 4px solid #2196f3; border-radius: 4px; margin-top: 16px;">
                <strong>Best Practice:</strong> Check inquiries daily and respond within 24-48 hours.
              </p>
            </div>

            <!-- Bookings -->
            <div id="guide-bookings" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ“‹ Bookings Section</h2>
              <p><strong>Purpose:</strong> Manage all session applications and bookings.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Understanding Booking Statuses</h3>
              <ul style="margin-left: 20px;">
                <li><strong style="color: #2196f3;">Pending:</strong> New application, awaiting your review</li>
                <li><strong style="color: #4caf50;">Confirmed:</strong> You've confirmed and scheduled</li>
                <li><strong style="color: #9c27b0;">Completed:</strong> Session has occurred</li>
                <li><strong style="color: #f44336;">Cancelled:</strong> Session was cancelled</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Key Actions</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Confirm Booking:</strong> Set date/time and notify client</li>
                <li><strong>Mark as Completed:</strong> After session is finished</li>
                <li><strong>Save Changes:</strong> Update notes, date, or time</li>
                <li><strong>Send Reminder:</strong> Manual reminder email</li>
              </ul>
              <p style="background: #fff3e0; padding: 12px; border-left: 4px solid var(--gold); border-radius: 4px; margin-top: 16px;">
                <strong>Important:</strong> Bookings only appear on calendar after status is "Confirmed" AND a confirmed date is entered.
              </p>
            </div>

            <!-- Calendar -->
            <div id="guide-calendar" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ“… Calendar Section</h2>
              <p><strong>Purpose:</strong> Visual overview of your scheduled sessions.</p>
              <ul style="margin-left: 20px;">
                <li>Shows confirmed bookings on their scheduled dates</li>
                <li>Navigate months with â—€ Previous / Next â–¶ buttons</li>
                <li>Click any day to see all bookings that day</li>
                <li>Upcoming sessions panel on the right</li>
              </ul>
              <p style="margin-top: 12px;">Days with bookings show light purple background. Click any session to view full details.</p>
            </div>

            <!-- Clients -->
            <div id="guide-clients" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ‘¥ Clients Section</h2>
              <p><strong>Purpose:</strong> Manage your client database and history.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">What You'll See</h3>
              <ul style="margin-left: 20px;">
                <li>Name and contact info</li>
                <li>Number of completed sessions</li>
                <li>Total revenue from this client</li>
                <li>Last contact date</li>
                <li>Tags you've assigned</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Client Detail View</h3>
              <p>Click any client to see complete booking history, add private notes, and manage tags.</p>
              <p style="background: #e3f2fd; padding: 12px; border-left: 4px solid #2196f3; border-radius: 4px; margin-top: 16px;">
                <strong>Tip:</strong> Add notes after each session and tag regular clients for easy identification.
              </p>
            </div>

            <!-- Invitation Codes -->
            <div id="guide-invitations" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸŽŸï¸ Invitation Codes Section</h2>
              <p><strong>Purpose:</strong> Generate and manage exclusive access codes.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">What Are Invitation Codes?</h3>
              <p>Unique codes that grant access to your full website. More personal than generic passwords.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Generating New Codes</h3>
              <ol style="margin-left: 20px;">
                <li>Click "+ Generate New Code"</li>
                <li>Choose prefix: SACRED, LOTUS, HEALING, BLISS, or custom</li>
                <li>Toggle "Single Use" (works once vs. multiple times)</li>
                <li>Optional: Set expiration date</li>
                <li>Optional: Add note for yourself</li>
                <li>Click "Generate Code"</li>
              </ol>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Print Business Cards</h3>
              <ol style="margin-left: 20px;">
                <li>Generate batch of codes</li>
                <li>Select multiple codes (checkboxes)</li>
                <li>Click "Print Selected"</li>
                <li>Print on cardstock and distribute</li>
              </ol>
              <p style="background: #e3f2fd; padding: 12px; border-left: 4px solid #2196f3; border-radius: 4px; margin-top: 16px;">
                <strong>Best Practice:</strong> Use expiration dates for limited promotions. Multi-use codes work great for business cards.
              </p>
            </div>

            <!-- Content -->
            <div id="guide-content" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">âœï¸ Content Section</h2>
              <p><strong>Purpose:</strong> Manage all website content without touching code.</p>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Services Management</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Add Service:</strong> Name, duration (minutes), price</li>
                <li><strong>Edit Service:</strong> Modify any details</li>
                <li><strong>Active/Inactive:</strong> Show or hide from booking form</li>
                <li><strong>Delete:</strong> Remove service (existing bookings unaffected)</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Testimonials Management</h3>
              <ul style="margin-left: 20px;">
                <li>Add client testimonials and reviews</li>
                <li>Mark as "Featured" for prominent display</li>
                <li>Toggle active/inactive visibility</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">FAQs Management</h3>
              <ul style="margin-left: 20px;">
                <li>Add frequently asked questions and answers</li>
                <li>Set order (1 = first, 2 = second, etc.)</li>
                <li>Edit or delete anytime</li>
              </ul>
            </div>

            <!-- Settings -->
            <div id="guide-settings" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">âš™ï¸ Settings Section</h2>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Availability Settings</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Available Days:</strong> Check boxes for days you offer sessions</li>
                <li><strong>Time Slots:</strong> Add your typical session start times</li>
                <li><strong>Block Dates:</strong> Mark specific dates as unavailable</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Email Settings</h3>
              <p>Configure automated notifications:</p>
              <ul style="margin-left: 20px;">
                <li><strong>SMTP Host:</strong> Your email provider's server (e.g., smtp.gmail.com)</li>
                <li><strong>SMTP Port:</strong> Usually 587 or 465</li>
                <li><strong>Email Address:</strong> Your sending email</li>
                <li><strong>Password:</strong> Use app-specific password for security</li>
              </ul>
              <p style="background: #fff3e0; padding: 12px; border-left: 4px solid var(--gold); border-radius: 4px; margin-top: 16px;">
                <strong>Important:</strong> For Gmail/Outlook, generate app-specific passwords in Account Settings â†’ Security.
              </p>
            </div>

            <!-- Export & Backup -->
            <div id="guide-export" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ“¤ Export & Backup Section</h2>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Export Options</h3>
              <ul style="margin-left: 20px;">
                <li><strong>Bookings CSV:</strong> All bookings for accounting and reports</li>
                <li><strong>Clients CSV:</strong> Client list for mailing/CRM</li>
                <li><strong>Full Backup:</strong> Complete encrypted JSON backup</li>
              </ul>
              <h3 style="margin-top: 16px; margin-bottom: 8px;">Restore from Backup</h3>
              <p>Upload a backup file to restore all data. <strong>Warning:</strong> This replaces everything. Make a current backup first!</p>
              <p style="background: #ffebee; padding: 12px; border-left: 4px solid #f44336; border-radius: 4px; margin-top: 16px;">
                <strong>Critical:</strong> Download weekly backups! Name them clearly (e.g., ravi-backup-2026-01-28.json) and store safely.
              </p>
            </div>

            <!-- Common Tasks -->
            <div id="guide-tasks" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ” Common Tasks Quick Reference</h2>
              
              <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="color: var(--burgundy); margin-bottom: 8px;">Processing a New Booking</h4>
                <ol style="margin-left: 20px; font-size: 14px;">
                  <li>Go to Bookings section</li>
                  <li>Click on pending booking</li>
                  <li>Review intake information</li>
                  <li>Enter confirmed date and time</li>
                  <li>Click "Confirm Booking"</li>
                  <li>Choose "Yes" to send confirmation email</li>
                  <li>Booking appears on calendar</li>
                </ol>
              </div>

              <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="color: var(--burgundy); margin-bottom: 8px;">Responding to an Inquiry</h4>
                <ol style="margin-left: 20px; font-size: 14px;">
                  <li>Go to Inquiries section</li>
                  <li>Read their message</li>
                  <li>Click "Send Invitation" (ðŸ“§)</li>
                  <li>Code is generated automatically</li>
                  <li>Send code to client via email or text</li>
                </ol>
              </div>

              <div style="background: #f8f4ef; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <h4 style="color: var(--burgundy); margin-bottom: 8px;">Completing a Session</h4>
                <ol style="margin-left: 20px; font-size: 14px;">
                  <li>Go to Bookings section</li>
                  <li>Find the booking</li>
                  <li>Add Session Notes (private)</li>
                  <li>Click "Mark as Completed"</li>
                  <li>Client added to database, revenue updated</li>
                </ol>
              </div>
            </div>

            <!-- Troubleshooting -->
            <div id="guide-troubleshooting" style="margin-bottom: 48px;">
              <h2 style="color: var(--burgundy); border-bottom: 2px solid var(--gold); padding-bottom: 8px; margin-bottom: 16px;">ðŸ†˜ Troubleshooting</h2>
              
              <div style="margin-bottom: 16px;">
                <h4 style="color: var(--soft-charcoal); margin-bottom: 8px;">"Bookings not showing on calendar"</h4>
                <ul style="margin-left: 20px; font-size: 14px;">
                  <li>Ensure booking status is "Confirmed"</li>
                  <li>Verify confirmed date is set</li>
                  <li>Both status AND date are required</li>
                </ul>
              </div>

              <div style="margin-bottom: 16px;">
                <h4 style="color: var(--soft-charcoal); margin-bottom: 8px;">"Emails not sending"</h4>
                <ul style="margin-left: 20px; font-size: 14px;">
                  <li>Check Settings â†’ Email configuration</li>
                  <li>Verify SMTP details are correct</li>
                  <li>Ensure you're using app-specific password</li>
                  <li>Check if email notifications toggle is ON</li>
                </ul>
              </div>

              <div style="margin-bottom: 16px;">
                <h4 style="color: var(--soft-charcoal); margin-bottom: 8px;">"Invitation code not working"</h4>
                <ul style="margin-left: 20px; font-size: 14px;">
                  <li>Check if code is active (not deactivated)</li>
                  <li>Verify code hasn't expired</li>
                  <li>If single-use, check if already used</li>
                  <li>Try copy-pasting code instead of typing</li>
                </ul>
              </div>
            </div>

            <!-- Daily Routine -->
            <div style="background: linear-gradient(135deg, var(--burgundy) 0%, #8B1538 100%); color: white; padding: 24px; border-radius: 8px; margin-top: 32px;">
              <h3 style="color: white; margin-bottom: 16px;">ðŸ’¡ Daily Routine Recommendations</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                <div>
                  <h4 style="color: var(--gold); margin-bottom: 8px;">Morning</h4>
                  <ul style="margin-left: 20px; font-size: 14px; line-height: 1.8;">
                    <li>Check new inquiries</li>
                    <li>Review pending bookings</li>
                    <li>Confirm appointments</li>
                    <li>Check calendar for today</li>
                  </ul>
                </div>
                <div>
                  <h4 style="color: var(--gold); margin-bottom: 8px;">After Sessions</h4>
                  <ul style="margin-left: 20px; font-size: 14px; line-height: 1.8;">
                    <li>Add session notes</li>
                    <li>Mark as completed</li>
                    <li>Send follow-up if needed</li>
                  </ul>
                </div>
                <div>
                  <h4 style="color: var(--gold); margin-bottom: 8px;">Weekly</h4>
                  <ul style="margin-left: 20px; font-size: 14px; line-height: 1.8;">
                    <li>Download backup (Sunday)</li>
                    <li>Send upcoming reminders</li>
                    <li>Review revenue stats</li>
                    <li>Update blocked dates</li>
                  </ul>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- BOOKING DETAIL MODAL -->
  <div class="modal-overlay" id="bookingModal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title">Booking Details</h2>
        <button class="modal-close" onclick="closeModal('bookingModal')">&times;</button>
      </div>
      <div class="modal-body" id="bookingModalBody">
        <!-- Populated by JS -->
      </div>
      <div class="modal-footer" id="bookingModalFooter">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <!-- CLIENT DETAIL MODAL (COMPREHENSIVE) -->
  <div class="modal-overlay" id="clientModal">
    <div class="modal" style="max-width: 800px; width: 95%;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--burgundy) 0%, var(--burgundy-light) 100%); color: white;">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div class="client-avatar" id="modalClientAvatar" style="width: 56px; height: 56px; font-size: 22px; background: rgba(255,255,255,0.2);"></div>
          <div>
            <h2 class="modal-title" id="modalClientName" style="margin: 0; color: white;">Client Name</h2>
            <p style="margin: 4px 0 0 0; opacity: 0.9; font-size: 14px;" id="modalClientEmail">email@example.com</p>
          </div>
        </div>
        <button class="modal-close" onclick="closeModal('clientModal')" style="color: white;">&times;</button>
      </div>
      
      <!-- Modal Tabs -->
      <div class="tabs" style="margin: 0; border-radius: 0; border-bottom: 1px solid #e0d6cc;">
        <div class="tab active" data-clienttab="info" onclick="switchClientTab('info')">ðŸ“‹ Info</div>
        <div class="tab" data-clienttab="messages" onclick="switchClientTab('messages')">ðŸ’¬ Messages <span id="modalUnreadBadge" class="badge gold-badge" style="display: none; margin-left: 4px;">0</span></div>
        <div class="tab" data-clienttab="history" onclick="switchClientTab('history')">ðŸ“œ History</div>
        <div class="tab" data-clienttab="actions" onclick="switchClientTab('actions')">âš™ï¸ Actions</div>
      </div>

      <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
        <!-- Info Tab -->
        <div class="client-tab-content active" data-clientcontent="info" id="clientTabInfo">
          <!-- Populated by JS -->
        </div>

        <!-- Messages Tab -->
        <div class="client-tab-content" data-clientcontent="messages" id="clientTabMessages" style="display: none;">
          <div id="clientModalMessages" style="max-height: 280px; overflow-y: auto; margin-bottom: 16px;">
            <p style="text-align: center; color: var(--soft-gray);">Loading messages...</p>
          </div>
          <div style="border-top: 1px solid #e0d6cc; padding-top: 16px;">
            <textarea id="clientModalReplyInput" placeholder="Type your message..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #e0d6cc; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
            <div style="display: flex; gap: 12px; margin-top: 12px; align-items: center;">
              <button class="btn btn-primary" onclick="sendClientModalReply()">ðŸ“¨ Send Message</button>
              <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                <input type="checkbox" id="clientModalSendEmail" checked>
                Send email notification
              </label>
            </div>
          </div>
        </div>

        <!-- History Tab -->
        <div class="client-tab-content" data-clientcontent="history" id="clientTabHistory" style="display: none;">
          <!-- Populated by JS -->
        </div>

        <!-- Actions Tab -->
        <div class="client-tab-content" data-clientcontent="actions" id="clientTabActions" style="display: none;">
          <div style="padding: 20px 0;">
            <h4 style="margin-bottom: 16px; color: var(--charcoal);">ðŸ›¡ï¸ Account Management</h4>
            <p style="color: var(--soft-gray); margin-bottom: 20px; font-size: 14px;">
              Use these options to manage client access. All actions are logged and reversible.
            </p>
            
            <div id="clientActionButtons">
              <!-- Populated by JS based on client status -->
            </div>

            <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid #e0d6cc;">
              <h4 style="margin-bottom: 12px; color: var(--charcoal);">ðŸ“ Admin Notes</h4>
              <textarea id="clientModalNotes" placeholder="Add private notes about this client..." style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #e0d6cc; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
              <button class="btn btn-outline" style="margin-top: 12px;" onclick="saveClientModalNotes()">ðŸ’¾ Save Notes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUSPEND/BAN CONFIRMATION MODAL -->
  <div class="modal-overlay" id="suspendConfirmModal">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header" id="suspendModalHeader" style="background: var(--warning); color: white;">
        <h2 class="modal-title" id="suspendModalTitle">âš ï¸ Confirm Suspension</h2>
        <button class="modal-close" onclick="closeModal('suspendConfirmModal')" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <p id="suspendModalMessage" style="margin-bottom: 20px;">Are you sure you want to suspend this client?</p>
        
        <div class="form-group">
          <label class="form-label">Reason (optional but recommended)</label>
          <textarea id="suspendReason" class="form-textarea" rows="3" placeholder="e.g., Violation of policies, inappropriate behavior, etc."></textarea>
        </div>
        
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="suspendNotifyClient">
            <span>Send notification email to client</span>
          </label>
          <p style="font-size: 12px; color: var(--soft-gray); margin-top: 4px;">
            Client will be informed of the account status change
          </p>
        </div>

        <div style="background: #fff8e6; padding: 12px; border-radius: 8px; margin-top: 16px;">
          <p style="font-size: 13px; margin: 0; color: #856404;">
            <strong>âš¡ This action can be reversed.</strong><br>
            You can reinstate the client at any time from their profile.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('suspendConfirmModal')">Cancel</button>
        <button class="btn" id="suspendConfirmBtn" onclick="confirmSuspendAction()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- TESTIMONIAL MODAL -->
  <div class="modal-overlay" id="testimonialModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="testimonialModalTitle">Add Testimonial</h2>
        <button class="modal-close" onclick="closeModal('testimonialModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="testimonialForm">
          <input type="hidden" id="testimonialId">
          <div class="form-group">
            <label class="form-label">Author Name</label>
            <input type="text" class="form-input" id="testimonialAuthor" required>
          </div>
          <div class="form-group">
            <label class="form-label">Testimonial Text</label>
            <textarea class="form-textarea" id="testimonialText" rows="6" required></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="testimonialFeatured"> Featured (highlighted on site)
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('testimonialModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTestimonial()">Save</button>
      </div>
    </div>
  </div>

  <!-- FAQ MODAL -->
  <div class="modal-overlay" id="faqModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="faqModalTitle">Add FAQ</h2>
        <button class="modal-close" onclick="closeModal('faqModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="faqForm">
          <input type="hidden" id="faqId">
          <div class="form-group">
            <label class="form-label">Question</label>
            <input type="text" class="form-input" id="faqQuestion" required>
          </div>
          <div class="form-group">
            <label class="form-label">Answer</label>
            <textarea class="form-textarea" id="faqAnswer" rows="6" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('faqModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveFaq()">Save</button>
      </div>
    </div>
  </div>

  <!-- BLOCK DATE MODAL -->
  <div class="modal-overlay" id="blockDateModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Block Date/Time Range</h2>
        <button class="modal-close" onclick="closeModal('blockDateModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-input" id="blockStartDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Start Time (optional)</label>
            <input type="time" class="form-input" id="blockStartTime">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div class="form-group">
            <label class="form-label">End Date</label>
            <input type="date" class="form-input" id="blockEndDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">End Time (optional)</label>
            <input type="time" class="form-input" id="blockEndTime">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Reason (optional)</label>
          <input type="text" class="form-input" id="blockReason" placeholder="e.g., Holiday, Vacation, Conference">
        </div>
        <div style="background: var(--gold-light); padding: 12px; border-radius: 8px; font-size: 13px; color: var(--charcoal);">
          <strong>Note:</strong> Leave times blank to block entire day(s). Specify times to block specific hours.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('blockDateModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveBlockedDate()">Block Date Range</button>
      </div>
    </div>
  </div>

  <!-- EMAIL MODAL -->
  <div class="modal-overlay" id="emailModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Send Email</h2>
        <button class="modal-close" onclick="closeModal('emailModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="emailRecipient" style="margin-bottom: 16px; color: var(--soft-gray);"></p>
        <input type="hidden" id="emailBookingId">
        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" class="form-input" id="emailSubject" required>
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea class="form-textarea" id="emailMessage" rows="6" required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('emailModal')">Cancel</button>
        <button class="btn btn-primary" onclick="sendCustomEmail()">Send Email</button>
      </div>
    </div>
  </div>

  <!-- CLIENT MESSAGE MODAL -->
  <div class="modal-overlay" id="clientMessageModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Send Message to Client</h2>
        <button class="modal-close" onclick="closeModal('clientMessageModal')">&times;</button>
      </div>
      <div class="modal-body">
        <p id="clientMessageRecipient" style="margin-bottom: 16px; color: var(--soft-gray);"></p>
        <input type="hidden" id="clientMessageId">
        <input type="hidden" id="clientMessageType">
        
        <!-- Quick Message Templates -->
        <div class="message-templates" style="margin-bottom: 16px;">
          <label class="form-label" style="margin-bottom: 8px;">Quick Templates</label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <button type="button" class="template-btn" onclick="useTemplate('confirm')">âœ… Confirm Session</button>
            <button type="button" class="template-btn" onclick="useTemplate('reminder')">â° Reminder</button>
            <button type="button" class="template-btn" onclick="useTemplate('followup')">ðŸ’ Follow-up</button>
            <button type="button" class="template-btn" onclick="useTemplate('reschedule')">ðŸ“… Reschedule</button>
            <button type="button" class="template-btn" onclick="useTemplate('checkin')">ðŸŒ¸ Check-in</button>
            <button type="button" class="template-btn" onclick="useTemplate('thanks')">ðŸ™ Thank You</button>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" class="form-input" id="clientMessageSubject" value="A Message from Ravi ðŸª·" required>
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea class="form-textarea" id="clientMessageText" rows="6" required placeholder="Write your message here..."></textarea>
        </div>
        <div class="form-group" id="proposedTimeGroup" style="display: none;">
          <label class="form-label">Proposed Appointment</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <input type="date" class="form-input" id="proposedDate">
            <select class="form-input" id="proposedTime">
              <option value="">Select time...</option>
              <option value="9:00 AM">9:00 AM</option>
              <option value="10:00 AM">10:00 AM</option>
              <option value="10:30 AM">10:30 AM</option>
              <option value="11:00 AM">11:00 AM</option>
              <option value="12:00 PM">12:00 PM</option>
              <option value="1:00 PM">1:00 PM</option>
              <option value="2:00 PM">2:00 PM</option>
              <option value="3:00 PM">3:00 PM</option>
              <option value="4:00 PM">4:00 PM</option>
              <option value="5:00 PM">5:00 PM</option>
              <option value="6:00 PM">6:00 PM</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="includeTestimonialLink">
            <span>Include link to submit testimonial</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('clientMessageModal')">Cancel</button>
        <button class="btn btn-primary" onclick="sendClientMessage()">ðŸ“§ Send Message</button>
      </div>
    </div>
  </div>

  <!-- PROPOSE TIME MODAL -->
  <div class="modal-overlay" id="proposeTimeModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--gold) 0%, #c9a227 100%); color: white;">
        <h2 class="modal-title">ðŸ“… Propose Session Time</h2>
        <button class="modal-close" onclick="closeModal('proposeTimeModal')" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="proposeBookingId">
        <div id="proposeBookingInfo" style="background: #f8f5f0; padding: 16px; border-radius: 8px; margin-bottom: 20px;"></div>
        
        <p style="margin-bottom: 16px; color: var(--soft-gray);">
          The client will receive an email (and SMS if enabled) with your proposed time and a link to accept or request a different time.
        </p>
        
        <div class="form-group">
          <label class="form-label">Proposed Date *</label>
          <input type="date" class="form-input" id="proposeDate" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Proposed Time *</label>
          <select class="form-input" id="proposeTime" required>
            <option value="">Select time...</option>
            <option value="9:00 AM">9:00 AM</option>
            <option value="9:30 AM">9:30 AM</option>
            <option value="10:00 AM">10:00 AM</option>
            <option value="10:30 AM">10:30 AM</option>
            <option value="11:00 AM">11:00 AM</option>
            <option value="11:30 AM">11:30 AM</option>
            <option value="12:00 PM">12:00 PM</option>
            <option value="12:30 PM">12:30 PM</option>
            <option value="1:00 PM">1:00 PM</option>
            <option value="1:30 PM">1:30 PM</option>
            <option value="2:00 PM">2:00 PM</option>
            <option value="2:30 PM">2:30 PM</option>
            <option value="3:00 PM">3:00 PM</option>
            <option value="3:30 PM">3:30 PM</option>
            <option value="4:00 PM">4:00 PM</option>
            <option value="4:30 PM">4:30 PM</option>
            <option value="5:00 PM">5:00 PM</option>
            <option value="5:30 PM">5:30 PM</option>
            <option value="6:00 PM">6:00 PM</option>
            <option value="6:30 PM">6:30 PM</option>
            <option value="7:00 PM">7:00 PM</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Personal Message (optional)</label>
          <textarea class="form-textarea" id="proposeMessage" rows="3" placeholder="Add a personal note to the client..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('proposeTimeModal')">Cancel</button>
        <button class="btn btn-primary btn-gold" onclick="sendProposal()">ðŸ“§ Send Proposal</button>
      </div>
    </div>
  </div>

  <!-- GENERATE CODES MODAL -->
  <div class="modal-overlay" id="generateCodesModal">
    <div class="modal" style="max-width: 480px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #D4AF37 0%, #c9a227 100%); color: white;">
        <h2 class="modal-title">ðŸŽŸï¸ Generate Invitation Codes</h2>
        <button class="modal-close" onclick="closeModal('generateCodesModal')" style="color: white;">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 20px; color: var(--soft-gray);">
          Create unique codes to share with potential clients. Perfect for business cards, flyers, or personal invitations!
        </p>
        
        <div class="form-group">
          <label class="form-label">How many codes?</label>
          <select class="form-input" id="codeCount">
            <option value="1">1 code</option>
            <option value="5">5 codes</option>
            <option value="10" selected>10 codes</option>
            <option value="20">20 codes</option>
            <option value="50">50 codes</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Prefix (optional)</label>
          <select class="form-input" id="codePrefix">
            <option value="">Random (SACRED, LOTUS, etc.)</option>
            <option value="RAVI">RAVI-XXXX</option>
            <option value="SACRED">SACRED-XXXX</option>
            <option value="LOTUS">LOTUS-XXXX</option>
            <option value="HEAL">HEAL-XXXX</option>
            <option value="LOVE">LOVE-XXXX</option>
            <option value="SOUL">SOUL-XXXX</option>
            <option value="BLISS">BLISS-XXXX</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Label (optional)</label>
          <input type="text" class="form-input" id="codeLabel" placeholder="e.g., Business Cards Jan 2026">
          <small style="color: var(--soft-gray);">Helps you track where codes were distributed</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Expiration</label>
          <select class="form-input" id="codeExpiry">
            <option value="">Never expires</option>
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <option value="90" selected>90 days</option>
            <option value="180">6 months</option>
            <option value="365">1 year</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('generateCodesModal')">Cancel</button>
        <button class="btn btn-primary btn-gold" onclick="generateCodes()">ðŸŽŸï¸ Generate Codes</button>
      </div>
    </div>
  </div>

  <!-- PENDING TESTIMONIAL MODAL -->
  <div class="modal-overlay" id="pendingTestimonialModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Review Testimonial</h2>
        <button class="modal-close" onclick="closeModal('pendingTestimonialModal')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="pendingTestimonialId">
        <div style="background: #f5f0eb; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <p style="font-weight: 600; margin-bottom: 8px;" id="pendingTestimonialAuthor"></p>
          <p style="font-size: 14px; color: var(--soft-gray);" id="pendingTestimonialMeta"></p>
        </div>
        <div style="background: white; border: 1px solid #e0d6cc; padding: 16px; border-radius: 8px; font-style: italic;">
          <p id="pendingTestimonialText"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="rejectPendingTestimonial()">âŒ Reject</button>
        <button class="btn btn-success" onclick="approvePendingTestimonial()">âœ“ Approve & Publish</button>
      </div>
    </div>
  </div>

  <!-- TOAST CONTAINER -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- LOADING OVERLAY -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <script>
    // ===========================================
    // STATE & CONFIG
    // ===========================================
    let token = localStorage.getItem('adminToken');
    let bookings = [];
    let clients = [];
    let invitationCodes = [];
    let inquiries = [];
    let content = {};
    let settings = {};
    let currentCalendarDate = new Date();
    let codeFilter = 'all';

    // ===========================================
    // API HELPERS
    // ===========================================
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json' };
      if (token) headers['Authorization'] = `Bearer ${token}`;

      try {
        const res = await fetch(endpoint, { ...options, headers });
        if (res.status === 401 || res.status === 403) {
          logout();
          return null;
        }
        
        // Handle file downloads
        if (res.headers.get('content-type')?.includes('text/csv')) {
          return res;
        }
        
        return await res.json();
      } catch (err) {
        console.error('API Error:', err);
        showToast('Connection error. Please try again.', 'error');
        return null;
      }
    }

    // ===========================================
    // AUTH
    // ===========================================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;

      showLoading(true);
      const data = await api('/api/auth/admin', {
        method: 'POST',
        body: JSON.stringify({ username, password })
      });
      showLoading(false);

      if (data?.success) {
        token = data.token;
        localStorage.setItem('adminToken', token);
        showDashboard();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    });

    function logout() {
      token = null;
      localStorage.removeItem('adminToken');
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
    }

    document.getElementById('logoutBtn').addEventListener('click', logout);

    async function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      await refreshDashboard();
    }

    // ===========================================
    // NAVIGATION
    // ===========================================
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const page = item.dataset.page;
        if (page) {
          showPage(page);
        }
        // Close mobile menu
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.classList.remove('open');
        }
      });
    });

    function showPage(pageName) {
      // Remove active from all pages and nav items
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      
      // Find and activate the target page
      const targetPage = document.getElementById(`page-${pageName}`);
      if (targetPage) {
        targetPage.classList.add('active');
      } else {
        console.error('Page not found:', pageName);
        return;
      }
      
      // Activate the nav item
      const navItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }

      // Load page data
      if (pageName === 'bookings') loadBookings();
      if (pageName === 'calendar') { renderCalendar(); loadReminders(); }
      if (pageName === 'clients') loadClients();
      if (pageName === 'invitations') loadInvitationCodes();
      if (pageName === 'inquiries') loadInquiries();
      if (pageName === 'messages') loadConversations();
      if (pageName === 'marketing') loadMarketing();
      if (pageName === 'content') loadContent();
      if (pageName === 'settings') loadSettings();
      if (pageName === 'export') loadBackupStats();
    }

    // Mobile menu
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebar = document.getElementById('sidebar');
    
    if (mobileMenuBtn && sidebar) {
      mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('open');
      });
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        const parent = tab.closest('section');
        
        parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        const tabContent = document.querySelector(`[data-content="${tabId}"]`);
        if (tabContent) {
          tabContent.classList.add('active');
        }
      });
    });

    // ===========================================
    // DASHBOARD
    // ===========================================
    async function refreshDashboard() {
      showLoading(true);
      const data = await api('/api/admin/dashboard');
      showLoading(false);
      
      if (!data) return;

      const { stats, recentBookings } = data;

      // Load inquiries count for badge
      inquiries = await api('/api/admin/inquiries') || [];
      updateInquiriesBadge();

      // Load messages count for badge
      const messagesData = await api('/api/admin/messages');
      if (messagesData?.conversations) {
        conversations = messagesData.conversations;
        updateMessagesBadge();
      }

      // Render stats
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card warning">
          <div class="stat-label">Pending</div>
          <div class="stat-value">${stats.pending}</div>
        </div>
        <div class="stat-card success">
          <div class="stat-label">Confirmed</div>
          <div class="stat-value">${stats.confirmed}</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Completed</div>
          <div class="stat-value">${stats.completed}</div>
        </div>
        <div class="stat-card gold">
          <div class="stat-label">This Month</div>
          <div class="stat-value">$${stats.revenueThisMonth}</div>
          ${stats.revenueLastMonth > 0 ? `
            <div class="stat-change ${stats.revenueThisMonth >= stats.revenueLastMonth ? 'positive' : 'negative'}">
              ${stats.revenueThisMonth >= stats.revenueLastMonth ? 'â†‘' : 'â†“'} vs last month
            </div>
          ` : ''}
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Revenue</div>
          <div class="stat-value">$${stats.totalRevenue}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Clients</div>
          <div class="stat-value">${stats.totalClients}</div>
          <div class="stat-change">${stats.repeatClients} repeat</div>
        </div>
      `;

      // Generate smart insights
      await generateInsights(stats, recentBookings);

      // Render recent bookings
      document.getElementById('recentBookingsTable').innerHTML = recentBookings.map(b => `
        <tr>
          <td>${new Date(b.createdAt).toLocaleDateString()}</td>
          <td>${b.name}</td>
          <td>${b.serviceName}</td>
          <td><span class="badge badge-${b.status}">${b.status}</span></td>
          <td>
            <button class="action-btn" onclick="viewBooking('${b.id}')">View</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5" class="empty-state">No bookings yet</td></tr>';
    }

    // ===========================================
    // SMART INSIGHTS
    // ===========================================
    async function generateInsights(stats, recentBookings) {
      const insights = [];
      
      // Load clients for check-in analysis
      const clientsForInsights = await api('/api/admin/clients-with-messages') || [];
      
      // 1. Pending bookings that need attention
      if (stats.pending > 0) {
        insights.push({
          icon: 'â³',
          type: 'urgent',
          title: `${stats.pending} booking${stats.pending > 1 ? 's' : ''} awaiting response`,
          desc: 'New clients are waiting to hear from you',
          action: 'View Bookings',
          onclick: "showPage('bookings')"
        });
      }
      
      // 2. Unread messages
      const unreadTotal = clientsForInsights.reduce((sum, c) => sum + (c.unreadMessages || 0), 0);
      if (unreadTotal > 0) {
        insights.push({
          icon: 'ðŸ’¬',
          type: 'urgent',
          title: `${unreadTotal} unread message${unreadTotal > 1 ? 's' : ''}`,
          desc: 'Clients are waiting for your response',
          action: 'View Messages',
          onclick: "showPage('clients'); filterClients('unread')"
        });
      }
      
      // 3. Clients who haven't booked in 30+ days (non-regulars only)
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      const needsCheckin = clientsForInsights.filter(c => {
        if (!c.lastContact) return false;
        if (c.tier === 'vip' || c.tier === 'favored' || c.tier === 'regular') return false;
        if (c.status === 'banned' || c.status === 'suspended') return false;
        const lastContact = new Date(c.lastContact);
        return lastContact < thirtyDaysAgo && (c.totalSessions || 0) > 0;
      });
      
      if (needsCheckin.length > 0) {
        insights.push({
          icon: 'ðŸŒ¸',
          type: 'important',
          title: `${needsCheckin.length} client${needsCheckin.length > 1 ? 's' : ''} may need a check-in`,
          desc: 'Returning clients who haven\'t booked in 30+ days',
          action: 'View List',
          onclick: `showCheckinList(${JSON.stringify(needsCheckin.map(c => c.id))})`
        });
      }
      
      // 4. Upcoming sessions this week
      const oneWeekFromNow = new Date();
      oneWeekFromNow.setDate(oneWeekFromNow.getDate() + 7);
      
      const upcomingSessions = recentBookings.filter(b => {
        if (b.status !== 'confirmed') return false;
        if (!b.confirmedDate) return false;
        const sessionDate = new Date(b.confirmedDate);
        return sessionDate >= new Date() && sessionDate <= oneWeekFromNow;
      });
      
      if (upcomingSessions.length > 0) {
        insights.push({
          icon: 'ðŸ“…',
          type: 'info',
          title: `${upcomingSessions.length} session${upcomingSessions.length > 1 ? 's' : ''} this week`,
          desc: 'Confirmed appointments coming up',
          action: 'View Calendar',
          onclick: "showPage('calendar')"
        });
      }
      
      // 5. Revenue milestone check
      if (stats.revenueThisMonth >= 1000 && stats.revenueThisMonth >= stats.revenueLastMonth * 1.2) {
        insights.push({
          icon: 'ðŸŽ‰',
          type: 'success',
          title: 'Great month so far!',
          desc: `$${stats.revenueThisMonth} this month - ${Math.round((stats.revenueThisMonth / stats.revenueLastMonth - 1) * 100)}% increase`,
          action: null,
          onclick: null
        });
      }
      
      // 6. New VIP client potential
      const potentialVIPs = clientsForInsights.filter(c => 
        (c.totalSessions || 0) === 5 && c.tier !== 'favored'
      );
      
      if (potentialVIPs.length > 0) {
        insights.push({
          icon: 'â­',
          type: 'info',
          title: `${potentialVIPs.length} client${potentialVIPs.length > 1 ? 's' : ''} close to VIP status`,
          desc: 'One more session to become VIP',
          action: 'View',
          onclick: `openClientModal('${potentialVIPs[0].id}')`
        });
      }
      
      // Render insights
      const insightsList = document.getElementById('insightsList');
      const insightCount = document.getElementById('insightCount');
      
      insightCount.textContent = insights.length;
      insightCount.style.display = insights.length > 0 ? 'inline' : 'none';
      
      if (insights.length === 0) {
        insightsList.innerHTML = `
          <div class="insights-empty">
            <div style="font-size: 48px; margin-bottom: 12px;">âœ¨</div>
            <div>All caught up! No action items right now.</div>
          </div>
        `;
      } else {
        insightsList.innerHTML = insights.map(insight => `
          <div class="insight-card" ${insight.onclick ? `onclick="${insight.onclick}"` : ''}>
            <div class="insight-icon ${insight.type}">${insight.icon}</div>
            <div class="insight-content">
              <div class="insight-title">${insight.title}</div>
              <div class="insight-desc">${insight.desc}</div>
            </div>
            ${insight.action ? `<button class="insight-action">${insight.action}</button>` : ''}
          </div>
        `).join('');
      }
    }
    
    // Show check-in list modal
    function showCheckinList(clientIds) {
      const clientsNeedingCheckin = clients.filter(c => clientIds.includes(c.id));
      
      // Create a simple alert with the list
      const names = clientsNeedingCheckin.map(c => `â€¢ ${c.name} (${c.email})`).join('\n');
      
      if (confirm(`Clients who may appreciate a check-in:\n\n${names}\n\nWould you like to go to the Clients page?`)) {
        showPage('clients');
        // Filter to show these clients
        filterClients('new');
      }
    }

    // ===========================================
    // BOOKINGS
    // ===========================================
    async function loadBookings() {
      showLoading(true);
      bookings = await api('/api/admin/bookings') || [];
      showLoading(false);
      renderBookings();
    }

    function renderBookings() {
      const search = document.getElementById('bookingSearch').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;

      let filtered = bookings;
      if (search) {
        filtered = filtered.filter(b => 
          b.name.toLowerCase().includes(search) ||
          b.email.toLowerCase().includes(search) ||
          b.phone.includes(search)
        );
      }
      if (status) {
        filtered = filtered.filter(b => b.status === status);
      }

      document.getElementById('bookingsTable').innerHTML = filtered.map(b => `
        <tr>
          <td>${new Date(b.createdAt).toLocaleDateString()}</td>
          <td><strong>${b.name}</strong></td>
          <td>
            <div>${b.email}</div>
            <small style="color: var(--soft-gray);">${b.phone}</small>
          </td>
          <td>${b.serviceName}</td>
          <td>$${b.servicePrice}</td>
          <td><span class="badge badge-${b.status}">${b.status}</span></td>
          <td>${b.confirmedDate ? `${b.confirmedDate} ${b.confirmedTime || ''}` : b.proposedDate ? `<span style="color: var(--gold);">ðŸ“§ Proposed: ${b.proposedDate}</span>` : '-'}</td>
          <td>
            <div class="quick-actions">
              <button class="action-btn" onclick="viewBooking('${b.id}')" title="View Details">ðŸ‘ï¸</button>
              <button class="action-btn" onclick="openBookingMessageModal('${b.id}')" title="Send Message">ðŸ’¬</button>
              ${b.status === 'pending' && !b.proposedDate ? `
                <button class="action-btn" onclick="openProposeTimeModal('${b.id}')" title="Propose Time" style="background: var(--gold);">ðŸ“…</button>
              ` : ''}
              ${b.status === 'pending' && b.proposedDate ? `
                <button class="action-btn" onclick="openProposeTimeModal('${b.id}')" title="Change Proposed Time" style="background: var(--warning);">ðŸ”„</button>
              ` : ''}
              ${b.status === 'pending' ? `
                <button class="action-btn" onclick="quickConfirm('${b.id}')" title="Confirm">âœ“</button>
              ` : ''}
              ${b.status === 'confirmed' ? `
                <button class="action-btn" onclick="sendReminder('${b.id}')" title="Send Reminder">ðŸ“§</button>
              ` : ''}
              ${b.status === 'completed' && !b.aftercareSent ? `
                <button class="action-btn" onclick="sendAftercare('${b.id}')" title="Send Aftercare Email">ðŸ’</button>
              ` : ''}
              ${b.aftercareSent ? `<span title="Aftercare sent" style="opacity:0.5;">ðŸ’</span>` : ''}
            </div>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="8" class="empty-state">No bookings found</td></tr>';
    }

    // Search and filter listeners
    document.getElementById('bookingSearch').addEventListener('input', renderBookings);
    document.getElementById('statusFilter').addEventListener('change', renderBookings);

    async function viewBooking(id) {
      showLoading(true);
      const booking = await api(`/api/admin/bookings/${id}`);
      showLoading(false);
      
      if (!booking) return;

      document.getElementById('bookingModalBody').innerHTML = `
        <div class="detail-grid">
          <div>
            <div class="detail-item">
              <div class="detail-label">Client Name</div>
              <div class="detail-value">${booking.name}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Email</div>
              <div class="detail-value">${booking.email}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Phone</div>
              <div class="detail-value">${booking.phone} ${booking.textPermission ? '(Text OK)' : ''}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Gender</div>
              <div class="detail-value">${booking.gender || 'Not specified'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Pronouns</div>
              <div class="detail-value">${booking.pronouns || 'Not specified'}</div>
            </div>
          </div>
          <div>
            <div class="detail-item">
              <div class="detail-label">Service</div>
              <div class="detail-value">${booking.serviceName}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Price</div>
              <div class="detail-value">$${booking.servicePrice}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value"><span class="badge badge-${booking.status}">${booking.status}</span></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Submitted</div>
              <div class="detail-value">${new Date(booking.createdAt).toLocaleString()}</div>
            </div>
          </div>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">

        <div class="detail-item">
          <div class="detail-label">Availability</div>
          <div class="detail-value">${booking.availability || 'Not specified'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Intentions</div>
          <div class="detail-value">${booking.intentions || 'Not provided'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Concerns</div>
          <div class="detail-value">${booking.concerns || 'None'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Health/Trauma Notes</div>
          <div class="detail-value">${booking.healthNotes || 'Prefer to discuss in person'}</div>
        </div>
        
        <div class="detail-item">
          <div class="detail-label">Sensory Sensitivities</div>
          <div class="detail-value">${booking.sensitivities || 'None noted'}</div>
        </div>

        <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">

        ${booking.status !== 'cancelled' ? `
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Confirmed Date</label>
              <input type="date" class="form-input" id="modalConfirmedDate" value="${booking.confirmedDate || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Confirmed Time</label>
              <input type="time" class="form-input" id="modalConfirmedTime" value="${booking.confirmedTime || ''}">
            </div>
          </div>
        ` : ''}

        <div class="form-group">
          <label class="form-label">Admin Notes</label>
          <textarea class="form-textarea" id="modalNotes" rows="3">${booking.notes || ''}</textarea>
        </div>

        ${booking.status === 'completed' ? `
          <div class="form-group">
            <label class="form-label">Session Notes (private)</label>
            <textarea class="form-textarea" id="modalSessionNotes" rows="3">${booking.sessionNotes || ''}</textarea>
          </div>
        ` : ''}
      `;

      document.getElementById('bookingModalFooter').innerHTML = `
        <button class="btn btn-outline" onclick="openEmailModal('${booking.id}', '${booking.email}', '${booking.name}')">ðŸ“§ Email Client</button>
        ${booking.status === 'pending' ? `
          <button class="btn btn-success" onclick="updateBookingStatus('${booking.id}', 'confirmed')">âœ“ Confirm</button>
        ` : ''}
        ${booking.status === 'confirmed' ? `
          <button class="btn btn-success" onclick="updateBookingStatus('${booking.id}', 'completed')">âœ“ Mark Complete</button>
        ` : ''}
        ${booking.status !== 'cancelled' && booking.status !== 'completed' ? `
          <button class="btn btn-danger" onclick="updateBookingStatus('${booking.id}', 'cancelled')">âœ— Cancel</button>
        ` : ''}
        <button class="btn btn-primary" onclick="saveBookingDetails('${booking.id}')">Save Changes</button>
      `;

      openModal('bookingModal');
    }

    async function saveBookingDetails(id) {
      const confirmedDate = document.getElementById('modalConfirmedDate')?.value;
      const confirmedTime = document.getElementById('modalConfirmedTime')?.value;
      const notes = document.getElementById('modalNotes').value;
      const sessionNotes = document.getElementById('modalSessionNotes')?.value;

      showLoading(true);
      const result = await api(`/api/admin/bookings/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ confirmedDate, confirmedTime, notes, sessionNotes })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Changes saved!', 'success');
        closeModal('bookingModal');
        loadBookings();
        refreshDashboard();
      }
    }

    async function updateBookingStatus(id, status) {
      // If confirming, also get the date/time from the modal fields
      let confirmedDate = document.getElementById('modalConfirmedDate')?.value;
      let confirmedTime = document.getElementById('modalConfirmedTime')?.value;
      
      // If confirming without a date, prompt for one
      if (status === 'confirmed' && !confirmedDate) {
        confirmedDate = prompt('Enter confirmed date (YYYY-MM-DD):');
        if (!confirmedDate) {
          showToast('Date is required to confirm booking', 'error');
          return;
        }
        confirmedTime = prompt('Enter confirmed time (e.g., 14:00):', '14:00') || '';
      }
      
      const sendConfirmation = status === 'confirmed' && confirm('Send confirmation email to client?');
      
      const payload = { status, sendConfirmation };
      if (status === 'confirmed') {
        payload.confirmedDate = confirmedDate;
        payload.confirmedTime = confirmedTime;
      }
      
      showLoading(true);
      const result = await api(`/api/admin/bookings/${id}`, {
        method: 'PATCH',
        body: JSON.stringify(payload)
      });
      showLoading(false);

      if (result?.success) {
        showToast(`Booking ${status}!`, 'success');
        closeModal('bookingModal');
        loadBookings();
        refreshDashboard();
      }
    }

    async function quickConfirm(id) {
      if (!confirm('Confirm this booking?')) return;
      await updateBookingStatus(id, 'confirmed');
    }

    async function sendReminder(id) {
      showLoading(true);
      const result = await api(`/api/admin/send-reminder/${id}`, { method: 'POST' });
      showLoading(false);
      
      if (result?.success) {
        showToast('Reminder sent!', 'success');
      }
    }

    // ===========================================
    // CALENDAR
    // ===========================================
    document.getElementById('prevMonth').addEventListener('click', () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('nextMonth').addEventListener('click', () => {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      renderCalendar();
    });

    document.getElementById('todayBtn').addEventListener('click', () => {
      currentCalendarDate = new Date();
      renderCalendar();
    });

    async function renderCalendar() {
      showLoading(true);
      const data = await api('/api/admin/calendar');
      showLoading(false);
      
      if (!data) return;

      const { events, blockedDates } = data;
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();

      document.getElementById('calendarTitle').textContent = 
        new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date().toDateString();

      let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']
        .map(d => `<div class="calendar-day-header">${d}</div>`).join('');

      // Previous month padding
      const prevMonthDays = new Date(year, month, 0).getDate();
      for (let i = firstDay - 1; i >= 0; i--) {
        html += `<div class="calendar-day other-month">${prevMonthDays - i}</div>`;
      }

      // Current month days
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dateObj = new Date(year, month, day);
        const isToday = dateObj.toDateString() === today;
        const isBlocked = blockedDates.some(b => b.date === dateStr);
        const dayEvents = events.filter(e => e.date === dateStr);

        let classes = ['calendar-day'];
        if (isToday) classes.push('today');
        if (isBlocked) classes.push('blocked');
        if (dayEvents.length) classes.push('has-event');

        html += `
          <div class="${classes.join(' ')}" onclick="${isBlocked ? '' : `calendarDayClick('${dateStr}')`}">
            <div>${day}</div>
            ${dayEvents.slice(0, 2).map(e => `<div class="calendar-event ${e.status}">${e.time || ''} ${e.clientName}${e.status === 'pending' ? ' (?)' : ''}</div>`).join('')}
            ${dayEvents.length > 2 ? `<div style="font-size: 10px; color: var(--soft-gray);">+${dayEvents.length - 2} more</div>` : ''}
          </div>
        `;
      }

      // Next month padding
      const totalCells = firstDay + daysInMonth;
      const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
      for (let i = 1; i <= remaining; i++) {
        html += `<div class="calendar-day other-month">${i}</div>`;
      }

      document.getElementById('calendarGrid').innerHTML = html;

      // Upcoming sessions list
      const upcoming = events
        .filter(e => new Date(e.date) >= new Date())
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 5);

      document.getElementById('upcomingList').innerHTML = upcoming.length ? upcoming.map(e => `
        <div class="client-card" onclick="viewBooking('${e.id}')">
          <div class="client-avatar">${e.clientName.charAt(0)}</div>
          <div class="client-info">
            <h4>${e.clientName}</h4>
            <p>${e.service}</p>
          </div>
          <div class="client-stats">
            <div class="sessions">${new Date(e.date).toLocaleDateString()}</div>
            <div>${e.time || 'TBD'}</div>
          </div>
        </div>
      `).join('') : '<div class="empty-state">No upcoming sessions</div>';
    }

    function calendarDayClick(date) {
      // Could open a modal to schedule on this date
      alert(`Selected: ${date}\n\nTo schedule a session, go to Bookings and set the confirmed date.`);
    }

    // ===========================================
    // APPOINTMENT REMINDERS
    // ===========================================
    async function loadReminders() {
      const data = await api('/api/admin/reminders');
      if (!data || !data.reminders) return;
      
      const remindersList = document.getElementById('remindersList');
      
      if (data.reminders.length === 0) {
        remindersList.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--soft-gray);">
            <div style="font-size: 32px; margin-bottom: 8px;">âœ¨</div>
            No sessions in the next 48 hours
          </div>
        `;
        return;
      }
      
      remindersList.innerHTML = data.reminders.map(r => `
        <div style="display: flex; align-items: center; gap: 16px; padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; background: ${r.hoursUntil <= 2 ? '#fff8e1' : 'var(--bg-card)'};">
          <div style="flex-shrink: 0; width: 48px; height: 48px; background: ${r.hoursUntil <= 2 ? 'var(--warning)' : r.hoursUntil <= 24 ? 'var(--gold)' : 'var(--burgundy)'}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
            ${r.hoursUntil}h
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 600;">${r.clientName}</div>
            <div style="font-size: 13px; color: var(--soft-gray);">
              ${new Date(r.sessionDate).toLocaleDateString()} ${r.sessionTime ? 'at ' + r.sessionTime : ''}
            </div>
            <div style="font-size: 12px; margin-top: 4px;">
              ${r.reminder24hSent ? 'âœ… 24h sent' : 'â³ 24h pending'} 
              ${r.reminder1hSent ? 'âœ… 1h sent' : 'â³ 1h pending'}
            </div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            ${!r.reminder24hSent && r.hoursUntil > 24 ? `
              <button class="btn btn-sm btn-outline" onclick="sendReminder('${r.bookingId}', '24h')">Send 24h</button>
            ` : ''}
            ${!r.reminder1hSent && r.hoursUntil > 1 ? `
              <button class="btn btn-sm btn-outline" onclick="sendReminder('${r.bookingId}', '1h')">Send 1h</button>
            ` : ''}
            <button class="btn btn-sm btn-outline" onclick="sendReminder('${r.bookingId}', 'welcome')">Send Welcome</button>
          </div>
        </div>
      `).join('');
    }

    async function sendReminder(bookingId, type) {
      const result = await api(`/api/admin/reminders/${bookingId}/send`, {
        method: 'POST',
        body: JSON.stringify({ type })
      });
      
      if (result?.success) {
        showToast(result.message, 'success');
        loadReminders();
      } else {
        showToast('Failed to send reminder', 'error');
      }
    }

    // ===========================================
    // CLIENTS
    // ===========================================
    let clientFilter = 'all';
    let currentClientId = null;
    let currentClientData = null;
    let pendingSuspendAction = null;

    async function loadClients() {
      showLoading(true);
      clients = await api('/api/admin/clients-with-messages') || [];
      showLoading(false);
      renderClients();
    }

    function filterClients(filter) {
      clientFilter = filter;
      document.querySelectorAll('.client-filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      renderClients();
    }

    // Helper to get client tier (matching server logic)
    function getClientTier(client) {
      if (client.tier) return client.tier;
      const sessions = client.totalSessions || 0;
      if (sessions >= 6) return 'vip';
      if (sessions >= 3) return 'regular';
      if (sessions >= 1) return 'returning';
      return 'new';
    }

    function updateFilterCounts() {
      // Status counts
      const allCount = clients.length;
      const unreadCount = clients.filter(c => c.unreadMessages > 0).length;
      const activeCount = clients.filter(c => !c.status || c.status === 'active').length;
      const suspendedCount = clients.filter(c => c.status === 'suspended').length;
      const bannedCount = clients.filter(c => c.status === 'banned').length;

      // Tier counts and message counts
      const favoredClients = clients.filter(c => c.tier === 'favored');
      const vipClients = clients.filter(c => getClientTier(c) === 'vip' && c.tier !== 'favored');
      const regularClients = clients.filter(c => getClientTier(c) === 'regular' && c.tier !== 'favored');
      const newClients = clients.filter(c => ['new', 'returning'].includes(getClientTier(c)) && c.tier !== 'favored');

      const favoredMsgs = favoredClients.reduce((sum, c) => sum + (c.unreadMessages || 0), 0);
      const vipMsgs = vipClients.reduce((sum, c) => sum + (c.unreadMessages || 0), 0);
      const regularMsgs = regularClients.reduce((sum, c) => sum + (c.unreadMessages || 0), 0);
      const newMsgs = newClients.reduce((sum, c) => sum + (c.unreadMessages || 0), 0);

      // Update status filter counts
      const setCount = (id, count) => {
        const el = document.getElementById(id);
        if (el) el.textContent = count > 0 ? count : '';
      };

      setCount('count-all', allCount);
      setCount('count-unread', unreadCount);
      setCount('count-active', activeCount);
      setCount('count-suspended', suspendedCount);
      setCount('count-banned', bannedCount);

      // Update tier filter counts
      setCount('count-favored', favoredClients.length);
      setCount('count-vip', vipClients.length);
      setCount('count-regular', regularClients.length);
      setCount('count-new', newClients.length);

      // Update message badges for tiers
      const setMsgBadge = (id, count) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = count > 0 ? `ðŸ’¬${count}` : '';
          el.classList.toggle('has-messages', count > 0);
        }
      };

      setMsgBadge('msg-favored', favoredMsgs);
      setMsgBadge('msg-vip', vipMsgs);
      setMsgBadge('msg-regular', regularMsgs);
      setMsgBadge('msg-new', newMsgs);
    }

    function renderClients() {
      const search = document.getElementById('clientSearch').value.toLowerCase();
      let filtered = [...clients];
      
      // Apply search
      if (search) {
        filtered = filtered.filter(c =>
          c.name?.toLowerCase().includes(search) ||
          c.email?.toLowerCase().includes(search) ||
          c.phone?.includes(search)
        );
      }

      // Apply filter - status filters
      if (clientFilter === 'unread') {
        filtered = filtered.filter(c => c.unreadMessages > 0);
      } else if (clientFilter === 'active') {
        filtered = filtered.filter(c => !c.status || c.status === 'active');
      } else if (clientFilter === 'suspended') {
        filtered = filtered.filter(c => c.status === 'suspended');
      } else if (clientFilter === 'banned') {
        filtered = filtered.filter(c => c.status === 'banned');
      } 
      // Tier filters
      else if (clientFilter === 'favored') {
        filtered = filtered.filter(c => c.tier === 'favored');
      } else if (clientFilter === 'vip') {
        filtered = filtered.filter(c => c.tier === 'vip' || (!c.tier && (c.totalSessions || 0) >= 6));
      } else if (clientFilter === 'regular') {
        filtered = filtered.filter(c => c.tier === 'regular' || (!c.tier && (c.totalSessions || 0) >= 3 && (c.totalSessions || 0) < 6));
      } else if (clientFilter === 'new') {
        filtered = filtered.filter(c => c.tier === 'new' || c.tier === 'returning' || (!c.tier && (c.totalSessions || 0) < 3));
      }

      // Update stats
      const needResponse = clients.filter(c => c.unreadMessages > 0).length;
      const repeatClients = clients.filter(c => c.totalSessions > 1).length;
      const lifetimeValue = clients.reduce((sum, c) => sum + (c.totalSpent || 0), 0);

      document.getElementById('clientsNeedResponseCount').textContent = needResponse;
      document.getElementById('totalClientsCount').textContent = clients.length;
      document.getElementById('repeatClientsCount').textContent = repeatClients;
      document.getElementById('totalLifetimeValue').textContent = `$${lifetimeValue.toLocaleString()}`;

      // Calculate filter counts and message counts per tier
      updateFilterCounts();

      // Render cards
      document.getElementById('clientsList').innerHTML = filtered.length ? filtered.map(c => {
        const statusClass = c.status === 'banned' ? 'banned' : c.status === 'suspended' ? 'suspended' : '';
        const hasUnread = c.unreadMessages > 0;
        const tierInfo = c.tierInfo || { emoji: 'ðŸŒ±', label: 'New', color: '#9E9E9E' };
        
        return `
          <div class="client-card ${statusClass} ${hasUnread ? 'has-unread' : ''}" onclick="openClientModal('${c.id}')">
            ${c.status && c.status !== 'active' ? `<span class="client-status-badge ${c.status}">${c.status}</span>` : ''}
            <span class="client-tier-badge" style="background: ${tierInfo.color};" title="${tierInfo.label}${c.tierManual ? ' (Manual)' : ''}">
              ${tierInfo.emoji} ${tierInfo.label}
            </span>
            <div class="client-card-header">
              <div class="client-avatar">
                ${c.name?.charAt(0) || '?'}
                ${hasUnread ? `<span class="message-dot">${c.unreadMessages}</span>` : ''}
              </div>
              <div class="client-info">
                <h4>
                  ${c.name || 'Unknown'}
                  <span class="status-indicator ${c.status || 'active'}"></span>
                </h4>
                <p>${c.email || ''}</p>
                ${c.phone ? `<p style="font-size: 12px;">${c.phone}</p>` : ''}
              </div>
            </div>
            <div class="client-stats-row">
              <div class="client-stat">
                <div class="client-stat-value">${c.totalSessions || 0}</div>
                <div class="client-stat-label">Sessions</div>
              </div>
              <div class="client-stat">
                <div class="client-stat-value">$${c.totalSpent || 0}</div>
                <div class="client-stat-label">Total</div>
              </div>
              <div class="client-stat">
                <div class="client-stat-value">${c.unreadMessages || 0}</div>
                <div class="client-stat-label">Unread</div>
              </div>
            </div>
            <div class="client-quick-actions" onclick="event.stopPropagation();">
              <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); quickMessage('${c.id}')">ðŸ’¬</button>
              <button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); quickEmail('${c.email}')">ðŸ“§</button>
              <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openClientModal('${c.id}')">View</button>
            </div>
          </div>
        `;
      }).join('') : `
        <div style="grid-column: 1 / -1;">
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ‘¥</div>
            <h3>${clientFilter !== 'all' ? 'No clients match this filter' : 'No clients yet'}</h3>
            <p>Clients will appear here after their first booking</p>
          </div>
        </div>
      `;
    }

    document.getElementById('clientSearch').addEventListener('input', renderClients);

    function quickMessage(clientId) {
      openClientModal(clientId);
      setTimeout(() => switchClientTab('messages'), 100);
    }

    function quickEmail(email) {
      window.open(`mailto:${email}?subject=Hello from Ravi Sacred Healing`);
    }

    async function openClientModal(id) {
      currentClientId = id;
      showLoading(true);
      
      const client = await api(`/api/admin/clients/${id}`);
      showLoading(false);
      
      if (!client) return;
      
      currentClientData = client;

      // Update header
      document.getElementById('modalClientAvatar').textContent = client.name?.charAt(0) || '?';
      document.getElementById('modalClientName').textContent = client.name || 'Unknown';
      document.getElementById('modalClientEmail').textContent = client.email || '';

      // Render Info tab
      renderClientInfoTab(client);
      
      // Render History tab
      renderClientHistoryTab(client);
      
      // Render Actions tab
      renderClientActionsTab(client);
      
      // Load messages
      loadClientModalMessages(client.email);

      // Reset to Info tab
      switchClientTab('info');
      
      openModal('clientModal');
    }

    function switchClientTab(tabName) {
      document.querySelectorAll('[data-clienttab]').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.clienttab === tabName);
      });
      document.querySelectorAll('[data-clientcontent]').forEach(content => {
        content.style.display = content.dataset.clientcontent === tabName ? 'block' : 'none';
      });
    }

    function renderClientInfoTab(client) {
      const tierInfo = client.tierInfo || { emoji: 'ðŸŒ±', label: 'New', color: '#9E9E9E' };
      const tier = client.tier || 'new';
      
      document.getElementById('clientTabInfo').innerHTML = `
        <!-- Client Tier Section -->
        <div style="background: linear-gradient(135deg, ${tierInfo.color}15 0%, ${tierInfo.color}05 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid ${tierInfo.color};">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
            <div>
              <div style="font-size: 24px; margin-bottom: 4px;">${tierInfo.emoji} ${tierInfo.label}</div>
              <div style="font-size: 13px; color: var(--soft-gray);">
                ${client.tierManual ? 'âœï¸ Manually set' : 'ðŸ”„ Auto-calculated'} 
                ${client.tierNotes ? ` â€¢ ${client.tierNotes}` : ''}
              </div>
            </div>
            <div>
              <select id="tierSelect" onchange="updateClientTier('${client.id}')" style="padding: 8px 12px; border: 2px solid ${tierInfo.color}; border-radius: 8px; font-size: 14px; cursor: pointer;">
                <option value="new" ${tier === 'new' ? 'selected' : ''}>ðŸŒ± New Client</option>
                <option value="returning" ${tier === 'returning' ? 'selected' : ''}>ðŸŒ¿ Returning</option>
                <option value="regular" ${tier === 'regular' ? 'selected' : ''}>ðŸŒ³ Regular</option>
                <option value="vip" ${tier === 'vip' ? 'selected' : ''}>â­ VIP</option>
                <option value="favored" ${tier === 'favored' ? 'selected' : ''}>ðŸ’Ž Favored</option>
              </select>
              ${client.tierManual ? `
                <button class="btn btn-sm btn-outline" style="margin-left: 8px;" onclick="resetToAutoTier('${client.id}')" title="Reset to auto-calculated tier">â†º</button>
              ` : ''}
            </div>
          </div>
          <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid ${tierInfo.color}30;">
            <label style="font-size: 12px; color: var(--soft-gray);">Tier Note (optional)</label>
            <input type="text" id="tierNotesInput" value="${client.tierNotes || ''}" placeholder="e.g., Referred by Dr. Smith, long-time client..." 
              style="width: 100%; padding: 8px; border: 1px solid #e0d6cc; border-radius: 6px; font-size: 13px; margin-top: 4px;"
              onchange="saveTierNotes('${client.id}')">
          </div>
        </div>

        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
          <span style="background: #e3f2fd; padding: 6px 12px; border-radius: 20px; font-size: 12px;">
            ðŸ“‹ Intake: <strong>${tierInfo.intakeLevel === 'full' ? 'Full' : tierInfo.intakeLevel === 'short' ? 'Short' : 'Minimal'}</strong>
          </span>
          <span style="background: #f3e5f5; padding: 6px 12px; border-radius: 20px; font-size: 12px;">
            ðŸ”„ Sessions: <strong>${(client.sessions?.filter(s => s.status === 'completed').length) || 0} completed</strong>
          </span>
        </div>
        
        <div class="detail-grid">
          <div>
            <div class="detail-item">
              <div class="detail-label">ðŸ“§ Email</div>
              <div class="detail-value"><a href="mailto:${client.email}">${client.email}</a></div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ðŸ“± Phone</div>
              <div class="detail-value">${client.phone || 'Not provided'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ðŸ‘¤ Pronouns</div>
              <div class="detail-value">${client.pronouns || 'Not specified'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ðŸ“… First Contact</div>
              <div class="detail-value">${client.createdAt ? new Date(client.createdAt).toLocaleDateString() : 'Unknown'}</div>
            </div>
          </div>
          <div>
            <div class="detail-item">
              <div class="detail-label">ðŸ’« Total Sessions</div>
              <div class="detail-value" style="font-size: 24px; color: var(--burgundy);">${client.totalSessions || 0}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ðŸ’° Lifetime Value</div>
              <div class="detail-value" style="font-size: 24px; color: var(--success);">$${client.totalSpent || 0}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">â° Last Contact</div>
              <div class="detail-value">${client.lastContact ? new Date(client.lastContact).toLocaleDateString() : 'Never'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">ðŸ›¡ï¸ Status</div>
              <div class="detail-value">
                <span class="badge ${client.status === 'banned' ? 'badge-cancelled' : client.status === 'suspended' ? 'badge-pending' : 'badge-confirmed'}" style="font-size: 12px;">
                  ${(client.status || 'active').toUpperCase()}
                </span>
              </div>
            </div>
          </div>
        </div>
        ${client.statusReason ? `
          <div style="background: #fff8e6; padding: 12px; border-radius: 8px; margin-top: 16px;">
            <strong>Status Reason:</strong> ${client.statusReason}
          </div>
        ` : ''}
        
        <!-- Private Session Notes -->
        <div style="margin-top: 24px; padding-top: 20px; border-top: 2px solid #f0ebe4;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <h4 style="margin: 0; display: flex; align-items: center; gap: 8px;">
              ðŸ“ Private Session Notes
              <span style="font-size: 11px; background: #e8f5e9; color: #2e7d32; padding: 3px 8px; border-radius: 10px;">Only you can see</span>
            </h4>
            <button class="btn btn-sm btn-outline" onclick="saveClientNotes('${client.id}')" id="saveNotesBtn">ðŸ’¾ Save</button>
          </div>
          <textarea id="clientNotesTextarea" 
            style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e0d6cc; border-radius: 8px; font-size: 14px; line-height: 1.6; resize: vertical;"
            placeholder="Add notes about sessions, breakthroughs, things to remember for next time...

Example:
- Jan 15: Focused on heart opening, emotional release around mother
- Jan 22: Follow-up session, noticed more openness. Mentioned job stress.
- Prefers lavender essential oil. Sensitive to cold."
          >${client.notes || ''}</textarea>
          <div style="font-size: 11px; color: var(--soft-gray); margin-top: 8px;">
            ðŸ’¡ Tip: Note patterns, breakthroughs, preferences, or anything that helps continuity of care.
          </div>
        </div>
      `;
    }

    function renderClientHistoryTab(client) {
      const bookings = client.bookings || [];
      const tierInfo = client.tierInfo || { emoji: 'ðŸŒ±', label: 'New', color: '#9E9E9E' };
      
      // Create timeline events from bookings and other milestones
      const events = [];
      
      // Add first contact event
      if (client.createdAt) {
        events.push({
          date: client.createdAt,
          type: 'milestone',
          icon: 'ðŸŒ±',
          title: 'Journey Began',
          desc: 'First contact with Ravi'
        });
      }
      
      // Add booking events
      bookings.forEach(b => {
        events.push({
          date: b.confirmedDate || b.createdAt,
          type: 'session',
          status: b.status,
          icon: b.status === 'completed' ? 'âœ¨' : b.status === 'confirmed' ? 'ðŸ“…' : b.status === 'cancelled' ? 'âŒ' : 'â³',
          title: b.serviceName || 'Session',
          desc: b.status === 'completed' ? `Completed session - $${b.servicePrice || 0}` : 
                b.status === 'confirmed' ? `Scheduled${b.confirmedTime ? ' at ' + b.confirmedTime : ''}` :
                b.status === 'cancelled' ? 'Cancelled' : 'Pending approval',
          price: b.servicePrice
        });
      });
      
      // Add tier milestones
      if ((client.totalSessions || 0) >= 3 && (client.totalSessions || 0) < 6) {
        events.push({
          date: bookings[2]?.confirmedDate || new Date().toISOString(),
          type: 'milestone',
          icon: 'ðŸŒ³',
          title: 'Became Regular Client',
          desc: 'Completed 3rd session'
        });
      }
      
      if ((client.totalSessions || 0) >= 6) {
        events.push({
          date: bookings[5]?.confirmedDate || new Date().toISOString(),
          type: 'milestone',
          icon: 'â­',
          title: 'Achieved VIP Status',
          desc: 'Completed 6th session'
        });
      }
      
      if (client.tier === 'favored') {
        events.push({
          date: new Date().toISOString(),
          type: 'milestone',
          icon: 'ðŸ’Ž',
          title: 'Marked as Favored',
          desc: client.tierNotes || 'Special client status'
        });
      }
      
      // Sort events by date (newest first)
      events.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Calculate relationship stats
      const completedSessions = bookings.filter(b => b.status === 'completed').length;
      const totalSpent = bookings.filter(b => b.status === 'completed').reduce((sum, b) => sum + (b.servicePrice || 0), 0);
      const firstSession = bookings.length > 0 ? new Date(Math.min(...bookings.map(b => new Date(b.createdAt || b.confirmedDate)))) : null;
      const relationshipDays = firstSession ? Math.floor((new Date() - firstSession) / (1000 * 60 * 60 * 24)) : 0;
      
      document.getElementById('clientTabHistory').innerHTML = `
        <!-- Journey Overview -->
        <div style="background: linear-gradient(135deg, ${tierInfo.color}15 0%, white 100%); padding: 20px; border-radius: 12px; margin-bottom: 24px; border: 1px solid ${tierInfo.color}40;">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
            <div>
              <div style="font-size: 28px; font-weight: 600; color: var(--burgundy);">${completedSessions}</div>
              <div style="font-size: 12px; color: var(--soft-gray);">Sessions</div>
            </div>
            <div>
              <div style="font-size: 28px; font-weight: 600; color: var(--success);">$${totalSpent}</div>
              <div style="font-size: 12px; color: var(--soft-gray);">Total Spent</div>
            </div>
            <div>
              <div style="font-size: 28px; font-weight: 600; color: var(--gold);">${relationshipDays}</div>
              <div style="font-size: 12px; color: var(--soft-gray);">Days Together</div>
            </div>
            <div>
              <div style="font-size: 28px;">${tierInfo.emoji}</div>
              <div style="font-size: 12px; color: var(--soft-gray);">${tierInfo.label}</div>
            </div>
          </div>
        </div>
        
        <!-- Timeline -->
        <h4 style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
          ðŸ• Journey Timeline
          <span style="font-size: 12px; color: var(--soft-gray); font-weight: normal;">${events.length} events</span>
        </h4>
        
        <div class="journey-timeline">
          ${events.length ? events.map((e, i) => `
            <div class="timeline-event ${e.type}" style="--event-color: ${e.type === 'milestone' ? 'var(--gold)' : e.status === 'completed' ? 'var(--success)' : e.status === 'confirmed' ? 'var(--burgundy)' : e.status === 'cancelled' ? 'var(--danger)' : 'var(--warning)'}">
              <div class="timeline-dot">${e.icon}</div>
              <div class="timeline-content">
                <div class="timeline-date">${new Date(e.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
                <div class="timeline-title">${e.title}</div>
                <div class="timeline-desc">${e.desc}</div>
              </div>
            </div>
          `).join('') : '<p style="color: var(--soft-gray); text-align: center; padding: 40px;">No events yet</p>'}
        </div>
      `;
    }

    function renderClientActionsTab(client) {
      const status = client.status || 'active';
      
      let actionButtons = '';
      
      if (status === 'active') {
        actionButtons = `
          <button class="btn btn-outline" style="width: 100%; margin-bottom: 12px; justify-content: center;" onclick="initiateSuspend('suspend')">
            âš ï¸ Suspend Client
          </button>
          <p style="font-size: 13px; color: var(--soft-gray); margin-bottom: 20px;">
            Temporarily prevent this client from booking new sessions or accessing their portal.
          </p>
          
          <button class="btn" style="width: 100%; background: var(--danger); color: white; justify-content: center;" onclick="initiateSuspend('ban')">
            ðŸš« Ban Client
          </button>
          <p style="font-size: 13px; color: var(--soft-gray);">
            Permanently remove this client's access. Use for serious policy violations.
          </p>
        `;
      } else if (status === 'suspended') {
        actionButtons = `
          <div style="background: #fff3cd; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <strong>âš ï¸ This client is currently suspended</strong>
            ${client.statusReason ? `<p style="margin: 8px 0 0 0; font-size: 13px;">Reason: ${client.statusReason}</p>` : ''}
          </div>
          
          <button class="btn btn-primary" style="width: 100%; margin-bottom: 12px; justify-content: center;" onclick="reinstateClient()">
            âœ… Reinstate Client
          </button>
          <p style="font-size: 13px; color: var(--soft-gray); margin-bottom: 20px;">
            Restore full access to booking and portal.
          </p>
          
          <button class="btn" style="width: 100%; background: var(--danger); color: white; justify-content: center;" onclick="initiateSuspend('ban')">
            ðŸš« Upgrade to Ban
          </button>
        `;
      } else if (status === 'banned') {
        actionButtons = `
          <div style="background: #f8d7da; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
            <strong>ðŸš« This client is banned</strong>
            ${client.statusReason ? `<p style="margin: 8px 0 0 0; font-size: 13px;">Reason: ${client.statusReason}</p>` : ''}
            ${client.statusChangedAt ? `<p style="margin: 4px 0 0 0; font-size: 12px; color: #666;">Banned on: ${new Date(client.statusChangedAt).toLocaleDateString()}</p>` : ''}
          </div>
          
          <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="reinstateClient()">
            âœ… Reinstate Client
          </button>
          <p style="font-size: 13px; color: var(--soft-gray);">
            This will restore full access to the client's account.
          </p>
        `;
      }

      document.getElementById('clientActionButtons').innerHTML = actionButtons;
      document.getElementById('clientModalNotes').value = client.notes || '';
    }

    async function loadClientModalMessages(email) {
      const messages = await api(`/api/admin/messages/${encodeURIComponent(email.toLowerCase())}`);
      const container = document.getElementById('clientModalMessages');
      
      if (!messages?.messages || messages.messages.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--soft-gray); padding: 20px;">No messages yet. Send the first message below!</p>';
        document.getElementById('modalUnreadBadge').style.display = 'none';
        return;
      }

      const unreadCount = messages.messages.filter(m => m.from === 'client' && !m.read).length;
      const badge = document.getElementById('modalUnreadBadge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }

      container.innerHTML = messages.messages.map(msg => `
        <div style="display: flex; flex-direction: column; align-items: ${msg.from === 'client' ? 'flex-start' : 'flex-end'}; margin-bottom: 12px;">
          <div style="background: ${msg.from === 'client' ? '#f8f5f0' : 'var(--burgundy)'}; color: ${msg.from === 'client' ? 'var(--charcoal)' : 'white'}; padding: 12px 16px; border-radius: 12px; max-width: 85%; ${msg.from === 'client' ? 'border-bottom-left-radius: 4px;' : 'border-bottom-right-radius: 4px;'}">
            <div style="font-size: 11px; font-weight: 600; margin-bottom: 4px; opacity: 0.8;">${msg.from === 'client' ? (msg.fromName || 'Client') : 'ðŸª· You'}</div>
            <div style="white-space: pre-wrap;">${escapeHtml(msg.message)}</div>
            <div style="font-size: 10px; opacity: 0.7; margin-top: 6px;">${formatDateTime(msg.createdAt)}</div>
          </div>
        </div>
      `).join('');
      
      container.scrollTop = container.scrollHeight;
    }

    async function sendClientModalReply() {
      if (!currentClientData) return;
      
      const input = document.getElementById('clientModalReplyInput');
      const message = input.value.trim();
      const sendEmail = document.getElementById('clientModalSendEmail').checked;
      
      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }
      
      showLoading(true);
      const result = await api(`/api/admin/messages/${encodeURIComponent(currentClientData.email.toLowerCase())}/reply`, {
        method: 'POST',
        body: JSON.stringify({ message, sendEmail })
      });
      showLoading(false);
      
      if (result?.success) {
        input.value = '';
        showToast('Message sent!', 'success');
        loadClientModalMessages(currentClientData.email);
        loadClients(); // Refresh to update unread counts
      } else {
        showToast(result?.error || 'Failed to send message', 'error');
      }
    }

    async function saveClientModalNotes() {
      if (!currentClientId) return;
      
      const notes = document.getElementById('clientModalNotes').value;
      showLoading(true);
      const result = await api(`/api/admin/clients/${currentClientId}`, {
        method: 'PATCH',
        body: JSON.stringify({ notes })
      });
      showLoading(false);
      
      if (result?.success) {
        showToast('Notes saved!', 'success');
      }
    }

    function initiateSuspend(action) {
      pendingSuspendAction = action;
      
      const modal = document.getElementById('suspendConfirmModal');
      const header = document.getElementById('suspendModalHeader');
      const title = document.getElementById('suspendModalTitle');
      const message = document.getElementById('suspendModalMessage');
      const btn = document.getElementById('suspendConfirmBtn');
      
      if (action === 'ban') {
        header.style.background = 'var(--danger)';
        title.textContent = 'ðŸš« Confirm Ban';
        message.innerHTML = `
          <strong>Are you sure you want to ban ${currentClientData?.name || 'this client'}?</strong>
          <p style="margin-top: 8px; color: var(--soft-gray);">
            This will permanently remove their access to booking and the client portal.
          </p>
        `;
        btn.style.background = 'var(--danger)';
        btn.textContent = 'Ban Client';
      } else {
        header.style.background = 'var(--warning)';
        title.textContent = 'âš ï¸ Confirm Suspension';
        message.innerHTML = `
          <strong>Are you sure you want to suspend ${currentClientData?.name || 'this client'}?</strong>
          <p style="margin-top: 8px; color: var(--soft-gray);">
            This will temporarily prevent them from booking new sessions.
          </p>
        `;
        btn.style.background = 'var(--warning)';
        btn.textContent = 'Suspend Client';
      }
      
      document.getElementById('suspendReason').value = '';
      document.getElementById('suspendNotifyClient').checked = false;
      
      openModal('suspendConfirmModal');
    }

    async function confirmSuspendAction() {
      if (!currentClientId || !pendingSuspendAction) return;
      
      const reason = document.getElementById('suspendReason').value;
      const notifyClient = document.getElementById('suspendNotifyClient').checked;
      
      showLoading(true);
      const result = await api(`/api/admin/clients/${currentClientId}/suspend`, {
        method: 'POST',
        body: JSON.stringify({ 
          action: pendingSuspendAction, 
          reason, 
          notifyClient 
        })
      });
      showLoading(false);
      
      if (result?.success) {
        showToast(`Client ${pendingSuspendAction === 'ban' ? 'banned' : 'suspended'} successfully`, 'success');
        closeModal('suspendConfirmModal');
        closeModal('clientModal');
        loadClients();
      } else {
        showToast(result?.error || 'Action failed', 'error');
      }
      
      pendingSuspendAction = null;
    }

    async function reinstateClient() {
      if (!currentClientId) return;
      
      if (!confirm(`Are you sure you want to reinstate ${currentClientData?.name || 'this client'}? They will regain full access.`)) {
        return;
      }
      
      showLoading(true);
      const result = await api(`/api/admin/clients/${currentClientId}/suspend`, {
        method: 'POST',
        body: JSON.stringify({ action: 'reinstate' })
      });
      showLoading(false);
      
      if (result?.success) {
        showToast('Client reinstated successfully!', 'success');
        closeModal('clientModal');
        loadClients();
      } else {
        showToast(result?.error || 'Failed to reinstate client', 'error');
      }
    }

    // ===========================================
    // CLIENT TIER MANAGEMENT
    // ===========================================

    async function updateClientTier(clientId) {
      const tierSelect = document.getElementById('tierSelect');
      const tier = tierSelect.value;
      const tierNotes = document.getElementById('tierNotesInput')?.value || '';
      
      showLoading(true);
      const result = await api(`/api/admin/clients/${clientId}`, {
        method: 'PATCH',
        body: JSON.stringify({ 
          tier, 
          tierManual: true,
          tierNotes 
        })
      });
      showLoading(false);
      
      if (result?.success) {
        const tierEmojis = { new: 'ðŸŒ±', returning: 'ðŸŒ¿', regular: 'ðŸŒ³', vip: 'â­', favored: 'ðŸ’Ž' };
        showToast(`Client tier updated to ${tierEmojis[tier] || ''} ${tier}`, 'success');
        // Refresh the modal to show updated data
        openClientModal(clientId);
        loadClients();
      } else {
        showToast(result?.error || 'Failed to update tier', 'error');
      }
    }

    async function resetToAutoTier(clientId) {
      if (!confirm('Reset to auto-calculated tier based on session count?')) return;
      
      showLoading(true);
      const result = await api(`/api/admin/clients/${clientId}`, {
        method: 'PATCH',
        body: JSON.stringify({ tierManual: false })
      });
      showLoading(false);
      
      if (result?.success) {
        showToast('Tier reset to auto-calculated!', 'success');
        openClientModal(clientId);
        loadClients();
      } else {
        showToast(result?.error || 'Failed to reset tier', 'error');
      }
    }

    async function saveTierNotes(clientId) {
      const tierNotes = document.getElementById('tierNotesInput')?.value || '';
      
      await api(`/api/admin/clients/${clientId}`, {
        method: 'PATCH',
        body: JSON.stringify({ tierNotes })
      });
      
      showToast('Tier notes saved', 'success');
    }

    // Legacy function for compatibility
    async function viewClient(id) {
      openClientModal(id);
    }

    async function updateClientNotes(id) {
      const notes = document.getElementById('clientNotes')?.value;
      if (!notes) return;
      await api(`/api/admin/clients/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ notes })
      });
    }

    async function saveClientNotes(clientId) {
      const notes = document.getElementById('clientNotesTextarea')?.value || '';
      const btn = document.getElementById('saveNotesBtn');
      
      if (btn) {
        btn.textContent = 'â³ Saving...';
        btn.disabled = true;
      }
      
      const result = await api(`/api/admin/clients/${clientId}`, {
        method: 'PATCH',
        body: JSON.stringify({ notes })
      });
      
      if (btn) {
        btn.textContent = 'âœ“ Saved!';
        setTimeout(() => {
          btn.textContent = 'ðŸ’¾ Save';
          btn.disabled = false;
        }, 2000);
      }
      
      showToast('Notes saved', 'success');
    }

    // ===========================================
    // INVITATION CODES
    // ===========================================
    async function loadInvitationCodes() {
      showLoading(true);
      invitationCodes = await api('/api/admin/invitation-codes') || [];
      showLoading(false);
      renderInvitationCodes();
    }

    function filterCodes(filter) {
      codeFilter = filter;
      document.querySelectorAll('#page-invitations .tabs .tab').forEach((tab, i) => {
        tab.classList.toggle('active', 
          (filter === 'all' && i === 0) || 
          (filter === 'available' && i === 1) || 
          (filter === 'used' && i === 2)
        );
      });
      renderInvitationCodes();
    }

    function renderInvitationCodes() {
      let filtered = [...invitationCodes].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      
      if (codeFilter === 'available') {
        filtered = filtered.filter(c => c.active && !c.usedBy);
      } else if (codeFilter === 'used') {
        filtered = filtered.filter(c => c.usedBy);
      }
      
      // Update stats
      document.getElementById('totalCodesCount').textContent = invitationCodes.length;
      document.getElementById('availableCodesCount').textContent = invitationCodes.filter(c => c.active && !c.usedBy).length;
      document.getElementById('usedCodesCount').textContent = invitationCodes.filter(c => c.usedBy).length;

      document.getElementById('invitationCodesTable').innerHTML = filtered.map(c => {
        const isExpired = c.expiresAt && new Date(c.expiresAt) < new Date();
        const status = c.usedBy ? 'used' : (!c.active || isExpired) ? 'expired' : 'available';
        const statusBadge = {
          used: '<span class="badge badge-confirmed">Used</span>',
          expired: '<span class="badge badge-cancelled">Expired</span>',
          available: '<span class="badge badge-pending" style="background: #e8f5e9; color: #2e7d32;">Available</span>'
        };

        return `
          <tr>
            <td>
              <code style="background: #f5f0eb; padding: 6px 12px; border-radius: 4px; font-weight: 600; letter-spacing: 1px; font-size: 14px;">
                ${c.code}
              </code>
              <button onclick="copyCode('${c.code}')" class="btn" style="padding: 4px 8px; font-size: 12px; margin-left: 8px;" title="Copy">ðŸ“‹</button>
            </td>
            <td>${c.label || '-'}</td>
            <td>${new Date(c.createdAt).toLocaleDateString()}</td>
            <td>${statusBadge[status]}</td>
            <td>${c.usedBy ? `<span style="color: var(--burgundy);">${c.usedBy}</span><br><small style="color: var(--soft-gray);">${new Date(c.usedAt).toLocaleDateString()}</small>` : '-'}</td>
            <td>
              ${status === 'available' ? `
                <button class="action-btn" onclick="deactivateCode('${c.id}')" title="Deactivate">ðŸ—‘ï¸</button>
              ` : ''}
            </td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="6" class="empty-state">No invitation codes yet. Generate some!</td></tr>';
    }

    function copyCode(code) {
      navigator.clipboard.writeText(code);
      showToast('Code copied: ' + code, 'success');
    }

    function openGenerateCodesModal() {
      document.getElementById('codeCount').value = '10';
      document.getElementById('codePrefix').value = '';
      document.getElementById('codeLabel').value = '';
      document.getElementById('codeExpiry').value = '90';
      openModal('generateCodesModal');
    }

    async function generateCodes() {
      const count = parseInt(document.getElementById('codeCount').value);
      const prefix = document.getElementById('codePrefix').value || null;
      const label = document.getElementById('codeLabel').value || null;
      const expiresInDays = parseInt(document.getElementById('codeExpiry').value) || null;

      showLoading(true);
      const result = await api('/api/admin/invitation-codes/generate', {
        method: 'POST',
        body: JSON.stringify({ count, prefix, label, expiresInDays })
      });
      showLoading(false);

      if (result?.success) {
        showToast(`âœ¨ Generated ${result.codes.length} invitation code(s)!`, 'success');
        closeModal('generateCodesModal');
        loadInvitationCodes();
      } else {
        showToast(result?.error || 'Failed to generate codes', 'error');
      }
    }

    async function deactivateCode(id) {
      if (!confirm('Deactivate this invitation code?')) return;

      showLoading(true);
      const result = await api(`/api/admin/invitation-codes/${id}`, { method: 'DELETE' });
      showLoading(false);

      if (result?.success) {
        showToast('Code deactivated', 'success');
        loadInvitationCodes();
      }
    }

    function printCodes() {
      const available = invitationCodes.filter(c => c.active && !c.usedBy);
      if (available.length === 0) {
        showToast('No available codes to print', 'error');
        return;
      }

      document.getElementById('printPreview').style.display = 'block';
      document.getElementById('printableCards').innerHTML = available.map(c => `
        <div class="business-card">
          <div style="text-align: center;">
            <div style="font-size: 48px; margin-bottom: 12px;">ðŸª·</div>
            <div style="font-family: Georgia, serif; color: #722F37; font-size: 22px; font-weight: 600; margin-bottom: 6px;">Ravi</div>
            <div style="font-size: 14px; color: #483434; margin-bottom: 24px; font-style: italic;">Intuitive Healer & Sensual Bodyworker</div>
            
            <div style="border-top: 2px solid #D4AF37; border-bottom: 2px solid #D4AF37; padding: 16px 0; margin: 20px 0;">
              <div style="font-size: 11px; color: #666; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1.5px;">Your Private Invitation Code</div>
              <div style="background: linear-gradient(135deg, #722F37 0%, #5a2429 100%); color: white; padding: 14px 24px; border-radius: 8px; font-size: 24px; letter-spacing: 4px; font-weight: 700; font-family: 'Courier New', monospace; box-shadow: 0 4px 8px rgba(114, 47, 55, 0.3);">
                ${c.code}
              </div>
            </div>
            
            <div style="margin-top: 20px; font-size: 13px; color: #666;">
              <div style="margin-bottom: 8px;">
                <strong style="color: #722F37;">Book Your Session:</strong><br>
                <span style="font-size: 12px;">localhost:3000</span>
              </div>
              ${c.label ? `<div style="font-size: 10px; color: #999; margin-top: 12px; font-style: italic;">${c.label}</div>` : ''}
              ${c.expiresAt ? `<div style="font-size: 10px; color: #999; margin-top: 8px;">Valid until: ${new Date(c.expiresAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>` : ''}
            </div>
          </div>
        </div>
      `).join('');

      // Scroll to preview
      document.getElementById('printPreview').scrollIntoView({ behavior: 'smooth' });
      
      // Open print dialog after a short delay
      setTimeout(() => {
        if (confirm('Open print dialog? (You can also right-click to print later)')) {
          window.print();
        }
      }, 500);
    }

    // ===========================================
    // INQUIRIES
    // ===========================================
    async function loadInquiries() {
      showLoading(true);
      inquiries = await api('/api/admin/inquiries') || [];
      showLoading(false);
      renderInquiries();
      updateInquiriesBadge();
    }

    function updateInquiriesBadge() {
      const newCount = inquiries.filter(i => i.status === 'new').length;
      const badge = document.getElementById('inquiriesBadge');
      if (newCount > 0) {
        badge.textContent = newCount;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderInquiries() {
      const newCount = inquiries.filter(i => i.status === 'new').length;
      const invitedCount = inquiries.filter(i => i.status === 'invited').length;
      
      document.getElementById('newInquiriesCount').textContent = newCount;
      document.getElementById('invitedInquiriesCount').textContent = invitedCount;
      document.getElementById('totalInquiriesCount').textContent = inquiries.length;

      const sorted = [...inquiries].sort((a, b) => {
        // New first, then by date
        if (a.status === 'new' && b.status !== 'new') return -1;
        if (b.status === 'new' && a.status !== 'new') return 1;
        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      document.getElementById('inquiriesList').innerHTML = sorted.length ? sorted.map(i => {
        const statusBadge = {
          new: '<span class="badge" style="background: var(--gold); color: white;">New</span>',
          reviewed: '<span class="badge badge-pending">Reviewed</span>',
          invited: '<span class="badge badge-confirmed">Invited</span>',
          declined: '<span class="badge badge-cancelled">Declined</span>'
        };

        return `
          <div class="content-item" style="border-left: 4px solid ${i.status === 'new' ? 'var(--gold)' : i.status === 'invited' ? 'var(--success)' : '#e0d6cc'};">
            <div class="content-item-header">
              <div>
                <h4 style="margin-bottom: 4px;">${i.name}</h4>
                <div style="font-size: 13px; color: var(--soft-gray);">
                  ${i.email} ${i.phone ? `â€¢ ${i.phone}` : ''}
                </div>
                <div style="font-size: 12px; color: var(--soft-gray); margin-top: 4px;">
                  ${new Date(i.createdAt).toLocaleDateString()} at ${new Date(i.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                </div>
              </div>
              <div style="text-align: right;">
                ${statusBadge[i.status]}
                ${i.invitationCode ? `<div style="font-size: 12px; margin-top: 4px; color: var(--burgundy);"><code>${i.invitationCode}</code></div>` : ''}
              </div>
            </div>
            <div style="background: #f8f5f0; padding: 12px; border-radius: 8px; margin: 12px 0; font-style: italic; color: var(--charcoal);">
              "${i.message}"
            </div>
            <div class="content-item-actions" style="justify-content: flex-start; gap: 8px;">
              ${i.status === 'new' ? `
                <button class="btn btn-sm btn-primary" onclick="sendInvitationToInquiry('${i.id}')" style="background: var(--gold);">
                  ðŸŽŸï¸ Send Invitation
                </button>
                <button class="btn btn-sm btn-outline" onclick="markInquiryReviewed('${i.id}')">
                  Mark Reviewed
                </button>
              ` : ''}
              ${i.status === 'reviewed' ? `
                <button class="btn btn-sm btn-primary" onclick="sendInvitationToInquiry('${i.id}')" style="background: var(--gold);">
                  ðŸŽŸï¸ Send Invitation
                </button>
              ` : ''}
              ${i.status === 'invited' ? `
                <span style="color: var(--success); font-size: 13px;">âœ“ Invitation sent</span>
              ` : ''}
              <button class="btn btn-sm btn-outline" onclick="emailInquiry('${i.id}')" style="margin-left: auto;">
                ðŸ“§ Email
              </button>
            </div>
          </div>
        `;
      }).join('') : '<p style="text-align: center; color: var(--soft-gray); padding: 40px;">No inquiries yet. They will appear here when visitors contact you through the site.</p>';
    }

    async function markInquiryReviewed(id) {
      showLoading(true);
      const result = await api(`/api/admin/inquiries/${id}/status`, {
        method: 'PATCH',
        body: JSON.stringify({ status: 'reviewed' })
      });
      showLoading(false);

      if (result?.success) {
        loadInquiries();
      }
    }

    async function sendInvitationToInquiry(id) {
      const inquiry = inquiries.find(i => i.id === id);
      if (!inquiry) return;

      if (!confirm(`Send an invitation code to ${inquiry.name} (${inquiry.email})?`)) return;

      showLoading(true);
      const result = await api(`/api/admin/inquiries/${id}/invite`, { method: 'POST' });
      showLoading(false);

      if (result?.success) {
        showToast(`âœ¨ Invitation sent to ${inquiry.name}!`, 'success');
        loadInquiries();
      } else {
        showToast(result?.error || 'Failed to send invitation', 'error');
      }
    }

    function emailInquiry(id) {
      const inquiry = inquiries.find(i => i.id === id);
      if (inquiry) {
        window.open(`mailto:${inquiry.email}?subject=Re: Your Inquiry - Ravi Sacred Healing`);
      }
    }

    // ===========================================
    // SECURE MESSAGING
    // ===========================================
    let conversations = [];
    let activeConversationId = null;

    async function loadConversations() {
      showLoading(true);
      const result = await api('/api/admin/messages');
      showLoading(false);
      
      if (result?.conversations) {
        conversations = result.conversations;
        renderConversations();
        updateMessagesBadge();
      }
    }

    function updateMessagesBadge() {
      const totalUnread = conversations.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
      const badge = document.getElementById('messagesBadge');
      document.getElementById('unreadMessagesCount').textContent = totalUnread;
      document.getElementById('activeConversationsCount').textContent = conversations.length;
      
      if (totalUnread > 0) {
        badge.textContent = totalUnread;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderConversations() {
      const container = document.getElementById('conversationsList');
      
      if (!conversations || conversations.length === 0) {
        container.innerHTML = '<p class="no-items-message" style="text-align: center; color: var(--soft-gray); padding: 30px;">No messages yet. Clients can message you from their portal.</p>';
        return;
      }
      
      container.innerHTML = conversations.map(conv => {
        const lastMsg = conv.lastMessage;
        const lastMsgPreview = lastMsg?.message?.substring(0, 50) + (lastMsg?.message?.length > 50 ? '...' : '');
        const isActive = activeConversationId === conv.conversationId;
        
        return `
          <div class="conversation-item ${isActive ? 'active' : ''}" onclick="selectConversation('${encodeURIComponent(conv.conversationId)}')" style="padding: 12px; border-bottom: 1px solid #e0d6cc; cursor: pointer; background: ${isActive ? 'var(--cream-dark)' : 'transparent'}; ${conv.unreadCount > 0 ? 'border-left: 3px solid var(--gold);' : ''}">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
              <strong style="color: var(--charcoal);">${conv.clientName}</strong>
              ${conv.unreadCount > 0 ? `<span class="badge" style="background: var(--gold); color: white; font-size: 11px;">${conv.unreadCount}</span>` : ''}
            </div>
            <div style="font-size: 12px; color: var(--soft-gray);">${conv.clientEmail}</div>
            ${lastMsg ? `
              <div style="font-size: 13px; color: var(--charcoal); margin-top: 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${lastMsg.from === 'client' ? '' : 'â†©ï¸ '} ${lastMsgPreview}
              </div>
              <div style="font-size: 11px; color: var(--soft-gray); margin-top: 4px;">
                ${formatDate(lastMsg.createdAt)}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function selectConversation(conversationIdEncoded) {
      const conversationId = decodeURIComponent(conversationIdEncoded);
      activeConversationId = conversationId;
      
      // Update UI to show active
      renderConversations();
      
      // Load messages
      showLoading(true);
      const result = await api(`/api/admin/messages/${conversationIdEncoded}`);
      showLoading(false);
      
      if (result?.messages) {
        renderConversationMessages(result.messages, conversationId);
        document.getElementById('replyForm').style.display = 'block';
        // Update badge since messages are now read
        loadConversations();
      }
    }

    function renderConversationMessages(messages, conversationId) {
      const conv = conversations.find(c => c.conversationId === conversationId);
      const container = document.getElementById('conversationMessages');
      const header = document.getElementById('conversationHeader');
      
      header.innerHTML = `<h3 class="card-title">ðŸ’¬ ${conv?.clientName || 'Client'} <span style="font-weight: normal; font-size: 13px; color: var(--soft-gray);">(${conversationId})</span></h3>`;
      
      if (!messages || messages.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--soft-gray);">No messages in this conversation</p>';
        return;
      }
      
      container.innerHTML = messages.map(msg => `
        <div style="display: flex; flex-direction: column; align-items: ${msg.from === 'client' ? 'flex-start' : 'flex-end'}; margin-bottom: 12px;">
          <div style="background: ${msg.from === 'client' ? '#f8f5f0' : 'var(--burgundy)'}; color: ${msg.from === 'client' ? 'var(--charcoal)' : 'white'}; padding: 12px 16px; border-radius: 12px; max-width: 80%; ${msg.from === 'client' ? 'border-bottom-left-radius: 4px;' : 'border-bottom-right-radius: 4px;'}">
            <div style="font-size: 12px; font-weight: 600; margin-bottom: 4px;">${msg.from === 'client' ? (msg.fromName || 'Client') : 'ðŸª· You'}</div>
            <div style="white-space: pre-wrap;">${escapeHtml(msg.message)}</div>
            <div style="font-size: 11px; opacity: 0.7; margin-top: 6px;">${formatDateTime(msg.createdAt)}</div>
          </div>
        </div>
      `).join('');
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }

    async function sendReply() {
      if (!activeConversationId) return;
      
      const input = document.getElementById('replyInput');
      const message = input.value.trim();
      const sendEmail = document.getElementById('sendEmailNotification').checked;
      
      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }
      
      showLoading(true);
      const result = await api(`/api/admin/messages/${encodeURIComponent(activeConversationId)}/reply`, {
        method: 'POST',
        body: JSON.stringify({ message, sendEmail })
      });
      showLoading(false);
      
      if (result?.success) {
        input.value = '';
        showToast('Reply sent!', 'success');
        selectConversation(encodeURIComponent(activeConversationId));
      } else {
        showToast(result?.error || 'Failed to send reply', 'error');
      }
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===========================================
    // CONTENT MANAGEMENT
    // ===========================================
    async function loadContent() {
      showLoading(true);
      content = await api('/api/admin/content') || {};
      showLoading(false);
      renderContent();
      loadPendingTestimonials();
    }

    async function loadPendingTestimonials() {
      const pending = await api('/api/admin/testimonials/pending') || [];
      const badge = document.getElementById('pendingBadge');
      if (pending.length > 0) {
        badge.textContent = pending.length;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
      renderPendingTestimonials(pending);
    }

    function renderPendingTestimonials(pending) {
      const container = document.getElementById('pendingTestimonialsList');
      if (!pending || pending.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--soft-gray); padding: 40px;">No pending testimonials</p>';
        return;
      }

      container.innerHTML = pending.map(t => `
        <div class="content-item" style="border-left: 4px solid var(--gold);">
          <div class="content-item-header">
            <h4>${t.displayName}</h4>
            <div class="content-item-actions">
              <span style="color: var(--soft-gray); font-size: 12px;">${new Date(t.submittedAt).toLocaleDateString()}</span>
              <button class="btn btn-sm btn-primary" onclick="reviewPendingTestimonial('${t.id}')">Review</button>
            </div>
          </div>
          <p style="font-style: italic;">"${t.text.substring(0, 200)}${t.text.length > 200 ? '...' : ''}"</p>
          ${t.email ? `<p style="font-size: 12px; color: var(--soft-gray);">ðŸ“§ ${t.email}</p>` : ''}
        </div>
      `).join('');
    }

    function reviewPendingTestimonial(id) {
      const pending = content.pendingTestimonials?.find(t => t.id === id);
      if (!pending) {
        // Reload and try again
        loadPendingTestimonials();
        return;
      }
      document.getElementById('pendingTestimonialId').value = id;
      document.getElementById('pendingTestimonialAuthor').textContent = pending.displayName;
      document.getElementById('pendingTestimonialMeta').innerHTML = `
        ${pending.email ? `ðŸ“§ ${pending.email}<br>` : ''}
        ${pending.sessionType ? `Session: ${pending.sessionType}<br>` : ''}
        Submitted: ${new Date(pending.submittedAt).toLocaleString()}
        ${pending.featured ? '<br>â­ Willing to be featured' : ''}
      `;
      document.getElementById('pendingTestimonialText').textContent = pending.text;
      openModal('pendingTestimonialModal');
    }

    async function approvePendingTestimonial() {
      const id = document.getElementById('pendingTestimonialId').value;
      showLoading(true);
      const result = await api(`/api/admin/testimonials/${id}/approve`, { method: 'POST' });
      showLoading(false);
      if (result?.success) {
        showToast('Testimonial approved and published!', 'success');
        closeModal('pendingTestimonialModal');
        loadContent();
      } else {
        showToast('Failed to approve testimonial', 'error');
      }
    }

    async function rejectPendingTestimonial() {
      const id = document.getElementById('pendingTestimonialId').value;
      if (!confirm('Are you sure you want to reject this testimonial?')) return;
      
      showLoading(true);
      const result = await api(`/api/admin/testimonials/${id}/reject`, { method: 'POST' });
      showLoading(false);
      if (result?.success) {
        showToast('Testimonial rejected', 'info');
        closeModal('pendingTestimonialModal');
        loadContent();
      } else {
        showToast('Failed to reject testimonial', 'error');
      }
    }

    function renderContent() {
      // Testimonials
      document.getElementById('testimonialsList').innerHTML = content.testimonials?.length ? 
        content.testimonials.map(t => `
          <div class="content-item ${t.active ? '' : 'inactive'}">
            <div class="content-item-header">
              <h4>${t.author} ${t.featured ? 'â­' : ''}</h4>
              <div class="content-item-actions">
                <button class="action-btn" onclick="editTestimonial('${t.id}')">Edit</button>
                <button class="action-btn" onclick="toggleTestimonial('${t.id}', ${!t.active})">${t.active ? 'Hide' : 'Show'}</button>
                <button class="action-btn" onclick="deleteTestimonial('${t.id}')" style="color: var(--danger);">Delete</button>
              </div>
            </div>
            <p>${t.text.substring(0, 200)}${t.text.length > 200 ? '...' : ''}</p>
          </div>
        `).join('') : '<div class="empty-state">No testimonials</div>';

      // Store pending for review modal
      content.pendingTestimonials = content.pendingTestimonials || [];

      // FAQs
      document.getElementById('faqsList').innerHTML = content.faqs?.length ?
        content.faqs.sort((a, b) => a.order - b.order).map(f => `
          <div class="content-item ${f.active ? '' : 'inactive'}">
            <div class="content-item-header">
              <h4>${f.question}</h4>
              <div class="content-item-actions">
                <button class="action-btn" onclick="editFaq('${f.id}')">Edit</button>
                <button class="action-btn" onclick="toggleFaq('${f.id}', ${!f.active})">${f.active ? 'Hide' : 'Show'}</button>
                <button class="action-btn" onclick="deleteFaq('${f.id}')" style="color: var(--danger);">Delete</button>
              </div>
            </div>
            <p>${f.answer.substring(0, 150)}${f.answer.length > 150 ? '...' : ''}</p>
          </div>
        `).join('') : '<div class="empty-state">No FAQs</div>';

      // Site settings
      if (content.siteSettings) {
        document.getElementById('siteName').value = content.siteSettings.siteName || '';
        document.getElementById('siteTagline').value = content.siteSettings.tagline || '';
        document.getElementById('siteEmail').value = content.siteSettings.email || '';
        document.getElementById('siteLocation').value = content.siteSettings.location || '';
        document.getElementById('maintenanceMode').checked = content.siteSettings.maintenanceMode || false;
      }
    }

    // Testimonials
    function openTestimonialModal(id = null) {
      document.getElementById('testimonialId').value = id || '';
      document.getElementById('testimonialModalTitle').textContent = id ? 'Edit Testimonial' : 'Add Testimonial';
      
      if (id) {
        const t = content.testimonials.find(x => x.id === id);
        document.getElementById('testimonialAuthor').value = t.author;
        document.getElementById('testimonialText').value = t.text;
        document.getElementById('testimonialFeatured').checked = t.featured;
      } else {
        document.getElementById('testimonialForm').reset();
      }
      
      openModal('testimonialModal');
    }

    function editTestimonial(id) { openTestimonialModal(id); }

    async function saveTestimonial() {
      const id = document.getElementById('testimonialId').value;
      const author = document.getElementById('testimonialAuthor').value;
      const text = document.getElementById('testimonialText').value;
      const featured = document.getElementById('testimonialFeatured').checked;

      showLoading(true);
      const result = id ?
        await api(`/api/admin/testimonials/${id}`, { method: 'PATCH', body: JSON.stringify({ author, text, featured }) }) :
        await api('/api/admin/testimonials', { method: 'POST', body: JSON.stringify({ author, text, featured }) });
      showLoading(false);

      if (result?.success) {
        showToast('Testimonial saved!', 'success');
        closeModal('testimonialModal');
        loadContent();
      }
    }

    async function toggleTestimonial(id, active) {
      await api(`/api/admin/testimonials/${id}`, { method: 'PATCH', body: JSON.stringify({ active }) });
      loadContent();
    }

    async function deleteTestimonial(id) {
      if (!confirm('Delete this testimonial?')) return;
      await api(`/api/admin/testimonials/${id}`, { method: 'DELETE' });
      showToast('Testimonial deleted', 'success');
      loadContent();
    }

    // FAQs
    function openFaqModal(id = null) {
      document.getElementById('faqId').value = id || '';
      document.getElementById('faqModalTitle').textContent = id ? 'Edit FAQ' : 'Add FAQ';
      
      if (id) {
        const f = content.faqs.find(x => x.id === id);
        document.getElementById('faqQuestion').value = f.question;
        document.getElementById('faqAnswer').value = f.answer;
      } else {
        document.getElementById('faqForm').reset();
      }
      
      openModal('faqModal');
    }

    function editFaq(id) { openFaqModal(id); }

    async function saveFaq() {
      const id = document.getElementById('faqId').value;
      const question = document.getElementById('faqQuestion').value;
      const answer = document.getElementById('faqAnswer').value;

      showLoading(true);
      const result = id ?
        await api(`/api/admin/faqs/${id}`, { method: 'PATCH', body: JSON.stringify({ question, answer }) }) :
        await api('/api/admin/faqs', { method: 'POST', body: JSON.stringify({ question, answer }) });
      showLoading(false);

      if (result?.success) {
        showToast('FAQ saved!', 'success');
        closeModal('faqModal');
        loadContent();
      }
    }

    async function toggleFaq(id, active) {
      await api(`/api/admin/faqs/${id}`, { method: 'PATCH', body: JSON.stringify({ active }) });
      loadContent();
    }

    async function deleteFaq(id) {
      if (!confirm('Delete this FAQ?')) return;
      await api(`/api/admin/faqs/${id}`, { method: 'DELETE' });
      showToast('FAQ deleted', 'success');
      loadContent();
    }

    // Site settings form
    document.getElementById('siteSettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const siteSettings = {
        siteName: document.getElementById('siteName').value,
        tagline: document.getElementById('siteTagline').value,
        email: document.getElementById('siteEmail').value,
        location: document.getElementById('siteLocation').value,
        maintenanceMode: document.getElementById('maintenanceMode').checked
      };

      showLoading(true);
      const result = await api('/api/admin/content', {
        method: 'PUT',
        body: JSON.stringify({ siteSettings })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Settings saved!', 'success');
      }
    });

    // ===========================================
    // SETTINGS
    // ===========================================
    async function loadSettings() {
      showLoading(true);
      settings = await api('/api/admin/settings') || {};
      showLoading(false);
      renderSettings();
    }

    function renderSettings() {
      // Services
      document.getElementById('servicesList').innerHTML = settings.services?.map((s, index) => `
        <div class="content-item ${s.active ? '' : 'inactive'}">
          <div class="content-item-header">
            <h4>${s.name}</h4>
            <div class="content-item-actions">
              <button class="action-btn" onclick="editService(${index})" title="Edit">âœï¸</button>
              <button class="action-btn" onclick="toggleServiceActive(${index})" title="${s.active ? 'Hide' : 'Show'}">${s.active ? 'ðŸ‘ï¸' : 'ðŸ‘ï¸â€ðŸ—¨ï¸'}</button>
              <button class="action-btn" onclick="deleteService(${index})" title="Delete" style="color: #dc3545;">ðŸ—‘ï¸</button>
            </div>
          </div>
          <p style="margin-bottom: 8px;">${s.description || ''}</p>
          <div style="display: flex; gap: 16px; font-size: 14px; color: var(--soft-gray);">
            <span style="font-weight: 600; color: var(--burgundy);">$${s.price}</span>
            <span>${s.duration} min</span>
          </div>
        </div>
      `).join('') || '<p>No services configured</p>';

      // Render Calendly-style availability interface
      renderWeeklyAvailability();

      // Blocked dates
      document.getElementById('blockedDatesList').innerHTML = settings.blockedDates?.length ?
        settings.blockedDates.map((b, index) => {
          const formatDateTime = (date, time) => {
            const dateStr = new Date(date).toLocaleDateString();
            return time ? `${dateStr} ${time}` : dateStr;
          };
          
          const isRange = b.startDate && b.endDate && (b.startDate !== b.endDate || b.startTime || b.endTime);
          const displayText = isRange 
            ? `${formatDateTime(b.startDate, b.startTime)} â†’ ${formatDateTime(b.endDate, b.endTime)}`
            : formatDateTime(b.date || b.startDate, b.startTime);
          
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px;">
              <div>
                <strong>${displayText}</strong>
                ${b.reason ? `<span style="color: var(--soft-gray);"> - ${b.reason}</span>` : ''}
                ${isRange ? '<span style="color: var(--burgundy); font-size: 12px; margin-left: 8px;">ðŸ“… RANGE</span>' : ''}
              </div>
              <button class="action-btn" onclick="unblockDate(${index})" style="color: var(--danger);">Remove</button>
            </div>
          `;
        }).join('') : '<p style="color: var(--soft-gray);">No blocked dates</p>';

      // Email settings
      document.getElementById('emailNotifications').checked = settings.emailNotifications !== false;
      document.getElementById('autoConfirmationEmail').checked = settings.autoConfirmationEmail !== false;
      document.getElementById('reminderEmails').checked = settings.reminderEmails !== false;
      document.getElementById('reminderHours').value = settings.reminderHours || 24;
    }

    // OLD AVAILABILITY FORM (replaced by Calendly-style interface)
    // Keeping for reference - can be removed after testing
    /*
    document.getElementById('availabilityForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const availableDays = Array.from(document.querySelectorAll('input[name="availableDay"]:checked')).map(c => c.value);
      const availableSlots = document.getElementById('availableSlots').value.split('\n').filter(s => s.trim());

      showLoading(true);
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify({ availableDays, availableSlots })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Availability saved!', 'success');
        settings = result.settings;
      }
    });
    */

    // Email settings form
    document.getElementById('emailSettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const emailNotifications = document.getElementById('emailNotifications').checked;
      const autoConfirmationEmail = document.getElementById('autoConfirmationEmail').checked;
      const reminderEmails = document.getElementById('reminderEmails').checked;
      const reminderHours = parseInt(document.getElementById('reminderHours').value);

      showLoading(true);
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify({ emailNotifications, autoConfirmationEmail, reminderEmails, reminderHours })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Email settings saved!', 'success');
      }
    });

    function openBlockDateModal() {
      document.getElementById('blockStartDate').value = '';
      document.getElementById('blockStartTime').value = '';
      document.getElementById('blockEndDate').value = '';
      document.getElementById('blockEndTime').value = '';
      document.getElementById('blockReason').value = '';
      openModal('blockDateModal');
    }

    async function saveBlockedDate() {
      const startDate = document.getElementById('blockStartDate').value;
      const startTime = document.getElementById('blockStartTime').value;
      const endDate = document.getElementById('blockEndDate').value;
      const endTime = document.getElementById('blockEndTime').value;
      const reason = document.getElementById('blockReason').value;
      
      if (!startDate || !endDate) {
        showToast('Please enter start and end dates', 'error');
        return;
      }

      // Validate date range
      if (new Date(endDate) < new Date(startDate)) {
        showToast('End date must be after start date', 'error');
        return;
      }

      const blockData = {
        startDate,
        startTime: startTime || null,
        endDate,
        endTime: endTime || null,
        reason: reason || null,
        isRange: startDate !== endDate || startTime || endTime
      };

      showLoading(true);
      const result = await api('/api/admin/settings/block-date', {
        method: 'POST',
        body: JSON.stringify(blockData)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Date range blocked!', 'success');
        closeModal('blockDateModal');
        settings.blockedDates = result.blockedDates;
        renderSettings();
      }
    }

    async function unblockDate(index) {
      if (!confirm('Remove this blocked date/time range?')) return;
      
      showLoading(true);
      const result = await api(`/api/admin/settings/block-date/${index}`, { method: 'DELETE' });
      showLoading(false);

      if (result?.success) {
        showToast('Date unblocked!', 'success');
        settings.blockedDates = result.blockedDates;
        renderSettings();
      }
    }

    // ===========================================
    // CALENDLY-STYLE AVAILABILITY
    // ===========================================
    function renderWeeklyAvailability() {
      const container = document.getElementById('weeklyAvailability');
      if (!container) return;

      const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
      const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      
      // Get current availability data or initialize
      if (!settings.weeklyAvailability) {
        settings.weeklyAvailability = {};
        dayKeys.forEach(key => {
          settings.weeklyAvailability[key] = {
            enabled: settings.availableDays?.includes(key) || false,
            slots: []
          };
        });
      }

      // Generate time slots (9am - 6pm in 30min intervals by default)
      const generateTimeSlots = (startHour = 9, endHour = 18, interval = 30) => {
        const slots = [];
        for (let hour = startHour; hour < endHour; hour++) {
          for (let min = 0; min < 60; min += interval) {
            const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
            slots.push(timeStr);
          }
        }
        return slots;
      };

      const allTimeSlots = generateTimeSlots();

      container.innerHTML = `
        <div class="slot-duration-selector">
          <label>Time Slot Interval:</label>
          <label><input type="radio" name="slotInterval" value="15" ${settings.slotInterval === 15 ? 'checked' : ''}> 15 min</label>
          <label><input type="radio" name="slotInterval" value="30" ${!settings.slotInterval || settings.slotInterval === 30 ? 'checked' : ''}> 30 min</label>
          <label><input type="radio" name="slotInterval" value="60" ${settings.slotInterval === 60 ? 'checked' : ''}> 60 min</label>
          <label><input type="radio" name="slotInterval" value="90" ${settings.slotInterval === 90 ? 'checked' : ''}> 90 min</label>
          <label><input type="radio" name="slotInterval" value="120" ${settings.slotInterval === 120 ? 'checked' : ''}> 2 hours</label>
        </div>
        <div class="weekly-availability-container">
          ${days.map((day, index) => {
            const dayKey = dayKeys[index];
            const dayData = settings.weeklyAvailability[dayKey] || { enabled: false, slots: [] };
            
            return `
              <div class="availability-day-card ${!dayData.enabled ? 'disabled' : ''}">
                <div class="day-header">
                  <span class="day-name">${day}</span>
                  <label class="day-toggle">
                    <input type="checkbox" ${dayData.enabled ? 'checked' : ''} 
                           onchange="toggleDay('${dayKey}', this.checked)">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                ${dayData.enabled ? `
                  <div class="time-slots-container" id="slots-${dayKey}">
                    ${allTimeSlots.map(slot => `
                      <button class="time-slot-btn ${dayData.slots.includes(slot) ? 'selected' : ''}"
                              onclick="toggleTimeSlot('${dayKey}', '${slot}')">
                        ${formatTime(slot)}
                      </button>
                    `).join('')}
                  </div>
                ` : '<p style="color: var(--soft-gray); margin-top: 12px; font-style: italic;">Day is disabled</p>'}
              </div>
            `;
          }).join('')}
        </div>
        <div class="availability-summary">
          <strong>Quick Actions:</strong><br>
          <button class="btn btn-secondary" onclick="selectBusinessHours()" style="margin-top: 8px; padding: 8px 16px;">
            Select Business Hours (9am-5pm)
          </button>
          <button class="btn btn-secondary" onclick="clearAllSlots()" style="margin-top: 8px; padding: 8px 16px; margin-left: 8px;">
            Clear All
          </button>
        </div>
        <div class="availability-actions">
          <button class="btn btn-primary" onclick="saveAvailability()">ðŸ’¾ Save Availability</button>
          <button class="btn btn-secondary" onclick="renderWeeklyAvailability()">â†» Reset Changes</button>
        </div>
      `;

      // Add interval change listener
      document.querySelectorAll('input[name="slotInterval"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          settings.slotInterval = parseInt(e.target.value);
          renderWeeklyAvailability();
        });
      });
    }

    function formatTime(time24) {
      const [hours, minutes] = time24.split(':').map(Number);
      const period = hours >= 12 ? 'PM' : 'AM';
      const hours12 = hours % 12 || 12;
      return `${hours12}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function toggleDay(dayKey, enabled) {
      if (!settings.weeklyAvailability) settings.weeklyAvailability = {};
      if (!settings.weeklyAvailability[dayKey]) settings.weeklyAvailability[dayKey] = { enabled: false, slots: [] };
      settings.weeklyAvailability[dayKey].enabled = enabled;
      renderWeeklyAvailability();
    }

    function toggleTimeSlot(dayKey, slot) {
      if (!settings.weeklyAvailability[dayKey].slots) settings.weeklyAvailability[dayKey].slots = [];
      const slots = settings.weeklyAvailability[dayKey].slots;
      const index = slots.indexOf(slot);
      
      if (index > -1) {
        slots.splice(index, 1);
      } else {
        slots.push(slot);
        slots.sort();
      }
      
      // Update button visual
      const btn = event.target;
      btn.classList.toggle('selected');
    }

    function selectBusinessHours() {
      const businessDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
      const businessHours = [];
      
      // Generate 9am-5pm slots
      for (let hour = 9; hour < 17; hour++) {
        const interval = settings.slotInterval || 30;
        for (let min = 0; min < 60; min += interval) {
          businessHours.push(`${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`);
        }
      }
      
      businessDays.forEach(day => {
        if (!settings.weeklyAvailability[day]) settings.weeklyAvailability[day] = { enabled: false, slots: [] };
        settings.weeklyAvailability[day].enabled = true;
        settings.weeklyAvailability[day].slots = [...businessHours];
      });
      
      renderWeeklyAvailability();
      showToast('Business hours selected (Mon-Fri, 9am-5pm)', 'success');
    }

    function clearAllSlots() {
      if (!confirm('Clear all availability? This will disable all days and remove all time slots.')) return;
      
      const dayKeys = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      dayKeys.forEach(day => {
        if (!settings.weeklyAvailability[day]) settings.weeklyAvailability[day] = { enabled: false, slots: [] };
        settings.weeklyAvailability[day].enabled = false;
        settings.weeklyAvailability[day].slots = [];
      });
      
      renderWeeklyAvailability();
      showToast('All availability cleared', 'info');
    }

    async function saveAvailability() {
      showLoading(true);
      
      // Convert new format to legacy format for backward compatibility
      const availableDays = [];
      const availableSlots = [];
      
      Object.keys(settings.weeklyAvailability).forEach(day => {
        const dayData = settings.weeklyAvailability[day];
        if (dayData.enabled) {
          availableDays.push(day);
          // Convert time slots to readable format for legacy field
          dayData.slots.forEach(slot => {
            const formatted = `${day.charAt(0).toUpperCase() + day.slice(1)} ${formatTime(slot)}`;
            if (!availableSlots.includes(formatted)) {
              availableSlots.push(formatted);
            }
          });
        }
      });
      
      settings.availableDays = availableDays;
      settings.availableSlots = availableSlots;
      
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify(settings)
      });
      
      showLoading(false);

      if (result?.success) {
        showToast('Availability saved successfully!', 'success');
        settings = result.settings;
      } else {
        showToast('Failed to save availability', 'error');
      }
    }

    // ===========================================
    // SERVICE MANAGEMENT
    // ===========================================
    function editService(index) {
      const service = settings.services[index];
      const newName = prompt('Service Name:', service.name);
      if (newName === null) return;
      
      const newPrice = prompt('Price ($):', service.price);
      if (newPrice === null) return;
      
      const newDuration = prompt('Duration (minutes):', service.duration);
      if (newDuration === null) return;
      
      const newDescription = prompt('Description (optional):', service.description || '');
      if (newDescription === null) return;
      
      settings.services[index] = {
        ...service,
        name: newName.trim(),
        price: parseInt(newPrice),
        duration: parseInt(newDuration),
        description: newDescription.trim()
      };
      
      saveSettings();
    }

    async function toggleServiceActive(index) {
      settings.services[index].active = !settings.services[index].active;
      await saveSettings();
    }

    async function deleteService(index) {
      const service = settings.services[index];
      if (!confirm(`Delete "${service.name}"? This cannot be undone.`)) return;
      
      settings.services.splice(index, 1);
      await saveSettings();
    }

    async function saveSettings() {
      showLoading(true);
      const result = await api('/api/admin/settings', {
        method: 'PUT',
        body: JSON.stringify(settings)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Settings saved!', 'success');
        settings = result.settings;
        renderSettings();
      } else {
        showToast('Failed to save settings', 'error');
      }
    }

    // ===========================================
    // MARKETING AUTOMATION
    // ===========================================
    let campaigns = [];
    let segments = [];
    let workflows = [];
    let templates = [];
    let marketingAnalytics = {};

    async function loadMarketing() {
      await Promise.all([
        loadLeads(),
        loadLeadMagnets(),
        loadDripCampaigns(),
        loadCampaigns(),
        loadSegments(),
        loadWorkflows(),
        loadTemplates(),
        loadMarketingAnalytics()
      ]);
    }

    // ============ LEADS MANAGEMENT ============
    let leads = [];
    let leadMagnets = [];
    let dripCampaigns = [];

    async function loadLeads() {
      const result = await api('/api/admin/leads');
      if (result?.leads) {
        leads = result.leads;
        renderLeadFunnel();
        renderLeadsList();
      }
    }

    function renderLeadFunnel() {
      const visitors = leads.filter(l => l.stage === 'visitor').length || Math.floor(leads.length * 3); // Estimate
      const leadsCount = leads.filter(l => l.stage === 'lead').length;
      const prospects = leads.filter(l => l.stage === 'prospect').length;
      const clients = leads.filter(l => l.stage === 'client').length;

      document.getElementById('visitorCount').textContent = visitors;
      document.getElementById('leadCount').textContent = leadsCount;
      document.getElementById('prospectCount').textContent = prospects;
      document.getElementById('clientCount').textContent = clients;

      // Calculate conversion rates
      const visitorLeadRate = visitors ? ((leadsCount / visitors) * 100).toFixed(1) : 0;
      const leadProspectRate = leadsCount ? ((prospects / leadsCount) * 100).toFixed(1) : 0;
      const prospectClientRate = prospects ? ((clients / prospects) * 100).toFixed(1) : 0;

      document.getElementById('visitorLeadRate').textContent = visitorLeadRate + '%';
      document.getElementById('leadProspectRate').textContent = leadProspectRate + '%';
      document.getElementById('prospectClientRate').textContent = prospectClientRate + '%';

      // Update funnel bar widths
      if (visitors > 0) {
        document.getElementById('leadBar').style.width = visitorLeadRate + '%';
        document.getElementById('prospectBar').style.width = (visitorLeadRate * leadProspectRate / 100) + '%';
        document.getElementById('clientBar').style.width = (visitorLeadRate * leadProspectRate * prospectClientRate / 10000) + '%';
      }
    }

    function renderLeadsList(filter = 'all') {
      const list = document.getElementById('leadsList');
      let filtered = leads;

      if (filter !== 'all') {
        filtered = leads.filter(l => l.status === filter);
      }

      if (filtered.length === 0) {
        list.innerHTML = '<p class=\"no-items-message\">No leads match this filter.</p>';
        return;
      }

      list.innerHTML = filtered.map(lead => `
        <div class=\"lead-item\">
          <div class=\"lead-info\">
            <div class=\"lead-name\">${lead.name}</div>
            <div class=\"lead-email\">${lead.email}</div>
            <div class=\"lead-source\">ðŸ§² Source: ${lead.source || 'Direct'}</div>
          </div>
          <div>
            <span class=\"lead-status ${lead.status}\">${lead.status}</span>
            <button class=\"btn btn-sm\" onclick=\"followUpLead('${lead.id}')\" style=\"margin-left: 10px;\">Follow Up</button>
          </div>
        </div>
      `).join('');

      // Setup filter chips
      document.querySelectorAll('.filter-chips .chip').forEach(chip => {
        chip.onclick = () => {
          document.querySelectorAll('.filter-chips .chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          renderLeadsList(chip.dataset.filter);
        };
      });
    }

    async function followUpLead(leadId) {
      const lead = leads.find(l => l.id === leadId);
      if (!lead) return;

      const message = `Follow up with ${lead.name} (${lead.email})\\n\\nAI Suggested Email:\\n\\nHi ${lead.name.split(' ')[0]},\\n\\nI hope this message finds you in peace and wellness. I wanted to personally reach out to see how you're doing and if you have any questions about our sacred healing services.\\n\\nWould you like to schedule a complimentary 15-minute consultation to discuss how we can support your healing journey?\\n\\nWith light and love,\\nRavi`;

      if (confirm(message + '\\n\\nSend this follow-up email?')) {
        const result = await api('/api/admin/leads/follow-up', {
          method: 'POST',
          body: JSON.stringify({ leadId, template: 'ai_followup' })
        });

        if (result?.success) {
          showNotification('âœ… Follow-up email sent successfully!', 'success');
          lead.status = 'contacted';
          renderLeadsList();
        }
      }
    }

    // ============ LEAD MAGNETS ============
    async function loadLeadMagnets() {
      const result = await api('/api/admin/lead-magnets');
      if (result?.magnets) {
        leadMagnets = result.magnets;
        renderLeadMagnets();
      }
    }

    function renderLeadMagnets() {
      const grid = document.getElementById('leadMagnetGrid');
      
      if (leadMagnets.length === 0) {
        grid.innerHTML = '<p class=\"no-items-message\">No lead magnets yet. Create your first lead capture offer!</p>';
        return;
      }

      grid.innerHTML = leadMagnets.map(magnet => `
        <div class=\"lead-magnet-card\">
          <div class=\"magnet-header\">
            <div>
              <h4 class=\"magnet-title\">${magnet.title}</h4>
              <span class=\"magnet-type\">${magnet.type}</span>
            </div>
            <button class=\"btn btn-sm\" onclick=\"editLeadMagnet('${magnet.id}')\">Edit</button>
          </div>
          <p style=\"color: var(--soft-gray); font-size: 14px; margin: 10px 0;\">${magnet.description}</p>
          <div class=\"magnet-stats\">
            <div class=\"magnet-stat\">
              <div class=\"magnet-stat-value\">${magnet.stats?.views || 0}</div>
              <div class=\"magnet-stat-label\">Views</div>
            </div>
            <div class=\"magnet-stat\">
              <div class=\"magnet-stat-value\">${magnet.stats?.conversions || 0}</div>
              <div class=\"magnet-stat-label\">Conversions</div>
            </div>
            <div class=\"magnet-stat\">
              <div class=\"magnet-stat-value\">${magnet.stats?.views ? ((magnet.stats.conversions / magnet.stats.views) * 100).toFixed(1) : 0}%</div>
              <div class=\"magnet-stat-label\">Conv. Rate</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function showLeadMagnetBuilder() {
      const types = ['Free Guide', 'Assessment', 'Free Consultation', 'Healing Resource', 'Mini Course', 'Checklist'];
      
      const typeOptions = types.map(t => `<option value=\"${t}\">${t}</option>`).join('');

      showModal(`
        <h3>Create Lead Magnet (AI-Powered)</h3>
        <div class=\"form-group\">
          <label>Type</label>
          <select id=\"magnetType\" class=\"form-control\">
            ${typeOptions}
          </select>
        </div>
        <div class=\"form-group\">
          <label>Title</label>
          <input type=\"text\" id=\"magnetTitle\" class=\"form-control\" placeholder=\"e.g., 7-Day Chakra Healing Guide\">
        </div>
        <div class=\"form-group\">
          <label>Description</label>
          <textarea id=\"magnetDesc\" class=\"form-control\" rows=\"3\" placeholder=\"What value does this offer?\"></textarea>
        </div>
        <div class=\"form-group\">
          <label>AI Content Generation</label>
          <button class=\"btn btn-secondary\" onclick=\"generateLeadMagnetContent()\" style=\"width: 100%;\">ðŸ¤– Generate Content with AI</button>
          <small style=\"color: var(--soft-gray); display: block; margin-top: 5px;\">AI will create compelling copy and content for your lead magnet</small>
        </div>
        <div id=\"aiGeneratedContent\" style=\"display: none; margin-top: 15px; padding: 15px; background: var(--background); border-radius: 8px;\"></div>
        <div class=\"btn-group\">
          <button class=\"btn btn-secondary\" onclick=\"closeModal()\">Cancel</button>
          <button class=\"btn btn-primary\" onclick=\"saveLeadMagnet()\">Create Lead Magnet</button>
        </div>
      `);
    }

    async function generateLeadMagnetContent() {
      const type = document.getElementById('magnetType').value;
      const title = document.getElementById('magnetTitle').value;
      const desc = document.getElementById('magnetDesc').value;

      if (!title) {
        showNotification('Please enter a title first', 'error');
        return;
      }

      const contentDiv = document.getElementById('aiGeneratedContent');
      contentDiv.style.display = 'block';
      contentDiv.innerHTML = '<p>ðŸ¤– AI is generating your content...</p>';

      // Simulate AI generation (in production, call OpenAI API)
      setTimeout(() => {
        const aiContent = {
          headline: `Unlock ${title}: Your Journey to Sacred Healing Begins Here`,
          subheadline: `Discover ancient wisdom and modern techniques to transform your spiritual wellness`,
          benefits: [
            'Immediate access to transformative healing practices',
            'Step-by-step guidance from Ravi\'s 20+ years of experience',
            'Lifetime access to exclusive healing resources',
            'Join a community of conscious seekers'
          ],
          cta: 'Get Instant Access',
          formText: 'Enter your email to receive your free ' + type.toLowerCase(),
          emailSubject: `Your ${title} is Ready! ðŸª·`,
          emailBody: `Namaste,\n\nThank you for your interest in ${title}. Your healing journey is sacred, and I'm honored to guide you.\n\nInside, you'll discover...\n${desc}\n\nMay this resource bring light to your path.\n\nWith love and blessings,\nRavi`
        };

        contentDiv.innerHTML = `
          <h4 style="color: var(--burgundy); margin-bottom: 10px;">âœ¨ AI-Generated Content</h4>
          <p><strong>Headline:</strong> ${aiContent.headline}</p>
          <p><strong>Subheadline:</strong> ${aiContent.subheadline}</p>
          <p><strong>Benefits:</strong></p>
          <ul>
            ${aiContent.benefits.map(b => `<li>${b}</li>`).join('')}
          </ul>
          <p><strong>CTA Button:</strong> ${aiContent.cta}</p>
          <p><strong>Form Text:</strong> ${aiContent.formText}</p>
          <hr>
          <p><strong>Welcome Email Subject:</strong> ${aiContent.emailSubject}</p>
          <p><strong>Email Body:</strong></p>
          <pre style=\"white-space: pre-wrap; font-size: 13px;\">${aiContent.emailBody}</pre>
        `;

        window.generatedContent = aiContent;
      }, 2000);
    }

    async function saveLeadMagnet() {
      const magnet = {
        id: Date.now().toString(),
        type: document.getElementById('magnetType').value,
        title: document.getElementById('magnetTitle').value,
        description: document.getElementById('magnetDesc').value,
        aiContent: window.generatedContent || null,
        status: 'active',
        createdAt: new Date().toISOString(),
        stats: { views: 0, conversions: 0 }
      };

      const result = await api('/api/admin/lead-magnets', {
        method: 'POST',
        body: JSON.stringify(magnet)
      });

      if (result?.success) {
        showNotification('âœ… Lead magnet created successfully!', 'success');
        closeModal();
        loadLeadMagnets();
      }
    }

    // ============ DRIP CAMPAIGNS ============
    async function loadDripCampaigns() {
      const result = await api('/api/admin/drip-campaigns');
      if (result?.campaigns) {
        dripCampaigns = result.campaigns;
        renderDripCampaigns();
      }
    }

    function renderDripCampaigns() {
      const list = document.getElementById('dripCampaignsList');
      
      if (dripCampaigns.length === 0) {
        list.innerHTML = '<p class=\"no-items-message\">No drip campaigns yet. Create your first automated email sequence!</p>';
        return;
      }

      list.innerHTML = dripCampaigns.map(campaign => `
        <div class=\"drip-campaign-item\">
          <div class=\"drip-header\">
            <div>
              <h4 class=\"drip-title\">${campaign.name}</h4>
              <p style=\"color: var(--soft-gray); font-size: 13px; margin: 5px 0;\">${campaign.description}</p>
            </div>
            <div>
              <span class=\"badge ${campaign.active ? 'success' : ''}\">
                ${campaign.active ? 'Active' : 'Inactive'}
              </span>
              <button class=\"btn btn-sm\" onclick=\"editDripCampaign('${campaign.id}')\">Edit</button>
            </div>
          </div>
          <div class=\"drip-timeline\">
            ${campaign.emails.map((email, idx) => `
              <div class=\"drip-email\">
                <div class=\"drip-email-day\">Day ${email.dayOffset}</div>
                <div class=\"drip-email-subject\">${email.subject}</div>
              </div>
            `).join('')}
          </div>
          <div style=\"margin-top: 15px; font-size: 13px; color: var(--soft-gray);\">
            ðŸ“Š ${campaign.stats?.sent || 0} sent â€¢ ${campaign.stats?.opened || 0} opened â€¢ ${campaign.stats?.clicked || 0} clicked
          </div>
        </div>
      `).join('');
    }

    function showDripCampaignBuilder() {
      showModal(`
        <h3>Create Drip Campaign</h3>
        <p style=\"color: var(--soft-gray); margin-bottom: 20px;\">Build an automated email sequence that nurtures leads over time</p>
        
        <div class=\"form-group\">
          <label>Campaign Name</label>
          <input type=\"text\" id=\"dripName\" class=\"form-control\" placeholder=\"e.g., Welcome Series\">
        </div>
        
        <div class=\"form-group\">
          <label>Description</label>
          <input type=\"text\" id=\"dripDesc\" class=\"form-control\" placeholder=\"What is this campaign for?\">
        </div>

        <div class=\"form-group\">
          <label>Trigger</label>
          <select id=\"dripTrigger\" class=\"form-control\">
            <option value=\"lead_magnet\">After Lead Magnet Download</option>
            <option value=\"inquiry\">After Inquiry Submission</option>
            <option value=\"first_booking\">After First Booking</option>
            <option value=\"no_booking\">No Booking in 30 Days</option>
          </select>
        </div>

        <div class=\"form-group\">
          <label>Email Sequence (AI-Powered)</label>
          <button class=\"btn btn-secondary\" onclick=\"generateDripSequence()\" style=\"width: 100%;\">ðŸ¤– Generate 5-Email Sequence with AI</button>
        </div>

        <div id=\"dripEmailsPreview\" style=\"margin-top: 20px;\"></div>

        <div class=\"btn-group\">
          <button class=\"btn btn-secondary\" onclick=\"closeModal()\">Cancel</button>
          <button class=\"btn btn-primary\" onclick=\"saveDripCampaign()\">Create Campaign</button>
        </div>
      `);
    }

    async function generateDripSequence() {
      const name = document.getElementById('dripName').value;
      const trigger = document.getElementById('dripTrigger').value;
      
      if (!name) {
        showNotification('Please enter a campaign name first', 'error');
        return;
      }

      const preview = document.getElementById('dripEmailsPreview');
      preview.innerHTML = '<p>ðŸ¤– AI is crafting your email sequence...</p>';

      // Simulate AI generation (in production, call OpenAI API)
      setTimeout(() => {
        const sequences = {
          lead_magnet: [
            { day: 0, subject: 'ðŸª· Your Sacred Healing Guide is Here', preview: 'Welcome! Your journey begins...' },
            { day: 2, subject: 'Day 2: Understanding Your Energy Centers', preview: 'Let\'s explore the chakras...' },
            { day: 5, subject: 'Healing Practice: Morning Meditation', preview: 'Start your day with this simple practice...' },
            { day: 8, subject: 'Special Invitation: Private Healing Session', preview: 'Ready for deeper transformation?' },
            { day: 14, subject: 'Your Progress & Next Steps', preview: 'How has your journey been?' }
          ],
          inquiry: [
            { day: 0, subject: 'Thank You for Reaching Out ðŸ™', preview: 'I received your message and will respond soon...' },
            { day: 1, subject: 'About My Healing Approach', preview: 'Learn about the sacred practices I use...' },
            { day: 3, subject: 'Client Testimonials & Transformations', preview: 'See what others have experienced...' },
            { day: 5, subject: 'Book Your Session Today', preview: 'Let\'s begin your healing journey...' },
            { day: 10, subject: 'Still Thinking? Let\'s Talk', preview: 'Any questions I can answer?' }
          ],
          first_booking: [
            { day: 0, subject: 'Your Session is Confirmed! âœ¨', preview: 'Here\'s what to expect...' },
            { day: 1, subject: 'Preparing for Your Healing Session', preview: 'Tips to maximize your experience...' },
            { day: 7, subject: 'How Was Your Session?', preview: 'I\'d love to hear your feedback...' },
            { day: 14, subject: 'Continue Your Healing Journey', preview: 'Ready for your next session?' },
            { day: 30, subject: 'It\'s Been a While - How Are You?', preview: 'Checking in on your wellness...' }
          ],
          no_booking: [
            { day: 0, subject: 'We Miss You! ðŸ’œ', preview: 'It\'s been a while since your last session...' },
            { day: 3, subject: 'Special Offer: Return to Healing', preview: '20% off your next session...' },
            { day: 7, subject: 'Free Resource: Self-Healing Techniques', preview: 'Practice these at home...' },
            { day: 14, subject: 'Your Wellness Matters', preview: 'How can I support you?' },
            { day: 21, subject: 'Last Chance: Exclusive Offer Inside', preview: 'This offer expires soon...' }
          ]
        };

        const emails = sequences[trigger] || sequences.lead_magnet;
        window.generatedDripEmails = emails;

        preview.innerHTML = `
          <h4 style="color: var(--burgundy); margin-bottom: 15px;">âœ¨ AI-Generated Email Sequence</h4>
          ${emails.map((email, idx) => `
            <div style="padding: 12px; background: var(--background); border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--burgundy);">
              <div style="font-size: 11px; color: var(--gold); font-weight: 600; margin-bottom: 5px;">DAY ${email.day}</div>
              <div style="font-weight: 600; color: var(--text); margin-bottom: 3px;">${email.subject}</div>
              <div style="font-size: 13px; color: var(--soft-gray);">${email.preview}</div>
            </div>
          `).join('')}
        `;
      }, 2500);
    }

    async function saveDripCampaign() {
      const campaign = {
        id: Date.now().toString(),
        name: document.getElementById('dripName').value,
        description: document.getElementById('dripDesc').value,
        trigger: document.getElementById('dripTrigger').value,
        emails: window.generatedDripEmails || [],
        active: true,
        createdAt: new Date().toISOString(),
        stats: { sent: 0, opened: 0, clicked: 0 }
      };

      if (!campaign.name || campaign.emails.length === 0) {
        showNotification('Please fill all fields and generate the email sequence', 'error');
        return;
      }

      const result = await api('/api/admin/drip-campaigns', {
        method: 'POST',
        body: JSON.stringify(campaign)
      });

      if (result?.success) {
        showNotification('âœ… Drip campaign created successfully! It will automatically send to new leads.', 'success');
        closeModal();
        loadDripCampaigns();
      }
    }

    async function loadCampaigns() {
      const result = await api('/api/admin/campaigns');
      if (result?.campaigns) {
        campaigns = result.campaigns;
        renderCampaigns();
      }
    }

    function renderCampaigns() {
      const total = campaigns.length;
      const sent = campaigns.filter(c => c.status === 'sent').length;
      const openRates = campaigns.filter(c => c.stats?.openRate).map(c => c.stats.openRate);
      const clickRates = campaigns.filter(c => c.stats?.clickRate).map(c => c.stats.clickRate);
      
      document.getElementById('totalCampaigns').textContent = total;
      document.getElementById('sentCampaigns').textContent = sent;
      document.getElementById('avgOpenRate').textContent = openRates.length ? 
        (openRates.reduce((a,b) => a+b, 0) / openRates.length).toFixed(1) + '%' : '0%';
      document.getElementById('avgClickRate').textContent = clickRates.length ? 
        (clickRates.reduce((a,b) => a+b, 0) / clickRates.length).toFixed(1) + '%' : '0%';

      const list = document.getElementById('campaignsList');
      if (campaigns.length === 0) {
        list.innerHTML = '<p class="no-items-message">No campaigns yet. Create your first email campaign!</p>';
        return;
      }

      list.innerHTML = campaigns.map(campaign => `
        <div class="campaign-item">
          <div class="campaign-header">
            <div>
              <div class="campaign-title">${campaign.name}</div>
              <div class="campaign-meta">
                <span><span class="status-badge ${campaign.status}">${campaign.status.toUpperCase()}</span></span>
                <span>ðŸ“§ ${campaign.recipientCount || 0} recipients</span>
                ${campaign.sentDate ? `<span>ðŸ“… ${new Date(campaign.sentDate).toLocaleDateString()}</span>` : ''}
                ${campaign.stats ? `<span>ðŸ“Š ${campaign.stats.openRate}% opens, ${campaign.stats.clickRate}% clicks</span>` : ''}
              </div>
            </div>
            <div class="campaign-actions">
              ${campaign.status === 'draft' ? `
                <button class="btn btn-sm btn-secondary" onclick="editCampaign('${campaign.id}')">âœï¸ Edit</button>
                <button class="btn btn-sm btn-primary" onclick="sendCampaign('${campaign.id}')">ðŸ“§ Send</button>
              ` : ''}
              ${campaign.status === 'sent' ? `
                <button class="btn btn-sm btn-secondary" onclick="viewCampaignStats('${campaign.id}')">ðŸ“Š Stats</button>
                <button class="btn btn-sm btn-secondary" onclick="duplicateCampaign('${campaign.id}')">ðŸ“‹ Duplicate</button>
              ` : ''}
              <button class="btn btn-sm" onclick="deleteCampaign('${campaign.id}')" style="color: var(--danger);">ðŸ—‘ï¸</button>
            </div>
          </div>
          ${campaign.subject ? `<div style="color: var(--soft-gray); margin-top: 8px;">Subject: ${campaign.subject}</div>` : ''}
        </div>
      `).join('');
    }

    function showCampaignBuilder() {
      const modal = `
        <div class="modal-overlay active" id="campaignModal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Create Email Campaign</h2>
              <button class="modal-close" onclick="closeCampaignModal()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Campaign Name</label>
                <input type="text" id="campaignName" class="form-control" placeholder="e.g., Monthly Newsletter">
              </div>
              <div class="form-group">
                <label>Email Subject</label>
                <input type="text" id="campaignSubject" class="form-control" placeholder="Your subject line">
              </div>
              <div class="form-group">
                <label>Target Audience</label>
                <select id="campaignSegment" class="form-control">
                  <option value="all">All Clients</option>
                  ${segments.map(s => `<option value="${s.id}">${s.name} (${s.count} clients)</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>Email Template</label>
                <select id="campaignTemplate" class="form-control" onchange="previewTemplate()">
                  <option value="">Select a template...</option>
                  ${templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                </select>
              </div>
              <div class="form-group">
                <label>Email Body</label>
                <textarea id="campaignBody" class="form-control" rows="8" placeholder="Your email content here..."></textarea>
                <small style="color: var(--soft-gray);">Use {{firstName}}, {{lastName}}, {{email}} for personalization</small>
              </div>
              <div class="email-preview" id="emailPreview" style="display:none;">
                <div class="email-preview-subject" id="previewSubject"></div>
                <div class="email-preview-body" id="previewBody"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeCampaignModal()">Cancel</button>
              <button class="btn btn-secondary" onclick="saveCampaignDraft()">ðŸ’¾ Save Draft</button>
              <button class="btn btn-primary" onclick="scheduleCampaign()">ðŸ“§ Send Now</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeCampaignModal() {
      document.getElementById('campaignModal')?.remove();
    }

    async function saveCampaignDraft() {
      const campaign = {
        id: Date.now().toString(),
        name: document.getElementById('campaignName').value,
        subject: document.getElementById('campaignSubject').value,
        body: document.getElementById('campaignBody').value,
        segment: document.getElementById('campaignSegment').value,
        template: document.getElementById('campaignTemplate').value,
        status: 'draft',
        createdDate: new Date().toISOString()
      };

      if (!campaign.name || !campaign.subject || !campaign.body) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      showLoading(true);
      const result = await api('/api/admin/campaigns', {
        method: 'POST',
        body: JSON.stringify(campaign)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Campaign saved as draft!', 'success');
        closeCampaignModal();
        await loadCampaigns();
      } else {
        showToast('Failed to save campaign', 'error');
      }
    }

    async function scheduleCampaign() {
      if (!confirm('Send this campaign now to all recipients?')) return;
      
      const campaign = {
        id: Date.now().toString(),
        name: document.getElementById('campaignName').value,
        subject: document.getElementById('campaignSubject').value,
        body: document.getElementById('campaignBody').value,
        segment: document.getElementById('campaignSegment').value,
        template: document.getElementById('campaignTemplate').value,
        status: 'scheduled',
        createdDate: new Date().toISOString()
      };

      showLoading(true);
      const result = await api('/api/admin/campaigns/send', {
        method: 'POST',
        body: JSON.stringify(campaign)
      });
      showLoading(false);

      if (result?.success) {
        showToast(`Campaign sent to ${result.recipientCount} recipients!`, 'success');
        closeCampaignModal();
        await loadCampaigns();
      } else {
        showToast('Failed to send campaign', 'error');
      }
    }

    async function loadSegments() {
      const result = await api('/api/admin/segments');
      if (result?.segments) {
        segments = result.segments;
        renderSegments();
      }
    }

    function renderSegments() {
      const list = document.getElementById('segmentsList');
      if (segments.length === 0) {
        list.innerHTML = '<p class="no-items-message">No segments yet. Create your first audience segment!</p>';
        return;
      }

      list.innerHTML = segments.map(segment => `
        <div class="segment-item">
          <div class="segment-header">
            <div>
              <div class="segment-title">${segment.name}</div>
              <div class="segment-meta">
                <span>ðŸ‘¥ ${segment.count || 0} clients</span>
                <span>ðŸŽ¯ ${segment.filters?.length || 0} filters</span>
                <span>ðŸ“… Updated ${new Date(segment.updatedDate).toLocaleDateString()}</span>
              </div>
            </div>
            <div class="segment-actions">
              <button class="btn btn-sm btn-secondary" onclick="editSegment('${segment.id}')">âœï¸ Edit</button>
              <button class="btn btn-sm btn-primary" onclick="exportSegment('${segment.id}')">ðŸ“¥ Export</button>
              <button class="btn btn-sm" onclick="deleteSegment('${segment.id}')" style="color: var(--danger);">ðŸ—‘ï¸</button>
            </div>
          </div>
          <div style="color: var(--soft-gray); margin-top: 8px; font-size: 14px;">${segment.description || ''}</div>
        </div>
      `).join('');
    }

    function showSegmentBuilder() {
      const modal = `
        <div class="modal-overlay active" id="segmentModal">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Create Client Segment</h2>
              <button class="modal-close" onclick="closeSegmentModal()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Segment Name</label>
                <input type="text" id="segmentName" class="form-control" placeholder="e.g., Active Clients">
              </div>
              <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="segmentDescription" class="form-control" placeholder="Who this segment includes">
              </div>
              <div class="form-group">
                <label>Filters</label>
                <div id="segmentFilters">
                  <div class="segment-filter">
                    <div class="segment-filter-row">
                      <select class="form-control filter-field">
                        <option value="bookingCount">Total Bookings</option>
                        <option value="lastBooking">Last Booking Date</option>
                        <option value="totalSpent">Total Spent</option>
                        <option value="service">Service Type</option>
                        <option value="lifecycle">Lifecycle Stage</option>
                      </select>
                      <select class="form-control filter-operator">
                        <option value="equals">Equals</option>
                        <option value="greater">Greater Than</option>
                        <option value="less">Less Than</option>
                        <option value="contains">Contains</option>
                      </select>
                      <input type="text" class="form-control filter-value" placeholder="Value">
                    </div>
                  </div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="addSegmentFilter()" style="margin-top: 8px;">+ Add Filter</button>
              </div>
              <div style="background: var(--gold-light); padding: 12px; border-radius: 8px; margin-top: 16px;">
                <strong>Estimated audience:</strong> <span id="segmentEstimate">Calculating...</span>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeSegmentModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveSegment()">ðŸ’¾ Create Segment</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
      calculateSegmentEstimate();
    }

    function closeSegmentModal() {
      document.getElementById('segmentModal')?.remove();
    }

    async function calculateSegmentEstimate() {
      // Simulate calculation - in real implementation, would query server
      setTimeout(() => {
        const estimate = Math.floor(Math.random() * clients.length);
        document.getElementById('segmentEstimate').textContent = `~${estimate} clients`;
      }, 500);
    }

    async function saveSegment() {
      const filters = Array.from(document.querySelectorAll('.segment-filter')).map(filter => ({
        field: filter.querySelector('.filter-field').value,
        operator: filter.querySelector('.filter-operator').value,
        value: filter.querySelector('.filter-value').value
      }));

      const segment = {
        id: Date.now().toString(),
        name: document.getElementById('segmentName').value,
        description: document.getElementById('segmentDescription').value,
        filters: filters,
        count: 0, // Will be calculated server-side
        createdDate: new Date().toISOString(),
        updatedDate: new Date().toISOString()
      };

      if (!segment.name) {
        showToast('Please enter a segment name', 'error');
        return;
      }

      showLoading(true);
      const result = await api('/api/admin/segments', {
        method: 'POST',
        body: JSON.stringify(segment)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Segment created!', 'success');
        closeSegmentModal();
        await loadSegments();
      } else {
        showToast('Failed to create segment', 'error');
      }
    }

    async function loadWorkflows() {
      const result = await api('/api/admin/automation');
      if (result?.workflows) {
        workflows = result.workflows;
        renderWorkflows();
      }
    }

    function renderWorkflows() {
      const list = document.getElementById('workflowsList');
      if (workflows.length === 0) {
        list.innerHTML = '<p class="no-items-message">No workflows yet. Automate your client communications!</p>';
        return;
      }

      list.innerHTML = workflows.map(workflow => `
        <div class="workflow-item">
          <div class="workflow-header">
            <div>
              <div class="workflow-title">${workflow.name}</div>
              <div class="workflow-meta">
                <span><span class="status-badge ${workflow.active ? 'active' : 'paused'}">${workflow.active ? 'ACTIVE' : 'PAUSED'}</span></span>
                <span>âš¡ ${workflow.trigger}</span>
                <span>ðŸ“§ ${workflow.steps?.length || 0} steps</span>
                <span>ðŸ‘¥ ${workflow.executed || 0} sent</span>
              </div>
            </div>
            <div class="workflow-actions">
              <button class="btn btn-sm btn-secondary" onclick="toggleWorkflow('${workflow.id}')">${workflow.active ? 'â¸ï¸ Pause' : 'â–¶ï¸ Activate'}</button>
              <button class="btn btn-sm btn-secondary" onclick="editWorkflow('${workflow.id}')">âœï¸ Edit</button>
              <button class="btn btn-sm" onclick="deleteWorkflow('${workflow.id}')" style="color: var(--danger);">ðŸ—‘ï¸</button>
            </div>
          </div>
          <div style="color: var(--soft-gray); margin-top: 8px; font-size: 14px;">${workflow.description || ''}</div>
        </div>
      `).join('');
    }

    function showWorkflowBuilder() {
      const modal = `
        <div class="modal-overlay active" id="workflowModal">
          <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
              <h2>Create Automated Workflow</h2>
              <button class="modal-close" onclick="closeWorkflowModal()">Ã—</button>
            </div>
            <div class="modal-body">
              <div class="form-group">
                <label>Workflow Name</label>
                <input type="text" id="workflowName" class="form-control" placeholder="e.g., Welcome Sequence">
              </div>
              <div class="form-group">
                <label>Description (optional)</label>
                <input type="text" id="workflowDescription" class="form-control" placeholder="What this workflow does">
              </div>
              <div class="form-group">
                <label>Trigger Event</label>
                <select id="workflowTrigger" class="form-control">
                  <option value="new_booking">New Booking Confirmed</option>
                  <option value="booking_completed">Booking Completed</option>
                  <option value="new_client">New Client Registered</option>
                  <option value="inactive_30days">Client Inactive for 30 Days</option>
                  <option value="birthday">Client Birthday</option>
                </select>
              </div>
              <div class="form-group">
                <label>Email Steps</label>
                <div id="workflowSteps">
                  <div class="workflow-step">
                    <div class="workflow-step-header">
                      <span class="workflow-step-title">Step 1: Immediate</span>
                      <button class="btn btn-sm" onclick="this.parentElement.parentElement.remove()" style="color: var(--danger);">Remove</button>
                    </div>
                    <input type="text" class="form-control step-subject" placeholder="Email subject" style="margin-bottom: 8px;">
                    <textarea class="form-control step-body" rows="4" placeholder="Email body"></textarea>
                    <div style="margin-top: 8px;">
                      <label style="font-size: 13px;">Delay before next step:</label>
                      <input type="number" class="form-control step-delay" value="3" style="width: 80px; display: inline-block; margin: 0 8px;"> days
                    </div>
                  </div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="addWorkflowStep()" style="margin-top: 8px;">+ Add Step</button>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" onclick="closeWorkflowModal()">Cancel</button>
              <button class="btn btn-primary" onclick="saveWorkflow()">ðŸ’¾ Create Workflow</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modal);
    }

    function closeWorkflowModal() {
      document.getElementById('workflowModal')?.remove();
    }

    function addWorkflowStep() {
      const steps = document.getElementById('workflowSteps');
      const stepNum = steps.children.length + 1;
      const stepHTML = `
        <div class="workflow-step">
          <div class="workflow-step-header">
            <span class="workflow-step-title">Step ${stepNum}</span>
            <button class="btn btn-sm" onclick="this.parentElement.parentElement.remove()" style="color: var(--danger);">Remove</button>
          </div>
          <input type="text" class="form-control step-subject" placeholder="Email subject" style="margin-bottom: 8px;">
          <textarea class="form-control step-body" rows="4" placeholder="Email body"></textarea>
          <div style="margin-top: 8px;">
            <label style="font-size: 13px;">Delay before next step:</label>
            <input type="number" class="form-control step-delay" value="3" style="width: 80px; display: inline-block; margin: 0 8px;"> days
          </div>
        </div>
      `;
      steps.insertAdjacentHTML('beforeend', stepHTML);
    }

    async function saveWorkflow() {
      const steps = Array.from(document.querySelectorAll('.workflow-step')).map((step, idx) => ({
        stepNumber: idx + 1,
        subject: step.querySelector('.step-subject').value,
        body: step.querySelector('.step-body').value,
        delay: parseInt(step.querySelector('.step-delay').value) || 0
      }));

      const workflow = {
        id: Date.now().toString(),
        name: document.getElementById('workflowName').value,
        description: document.getElementById('workflowDescription').value,
        trigger: document.getElementById('workflowTrigger').value,
        steps: steps,
        active: true,
        executed: 0,
        createdDate: new Date().toISOString()
      };

      if (!workflow.name || steps.length === 0) {
        showToast('Please enter a name and at least one email step', 'error');
        return;
      }

      showLoading(true);
      const result = await api('/api/admin/automation', {
        method: 'POST',
        body: JSON.stringify(workflow)
      });
      showLoading(false);

      if (result?.success) {
        showToast('Workflow created!', 'success');
        closeWorkflowModal();
        await loadWorkflows();
      } else {
        showToast('Failed to create workflow', 'error');
      }
    }

    async function loadTemplates() {
      const result = await api('/api/admin/templates');
      if (result?.templates) {
        templates = result.templates;
      } else {
        // Load default templates
        templates = [
          {
            id: 'welcome',
            name: 'Welcome Email',
            description: 'Greet new clients and introduce your services',
            icon: 'ðŸ‘‹',
            subject: 'Welcome to {{businessName}}!',
            body: 'Hi {{firstName}},\n\nThank you for choosing us! We\'re excited to have you.\n\nBest regards,\n{{businessName}}'
          },
          {
            id: 'booking_confirmation',
            name: 'Booking Confirmation',
            description: 'Confirm upcoming appointments',
            icon: 'ðŸ“…',
            subject: 'Your booking is confirmed',
            body: 'Hi {{firstName}},\n\nYour booking for {{service}} on {{date}} is confirmed.\n\nSee you soon!'
          },
          {
            id: 'thank_you',
            name: 'Thank You',
            description: 'Follow up after appointments',
            icon: 'ðŸ’',
            subject: 'Thank you for visiting us!',
            body: 'Hi {{firstName}},\n\nThank you for your recent visit. We hope you enjoyed your experience.\n\nWe\'d love to see you again soon!'
          },
          {
            id: 're_engagement',
            name: 'Re-engagement',
            description: 'Win back inactive clients',
            icon: 'ðŸ””',
            subject: 'We miss you!',
            body: 'Hi {{firstName}},\n\nIt\'s been a while since we last saw you. We have some exciting new services and special offers.\n\nCome back and visit us!'
          },
          {
            id: 'newsletter',
            name: 'Newsletter',
            description: 'Regular updates and announcements',
            icon: 'ðŸ“°',
            subject: 'Monthly Newsletter',
            body: 'Hi {{firstName}},\n\nHere\'s what\'s new this month...\n\n[Your content here]'
          },
          {
            id: 'promotion',
            name: 'Promotion',
            description: 'Special offers and discounts',
            icon: 'ðŸŽ',
            subject: 'Special offer just for you!',
            body: 'Hi {{firstName}},\n\nWe have a special promotion for you: [Your offer details]\n\nDon\'t miss out!'
          }
        ];
      }
      renderTemplates();
    }

    function renderTemplates() {
      const gallery = document.getElementById('templateGallery');
      gallery.innerHTML = templates.map(template => `
        <div class="template-card" onclick="useTemplate('${template.id}')">
          <div class="template-preview">${template.icon || 'ðŸ“§'}</div>
          <div class="template-info">
            <div class="template-name">${template.name}</div>
            <div class="template-description">${template.description}</div>
          </div>
        </div>
      `).join('');
    }

    function useTemplate(templateId) {
      const template = templates.find(t => t.id === templateId);
      if (!template) return;
      
      showToast(`Using template: ${template.name}`, 'info');
      // Template will be used when creating campaign
    }

    function showTemplateEditor() {
      showToast('Custom template editor coming soon! Use the built-in templates for now.', 'info');
    }

    async function loadMarketingAnalytics() {
      const days = parseInt(document.getElementById('analyticsDateRange')?.value || 30);
      const result = await api(`/api/admin/analytics/marketing?days=${days}`);
      
      if (result?.analytics) {
        marketingAnalytics = result.analytics;
        renderMarketingAnalytics();
      } else {
        // Default/demo data
        marketingAnalytics = {
          totalSubscribers: clients.length,
          emailsSent: campaigns.filter(c => c.status === 'sent').length * 50,
          totalOpens: campaigns.filter(c => c.status === 'sent').length * 25,
          totalClicks: campaigns.filter(c => c.status === 'sent').length * 8,
          lifecycle: {
            'New Lead': 12,
            'Active Client': 45,
            'Returning Client': 23,
            'At Risk': 8,
            'Inactive': 5
          }
        };
        renderMarketingAnalytics();
      }
    }

    function renderMarketingAnalytics() {
      document.getElementById('totalSubscribers').textContent = marketingAnalytics.totalSubscribers || clients.length;
      document.getElementById('totalEmailsSent').textContent = marketingAnalytics.emailsSent || 0;
      document.getElementById('totalOpens').textContent = marketingAnalytics.totalOpens || 0;
      document.getElementById('totalClicks').textContent = marketingAnalytics.totalClicks || 0;

      // Lifecycle chart
      const lifecycleData = marketingAnalytics.lifecycle || {};
      const total = Object.values(lifecycleData).reduce((a, b) => a + b, 0) || 1;
      
      const lifecycleHTML = Object.entries(lifecycleData).map(([stage, count]) => {
        const percentage = (count / total * 100).toFixed(0);
        return `
          <div class="lifecycle-bar">
            <div class="lifecycle-label">${stage}</div>
            <div class="lifecycle-progress">
              <div class="lifecycle-progress-fill" style="width: ${percentage}%">${percentage}%</div>
            </div>
            <div class="lifecycle-count">${count}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('lifecycleChart').innerHTML = lifecycleHTML || '<p class="no-items-message">No data available</p>';

      // Campaign performance
      const performanceHTML = campaigns
        .filter(c => c.status === 'sent' && c.stats)
        .sort((a, b) => (b.stats.openRate || 0) - (a.stats.openRate || 0))
        .slice(0, 5)
        .map(c => `
          <div style="padding: 12px; border: 1px solid #e0d6cc; border-radius: 8px; margin-bottom: 8px;">
            <strong>${c.name}</strong><br>
            <small style="color: var(--soft-gray);">
              ðŸ“§ ${c.recipientCount} sent | 
              ðŸ“Š ${c.stats.openRate}% opens | 
              ðŸ–±ï¸ ${c.stats.clickRate}% clicks
            </small>
          </div>
        `).join('');
      
      document.getElementById('campaignPerformanceList').innerHTML = performanceHTML || '<p class="no-items-message">No sent campaigns yet</p>';
    }

    async function deleteCampaign(id) {
      if (!confirm('Delete this campaign?')) return;
      showLoading(true);
      const result = await api(`/api/admin/campaigns/${id}`, { method: 'DELETE' });
      showLoading(false);
      if (result?.success) {
        showToast('Campaign deleted', 'success');
        await loadCampaigns();
      }
    }

    async function deleteSegment(id) {
      if (!confirm('Delete this segment?')) return;
      showLoading(true);
      const result = await api(`/api/admin/segments/${id}`, { method: 'DELETE' });
      showLoading(false);
      if (result?.success) {
        showToast('Segment deleted', 'success');
        await loadSegments();
      }
    }

    async function deleteWorkflow(id) {
      if (!confirm('Delete this workflow?')) return;
      showLoading(true);
      const result = await api(`/api/admin/automation/${id}`, { method: 'DELETE' });
      showLoading(false);
      if (result?.success) {
        showToast('Workflow deleted', 'success');
        await loadWorkflows();
      }
    }

    async function toggleWorkflow(id) {
      const workflow = workflows.find(w => w.id === id);
      if (!workflow) return;
      
      workflow.active = !workflow.active;
      showLoading(true);
      const result = await api(`/api/admin/automation/${id}`, {
        method: 'PUT',
        body: JSON.stringify(workflow)
      });
      showLoading(false);
      
      if (result?.success) {
        showToast(workflow.active ? 'Workflow activated' : 'Workflow paused', 'success');
        await loadWorkflows();
      }
    }

    // ===========================================
    // EXPORT & BACKUP
    // ===========================================
    async function exportBookings() {
      window.open('/api/admin/export/bookings', '_blank');
    }

    async function exportClients() {
      window.open('/api/admin/export/clients', '_blank');
    }

    async function downloadBackup() {
      window.open('/api/admin/backup', '_blank');
      showToast('Backup downloading...', 'info');
    }

    async function handleRestore(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const backup = JSON.parse(e.target.result);
          if (!confirm('This will replace all current data. Are you sure?')) return;

          showLoading(true);
          const result = await api('/api/admin/restore', {
            method: 'POST',
            body: JSON.stringify({ backup })
          });
          showLoading(false);

          if (result?.success) {
            showToast('Backup restored successfully!', 'success');
            refreshDashboard();
          }
        } catch (err) {
          showToast('Invalid backup file', 'error');
        }
      };
      reader.readAsText(file);
      input.value = '';
    }

    // ===========================================
    // AUTOMATIC BACKUP MANAGEMENT
    // ===========================================
    
    let allBackups = { auto: [], manual: [] };
    let currentFilter = 'all';

    async function loadBackupStats() {
      try {
        const stats = await api('/api/admin/backups/stats');
        
        // Update stat cards
        document.getElementById('totalAutoBackups').textContent = stats.autoBackups.total || 0;
        document.getElementById('totalManualBackups').textContent = stats.manualBackups.total || 0;
        
        // Format size
        const totalBytes = (stats.autoBackups.totalSize || 0) + (stats.manualBackups.totalSize || 0);
        const sizeMB = (totalBytes / 1024 / 1024).toFixed(2);
        document.getElementById('backupSize').textContent = sizeMB + ' MB';
        
        // Format newest backup time
        if (stats.newestBackup) {
          const date = new Date(stats.newestBackup);
          const timeAgo = getTimeAgo(date);
          document.getElementById('newestBackup').textContent = timeAgo;
        } else {
          document.getElementById('newestBackup').textContent = 'None';
        }
        
        // Load backup list
        await loadBackupList();
      } catch (err) {
        console.error('Failed to load backup stats:', err);
        showToast('Failed to load backup stats', 'error');
      }
    }

    async function loadBackupList() {
      try {
        const backups = await api('/api/admin/backups/list');
        allBackups = backups;
        renderBackupList();
      } catch (err) {
        console.error('Failed to load backup list:', err);
        const tbody = document.getElementById('backupListTable');
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 40px; text-align: center; color: #c62828;">
              <div style="font-size: 48px; margin-bottom: 8px;">âš ï¸</div>
              <div>Failed to load backups</div>
            </td>
          </tr>
        `;
      }
    }

    function filterBackups(type) {
      currentFilter = type;
      
      // Update button styles
      ['All', 'Bookings', 'Settings', 'Content', 'Clients', 'Manual'].forEach(t => {
        const btn = document.getElementById('filter' + t);
        if (btn) {
          if (t.toLowerCase() === type) {
            btn.style.background = 'var(--burgundy)';
            btn.style.color = 'white';
            btn.classList.remove('btn-outline');
          } else {
            btn.style.background = '';
            btn.style.color = '';
            btn.classList.add('btn-outline');
          }
        }
      });
      
      renderBackupList();
    }

    function renderBackupList() {
      const tbody = document.getElementById('backupListTable');
      
      // Filter backups
      let filtered = [];
      
      if (currentFilter === 'all') {
        filtered = [...allBackups.auto, ...allBackups.manual];
      } else if (currentFilter === 'manual') {
        filtered = allBackups.manual;
      } else {
        filtered = allBackups.auto.filter(b => b.fileType === currentFilter);
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 40px; text-align: center; color: var(--soft-gray);">
              <div style="font-size: 48px; margin-bottom: 8px;">ðŸ“­</div>
              <div>No backups found</div>
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort by date (newest first)
      filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Render rows
      tbody.innerHTML = filtered.map(backup => {
        const date = new Date(backup.date);
        const fileType = backup.fileType || 'Full Backup';
        const type = backup.path === 'auto' ? 'Auto' : 'Manual';
        const icon = backup.path === 'auto' ? 'ðŸ”„' : 'ðŸ’¾';
        const sizeKB = (backup.size / 1024).toFixed(1);
        
        return `
          <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 12px;">
              <strong>${fileType}</strong>
            </td>
            <td style="padding: 12px; color: var(--soft-gray);">
              ${formatDateTime(date)}
            </td>
            <td style="padding: 12px; color: var(--soft-gray);">
              ${sizeKB} KB
            </td>
            <td style="padding: 12px;">
              <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: ${type === 'Auto' ? '#e3f2fd' : '#fff3e0'}; color: ${type === 'Auto' ? '#1565c0' : '#e65100'};">
                ${icon} ${type}
              </span>
            </td>
            <td style="padding: 12px; text-align: center;">
              ${backup.path === 'auto' && backup.fileType ? `
                <button class="btn btn-sm btn-outline" onclick="restoreAutoBackup('${backup.name}', '${backup.fileType}')" style="padding: 6px 12px; font-size: 12px;">
                  â†©ï¸ Restore
                </button>
              ` : '-'}
            </td>
          </tr>
        `;
      }).join('');
    }

    async function restoreAutoBackup(filename, fileType) {
      if (!confirm(`âš ï¸ Restore ${fileType} from this backup?\n\nYour current ${fileType} data will be backed up before restoring.\n\nContinue?`)) {
        return;
      }
      
      try {
        showLoading(true);
        const result = await api('/api/admin/backups/restore', {
          method: 'POST',
          body: JSON.stringify({ filename, fileType })
        });
        showLoading(false);
        
        if (result?.success) {
          showToast(result.message, 'success');
          await loadBackupStats();
          refreshDashboard();
        }
      } catch (err) {
        showLoading(false);
        console.error('Restore failed:', err);
        showToast('Failed to restore backup: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      
      return date.toLocaleDateString();
    }

    function formatDateTime(date) {
      const options = {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      };
      return date.toLocaleDateString('en-US', options);
    }

    // ===========================================
    // DEMO MODE
    // ===========================================
    async function populateDemoData() {
      if (!confirm('This will add sample bookings, clients, inquiries, and invitation codes. Continue?')) return;
      
      showLoading(true);
      const result = await api('/api/admin/demo/populate', { method: 'POST' });
      showLoading(false);
      
      if (result?.success) {
        showToast(`Demo data populated! Added ${result.counts.bookings} bookings, ${result.counts.clients} clients, ${result.counts.inquiries} inquiries`, 'success');
        refreshDashboard();
      }
    }

    async function resetDemoData() {
      if (!confirm('âš ï¸ This will DELETE ALL DATA (bookings, clients, inquiries, invitation codes). This cannot be undone. Are you absolutely sure?')) return;
      if (!confirm('Last chance! Click OK to permanently delete everything.')) return;
      
      showLoading(true);
      const result = await api('/api/admin/demo/reset', { method: 'POST' });
      showLoading(false);
      
      if (result?.success) {
        showToast('All data cleared!', 'success');
        refreshDashboard();
      }
    }

    // ===========================================
    // PASSWORD MANAGEMENT
    // ===========================================
    
    // Password strength checker
    function checkPasswordStrength(password) {
      const strengthEl = document.getElementById('passwordStrength');
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');
      
      if (!password) {
        strengthEl.style.display = 'none';
        return;
      }
      
      strengthEl.style.display = 'block';
      
      let strength = 0;
      let feedback = [];
      
      // Length check
      if (password.length >= 12) strength += 25;
      else feedback.push('at least 12 characters');
      
      // Uppercase check
      if (/[A-Z]/.test(password)) strength += 25;
      else feedback.push('uppercase letters');
      
      // Lowercase check
      if (/[a-z]/.test(password)) strength += 25;
      else feedback.push('lowercase letters');
      
      // Number check
      if (/[0-9]/.test(password)) strength += 12.5;
      else feedback.push('numbers');
      
      // Special character check
      if (/[^A-Za-z0-9]/.test(password)) strength += 12.5;
      else feedback.push('special characters');
      
      // Display strength
      strengthBar.style.width = strength + '%';
      
      if (strength < 50) {
        strengthBar.style.background = '#f44336';
        strengthText.textContent = 'Weak';
        strengthText.style.color = '#f44336';
      } else if (strength < 75) {
        strengthBar.style.background = '#ff9800';
        strengthText.textContent = 'Medium';
        strengthText.style.color = '#ff9800';
      } else {
        strengthBar.style.background = '#4caf50';
        strengthText.textContent = 'Strong';
        strengthText.style.color = '#4caf50';
      }
      
      if (feedback.length > 0) {
        strengthText.textContent += ' - Add: ' + feedback.join(', ');
      }
    }
    
    // Add event listener for password input
    document.addEventListener('DOMContentLoaded', () => {
      const newPasswordInput = document.getElementById('newPassword');
      if (newPasswordInput) {
        newPasswordInput.addEventListener('input', (e) => {
          checkPasswordStrength(e.target.value);
        });
      }
    });
    
    async function handlePasswordChange(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validation
      if (newPassword !== confirmPassword) {
        showToast('New passwords do not match', 'error');
        return;
      }
      
      if (newPassword.length < 12) {
        showToast('New password must be at least 12 characters', 'error');
        return;
      }
      
      // Check password strength requirements
      const hasUpper = /[A-Z]/.test(newPassword);
      const hasLower = /[a-z]/.test(newPassword);
      const hasNumber = /[0-9]/.test(newPassword);
      const hasSpecial = /[^A-Za-z0-9]/.test(newPassword);
      
      if (!hasUpper || !hasLower || !hasNumber || !hasSpecial) {
        showToast('Password must include uppercase, lowercase, numbers, and special characters', 'error');
        return;
      }
      
      if (currentPassword === newPassword) {
        showToast('New password must be different from current password', 'error');
        return;
      }
      
      if (!confirm('Changing your password will log you out. Continue?')) {
        return;
      }
      
      showLoading(true);
      
      const result = await api('/api/admin/change-password', {
        method: 'POST',
        body: JSON.stringify({
          currentPassword,
          newPassword
        })
      });
      
      showLoading(false);
      
      if (result?.success) {
        showToast('Password changed successfully! Logging out...', 'success');
        setTimeout(() => {
          localStorage.removeItem('adminToken');
          window.location.href = '/admin.html';
        }, 2000);
      } else {
        showToast(result?.error || 'Failed to change password', 'error');
      }
    }

    // ===========================================
    // EMAIL
    // ===========================================
    function openEmailModal(bookingId, email, name) {
      document.getElementById('emailBookingId').value = bookingId;
      document.getElementById('emailRecipient').textContent = `To: ${name} (${email})`;
      document.getElementById('emailSubject').value = '';
      document.getElementById('emailMessage').value = '';
      openModal('emailModal');
    }

    async function sendCustomEmail() {
      const bookingId = document.getElementById('emailBookingId').value;
      const subject = document.getElementById('emailSubject').value;
      const message = document.getElementById('emailMessage').value;

      if (!subject || !message) {
        showToast('Please enter subject and message', 'error');
        return;
      }

      showLoading(true);
      const result = await api(`/api/admin/send-custom-email/${bookingId}`, {
        method: 'POST',
        body: JSON.stringify({ subject, message })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Email sent!', 'success');
        closeModal('emailModal');
      }
    }

    // ===========================================
    // CLIENT MESSAGING
    // ===========================================
    function openClientMessageModal(id, type, name, email) {
      document.getElementById('clientMessageId').value = id;
      document.getElementById('clientMessageType').value = type;
      document.getElementById('clientMessageRecipient').textContent = `To: ${name} (${email})`;
      document.getElementById('clientMessageSubject').value = 'A Message from Ravi ðŸª·';
      document.getElementById('clientMessageText').value = '';
      document.getElementById('proposedDate').value = '';
      document.getElementById('proposedTime').value = '';
      document.getElementById('includeTestimonialLink').checked = false;
      
      // Show proposed time fields for booking messages
      document.getElementById('proposedTimeGroup').style.display = type === 'booking' ? 'block' : 'none';
      
      openModal('clientMessageModal');
    }

    // Message Templates
    const messageTemplates = {
      confirm: {
        subject: 'Your Session is Confirmed âœ¨',
        message: `Dear {name},

I'm looking forward to our session together. Please remember to:

â€¢ Arrive 5-10 minutes early to settle in
â€¢ Wear comfortable, loose clothing
â€¢ Bring any intentions you'd like to focus on

If you need to reschedule, please let me know at least 24 hours in advance.

With gratitude,
Ravi ðŸª·`
      },
      reminder: {
        subject: 'Session Reminder - Tomorrow ðŸŒ¸',
        message: `Dear {name},

Just a gentle reminder that we have a session scheduled for tomorrow. 

Please take some time this evening to reflect on what you'd like to bring to our time together.

Looking forward to holding space for you.

With love,
Ravi ðŸª·`
      },
      followup: {
        subject: 'Holding You in My Heart ðŸ’',
        message: `Dear {name},

I wanted to check in and see how you're feeling after our session. The work we did together was beautiful, and I'm curious how it's integrating for you.

Remember to be gentle with yourself as you process. Drink plenty of water and allow yourself rest if needed.

I'm here if you need anything.

With deep care,
Ravi ðŸª·`
      },
      reschedule: {
        subject: 'Let\'s Find a New Time ðŸ“…',
        message: `Dear {name},

I understand that schedules can shift. Let's find a time that works better for you.

Please let me know your availability, or you can book directly through the website when you're ready.

No pressure - we'll connect when the time is right.

Warmly,
Ravi ðŸª·`
      },
      checkin: {
        subject: 'Thinking of You ðŸŒ¸',
        message: `Dear {name},

It's been a little while since we last connected, and I wanted to reach out and see how you're doing.

Your healing journey is important, and I'm here whenever you feel called to continue our work together.

I hope life is treating you gently.

With warmth,
Ravi ðŸª·`
      },
      thanks: {
        subject: 'Thank You for Your Trust ðŸ™',
        message: `Dear {name},

I wanted to express my deep gratitude for choosing to work with me. Your openness and courage inspire me.

Thank you for trusting me to hold space for your healing. It's an honor I don't take lightly.

Wishing you continued blessings on your path.

With love and appreciation,
Ravi ðŸª·`
      }
    };

    function useTemplate(templateName) {
      const template = messageTemplates[templateName];
      if (!template) return;
      
      // Get client name from the recipient text
      const recipientEl = document.getElementById('clientMessageRecipient');
      const recipientText = recipientEl?.textContent || '';
      const nameMatch = recipientText.match(/to\s+(.+?)\s*\(/);
      const clientName = nameMatch ? nameMatch[1].split(' ')[0] : 'there';
      
      document.getElementById('clientMessageSubject').value = template.subject;
      document.getElementById('clientMessageText').value = template.message.replace(/{name}/g, clientName);
      
      // Focus on the message to allow editing
      document.getElementById('clientMessageText').focus();
    }

    function openBookingMessageModal(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;
      openClientMessageModal(bookingId, 'booking', booking.name, booking.email);
    }

    function openClientDirectMessageModal(clientId) {
      const client = clients.find(c => c.id === clientId);
      if (!client) return;
      openClientMessageModal(clientId, 'client', client.name, client.email);
    }

    async function sendClientMessage() {
      const id = document.getElementById('clientMessageId').value;
      const type = document.getElementById('clientMessageType').value;
      const subject = document.getElementById('clientMessageSubject').value;
      const message = document.getElementById('clientMessageText').value;
      const proposedDate = document.getElementById('proposedDate').value;
      const proposedTime = document.getElementById('proposedTime').value;
      const includeTestimonialLink = document.getElementById('includeTestimonialLink').checked;

      if (!subject || !message) {
        showToast('Please enter subject and message', 'error');
        return;
      }

      showLoading(true);
      
      let endpoint = type === 'booking' 
        ? `/api/admin/bookings/${id}/message`
        : `/api/admin/clients/${id}/message`;
      
      const result = await api(endpoint, {
        method: 'POST',
        body: JSON.stringify({ 
          subject, 
          message, 
          proposedDate, 
          proposedTime,
          includeTestimonialLink
        })
      });
      showLoading(false);

      if (result?.success) {
        showToast('Message sent successfully!', 'success');
        closeModal('clientMessageModal');
      } else {
        showToast(result?.error || 'Failed to send message', 'error');
      }
    }

    // ===========================================
    // PROPOSE TIME FUNCTIONS
    // ===========================================
    function openProposeTimeModal(bookingId) {
      const booking = bookings.find(b => b.id === bookingId);
      if (!booking) return;
      
      document.getElementById('proposeBookingId').value = bookingId;
      document.getElementById('proposeBookingInfo').innerHTML = `
        <strong>${booking.name}</strong><br>
        <span style="color: var(--soft-gray);">${booking.serviceName} â€¢ $${booking.servicePrice}</span><br>
        <span style="color: var(--soft-gray);">Their availability: ${booking.availability || 'Not specified'}</span>
        ${booking.rescheduleAvailability ? `<br><span style="color: var(--burgundy);">ðŸ“ Reschedule request: ${booking.rescheduleAvailability}</span>` : ''}
      `;
      
      // Set minimum date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('proposeDate').min = today;
      document.getElementById('proposeDate').value = booking.proposedDate || '';
      document.getElementById('proposeTime').value = booking.proposedTime || '';
      document.getElementById('proposeMessage').value = '';
      
      openModal('proposeTimeModal');
    }

    async function sendProposal() {
      const bookingId = document.getElementById('proposeBookingId').value;
      const proposedDate = document.getElementById('proposeDate').value;
      const proposedTime = document.getElementById('proposeTime').value;
      const message = document.getElementById('proposeMessage').value;

      if (!proposedDate || !proposedTime) {
        showToast('Please select both date and time', 'error');
        return;
      }

      showLoading(true);
      
      const result = await api(`/api/admin/bookings/${bookingId}/propose`, {
        method: 'POST',
        body: JSON.stringify({ proposedDate, proposedTime, message })
      });
      
      showLoading(false);

      if (result?.success) {
        showToast('âœ¨ Proposal sent to client!', 'success');
        closeModal('proposeTimeModal');
        loadBookings();
      } else {
        showToast(result?.error || 'Failed to send proposal', 'error');
      }
    }

    // ===========================================
    // AFTERCARE & UTILITIES
    // ===========================================
    async function sendAftercare(bookingId) {
      if (!confirm('Send aftercare email with testimonial link to this client?')) return;
      
      showLoading(true);
      const result = await api(`/api/admin/bookings/${bookingId}/aftercare`, { method: 'POST' });
      showLoading(false);

      if (result?.success) {
        showToast('Aftercare email sent!', 'success');
        loadBookings();
      } else {
        showToast(result?.error || 'Failed to send aftercare email', 'error');
      }
    }

    // ===========================================
    // UTILITIES
    // ===========================================
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('active', show);
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      
      setTimeout(() => toast.remove(), 4000);
    }

    // ===========================================
    // DARK MODE
    // ===========================================
    function toggleDarkMode() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('adminTheme', newTheme);
      
      // Update toggle button
      const icon = document.getElementById('themeIcon');
      const label = document.getElementById('themeLabel');
      if (icon) icon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
      if (label) label.textContent = newTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
    }

    // Initialize theme on load
    function initTheme() {
      const savedTheme = localStorage.getItem('adminTheme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      
      const icon = document.getElementById('themeIcon');
      const label = document.getElementById('themeLabel');
      if (icon) icon.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
      if (label) label.textContent = savedTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });

    // ===========================================
    // INIT
    // ===========================================
    initTheme();  // Initialize dark/light mode
    
    if (token) {
      showDashboard();
    }
  </script>

  <div style="position: fixed; bottom: 0; right: 0; padding: 8px 16px; font-size: 11px; color: #9E9890; background: rgba(253, 248, 243, 0.95); border-top-left-radius: 8px; box-shadow: 0 -2px 8px rgba(0,0,0,0.05); z-index: 9999;">
    <p style="margin: 0;">Built by <a href="mailto:Anth@StructuredForGrowth.com" style="color: #722F37; text-decoration: none;">Anth@StructuredForGrowth.com</a></p>
  </div>
</body>
</html>
